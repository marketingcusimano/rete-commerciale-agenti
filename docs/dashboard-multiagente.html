<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Rete Commerciale - Automazione CSV</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            line-height: 1.5;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e5e5;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .header .subtitle {
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e5e5;
        }

        .tab {
            flex: 1;
            padding: 12px 24px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:not(.active) {
            color: #666;
        }

        .tab.active {
            background: #1a1a1a;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filters {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e5e5;
        }

        .filters-row {
            display: flex;
            gap: 16px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 500;
            color: #666;
        }

        select {
            padding: 8px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            min-width: 160px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e5e5e5;
            transition: all 0.2s ease;
        }

        .metric-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trend-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .trend-positive {
            background: #dcfce7;
            color: #166534;
        }

        .trend-negative {
            background: #fef2f2;
            color: #dc2626;
        }

        .main-value {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .comparison {
            font-size: 14px;
            color: #666;
        }

        .progress-bar {
            background: #f5f5f5;
            border-radius: 6px;
            height: 6px;
            margin: 12px 0 8px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1a1a1a;
            transition: width 0.6s ease;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
        }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e5e5e5;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e5e5;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table-header {
            background: #f9f9f9;
            padding: 20px 24px;
            border-bottom: 1px solid #e5e5e5;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px 24px;
            text-align: left;
            border-bottom: 1px solid #f5f5f5;
        }

        th {
            font-weight: 600;
            color: #666;
            font-size: 13px;
            background: #fafafa;
        }

        td {
            font-size: 14px;
            color: #1a1a1a;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fef2f2;
            color: #dc2626;
        }

        .province-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            background: #f0f0f0;
            color: #666;
            margin-right: 4px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
            font-size: 14px;
            gap: 12px;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1a1a1a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .filters-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            
            th, td {
                padding: 12px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Dashboard Rete Commerciale</h1>
            <div class="subtitle">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M9 11H7v8h2v-8zm4-4h-2v12h2V7zm4-4h-2v16h2V3z"/>
                </svg>
                <span id="dataStatus">Caricamento automatico dal CSV...</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('agenti')">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
                Agenti
            </div>
            <div class="tab" onclick="switchTab('regioni')">
                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                </svg>
                Regioni
            </div>
        </div>

        <!-- TAB AGENTI -->
        <div id="agenti-tab" class="tab-content active">
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Agente</label>
                        <select id="agentSelect" onchange="filterAgenti()">
                            <option value="all">Tutti gli Agenti</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusSelect" onchange="filterAgenti()">
                            <option value="all">Tutti</option>
                            <option value="active">Attivi</option>
                            <option value="inactive">Inattivi</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Periodo</label>
                        <select id="periodSelect" onchange="filterAgenti()">
                            <option value="2025">Anno 2025</option>
                            <option value="2024">Anno 2024</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="agenti-loading" class="loading">
                <div class="loading-spinner"></div>
                <span>Caricamento dati agenti dal CSV...</span>
            </div>

            <div id="agenti-content" style="display: none;">
                <div class="cards-grid" id="agenti-metrics">
                    <!-- Metriche agenti generate dinamicamente -->
                </div>

                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4zm2.5 2.25l1.41-1.41L15.5 14.5 13 17l-3.5-3.5L4 19l1.41 1.41L9 16.83l3.5 3.5 3.09-3.09z"/>
                            </svg>
                            Performance Fatturato
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="fatturato-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Top Categorie
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="categorie-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                            </svg>
                            Dettaglio Agenti
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Codice</th>
                                    <th>Ragione Sociale</th>
                                    <th>Province</th>
                                    <th>Fatturato 2025</th>
                                    <th>Fatturato 2024</th>
                                    <th>Crescita</th>
                                    <th>Clienti</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="agenti-tbody">
                                <!-- Righe generate dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB REGIONI -->
        <div id="regioni-tab" class="tab-content">
            <div class="filters">
                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Regione</label>
                        <select id="regionSelect" onchange="filterRegioni()">
                            <option value="all">Tutte le Regioni</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Provincia</label>
                        <select id="provinciaSelect" onchange="filterRegioni()">
                            <option value="all">Tutte le Province</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Metrica</label>
                        <select id="metricSelect" onchange="filterRegioni()">
                            <option value="fatturato">Fatturato</option>
                            <option value="clienti">Clienti</option>
                            <option value="agenti">Agenti</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="regioni-loading" class="loading">
                <div class="loading-spinner"></div>
                <span>Elaborazione dati territoriali...</span>
            </div>

            <div id="regioni-content" style="display: none;">
                <div class="cards-grid" id="regioni-metrics">
                    <!-- Metriche regioni generate dinamicamente -->
                </div>

                <div class="charts-section">
                    <div class="chart-container">
                        <div class="chart-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        Distribuzione Territoriale
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="territorio-chart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L3.5 16.99z"/>
                        </svg>
                        Trend Performance
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                        Performance per Provincia
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Provincia</th>
                                <th>Regione</th>
                                <th>Agenti Attivi</th>
                                <th>Fatturato Totale</th>
                                <th>Clienti Serviti</th>
                                <th>Crescita %</th>
                                <th>Concentrazione</th>
                            </tr>
                        </thead>
                        <tbody id="regioni-tbody">
                            <!-- Righe generate dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL del CSV concatenato con tutti gli agenti
        const CSV_URL = 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/csv-concatenato-2025-09-05.csv';
        
        let allAgentsData = [];
        let allRawData = [];
        let filteredData = [];
        let charts = {};

        // Mappatura province-regioni (estesa)
        const provinceRegioni = {
            'FR': 'Lazio',
            'LT': 'Lazio', 
            'RM': 'Lazio',
            'VT': 'Lazio',
            'AN': 'Marche',
            'PU': 'Marche',
            'NU': 'Sardegna',
            'OT': 'Sardegna',
            'SS': 'Sardegna',
            'CA': 'Sardegna',
            'SU': 'Sardegna',
            'OR': 'Sardegna',
            'RN': 'Emilia-Romagna',
            'RA': 'Emilia-Romagna',
            'CR': 'Lombardia',
            'LO': 'Lombardia',
            'PC': 'Emilia-Romagna',
            'ALB': 'Albania'
        };

        // Funzioni di utilità
        function formatNumber(num) {
            if (typeof num !== 'number') return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return Math.round(num).toLocaleString('it-IT');
        }

        function formatCurrency(num) {
            if (typeof num !== 'number') return '€0';
            return '€' + formatNumber(num);
        }

        function calculateGrowth(current, previous) {
            if (!previous || previous === 0) return current > 0 ? 100 : 0;
            return ((current - previous) / previous * 100);
        }

        // Parsing CSV con la stessa logica del file originale
        function parseAgentsFromCSV(csvText) {
            const agents = [];
            const sections = csvText.split('# DATI STATISTICHE AGENTE');
            
            console.log(`Trovate ${sections.length - 1} sezioni agenti nel CSV`);
            
            for (let i = 1; i < sections.length; i++) {
                const section = sections[i];
                const lines = section.split('\n').filter(line => line.trim() !== '');
                
                const agent = {
                    codice: '',
                    ragioneSociale: '',
                    periodo: '',
                    obiettivi: [],
                    clientiProvincia: [],
                    venditeClienti: [],
                    categorieRiepilogo: [],
                    ripartizione: []
                };
                
                // Estrai metadata agente dai commenti
                for (const line of lines) {
                    if (line.includes('Codice Agente:')) {
                        agent.codice = line.split(':')[1]?.trim() || '';
                    } else if (line.includes('Ragione Sociale:')) {
                        agent.ragioneSociale = line.split(':')[1]?.trim() || '';
                    } else if (line.includes('Periodo:')) {
                        agent.periodo = line.split(':')[1]?.trim() || '';
                    }
                }
                
                // Parsa le righe dati con gestione robusta dei numeri
                let currentHeaders = null;
                
                for (const line of lines) {
                    try {
                        // Identifica headers delle sezioni
                        if (line.includes('Tipo_Dato')) {
                            currentHeaders = line.split(',').map(h => h.trim());
                            continue;
                        }
                        
                        // Parsa i dati se abbiamo headers
                        if (currentHeaders && line.startsWith('OBIETTIVI,')) {
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            if (values.length >= currentHeaders.length) {
                                const row = {};
                                currentHeaders.forEach((header, index) => {
                                    let value = values[index] || '';
                                    
                                    // Converti numeri con gestione formato italiano
                                    if (['Anno_Precedente', 'Anno_Corrente', 'Obiettivo', 
                                         'Clienti_Anno_Precedente', 'Clienti_Anno_Corrente', 'Obiettivo_Clienti'].includes(header)) {
                                        // Gestisce formati come "67.611,27" -> 67611.27
                                        if (value.includes('.') && value.includes(',')) {
                                            value = value.replace(/\./g, '').replace(',', '.');
                                        } else if (value.includes(',')) {
                                            value = value.replace(',', '.');
                                        }
                                        value = parseFloat(value) || 0;
                                    }
                                    
                                    row[header] = value;
                                });
                                agent.obiettivi.push(row);
                            }
                        } else if (line.startsWith('CLIENTI_PROVINCIA,')) {
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            if (values.length >= 4) {
                                let fatturato = values[3] || '0';
                                if (fatturato.includes('.') && fatturato.includes(',')) {
                                    fatturato = fatturato.replace(/\./g, '').replace(',', '.');
                                } else if (fatturato.includes(',')) {
                                    fatturato = fatturato.replace(',', '.');
                                }
                                
                                agent.clientiProvincia.push({
                                    provincia: values[1] || '',
                                    clientiServiti: parseInt(values[2]) || 0,
                                    fatturato: parseFloat(fatturato) || 0
                                });
                            }
                        } else if (line.startsWith('VENDITE_CLIENTE,')) {
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            if (values.length >= 5) {
                                let fatturato = values[4] || '0';
                                if (fatturato.includes('.') && fatturato.includes(',')) {
                                    fatturato = fatturato.replace(/\./g, '').replace(',', '.');
                                } else if (fatturato.includes(',')) {
                                    fatturato = fatturato.replace(',', '.');
                                }
                                
                                agent.venditeClienti.push({
                                    provincia: values[1] || '',
                                    cliente: values[2] || '',
                                    categoria: values[3] || '',
                                    fatturato: parseFloat(fatturato) || 0
                                });
                            }
                        } else if (line.startsWith('CATEGORIA_RIEPILOGO,')) {
                            const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                            if (values.length >= 7) {
                                let importo = values[2] || '0';
                                if (importo.includes('.') && importo.includes(',')) {
                                    importo = importo.replace(/\./g, '').replace(',', '.');
                                } else if (importo.includes(',')) {
                                    importo = importo.replace(',', '.');
                                }
                                
                                agent.categorieRiepilogo.push({
                                    categoria: values[1] || '',
                                    importoTotale: parseFloat(importo) || 0,
                                    provincia1: values[3] || '',
                                    clientiProv1: parseInt(values[4]) || 0,
                                    provincia2: values[5] || '',
                                    clientiProv2: parseInt(values[6]) || 0
                                });
                            }
                        }
                    } catch (parseError) {
                        console.warn('Errore parsing riga:', line, parseError);
                    }
                }
                
                // Aggiungi solo agenti con dati validi
                if (agent.codice && (agent.obiettivi.length > 0 || agent.clientiProvincia.length > 0)) {
                    agents.push(agent);
                    console.log(`Agente aggiunto: ${agent.codice} - ${agent.ragioneSociale}`);
                }
            }
            
            console.log(`Totale agenti parsati: ${agents.length}`);
            return agents;
        }

        // Caricamento e inizializzazione
        async function loadData() {
            try {
                document.getElementById('dataStatus').textContent = 'Connessione al CSV...';
                
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`Errore HTTP: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log(`CSV caricato: ${csvText.length} caratteri`);
                
                document.getElementById('dataStatus').textContent = 'Parsing dati agenti...';
                
                allAgentsData = parseAgentsFromCSV(csvText);
                
                if (allAgentsData.length === 0) {
                    throw new Error('Nessun agente trovato nel CSV');
                }
                
                document.getElementById('dataStatus').innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    ${allAgentsData.length} agenti caricati automaticamente
                `;
                
                // Inizializza filtri e dashboard
                initializeFilters();
                updateAgentiTab();
                updateRegioniTab();
                
            } catch (error) {
                console.error('Errore caricamento:', error);
                document.getElementById('dataStatus').innerHTML = `
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    Errore: ${error.message}
                `;
                
                // Nascondi loading e mostra messaggio di errore
                document.getElementById('agenti-loading').innerHTML = `
                    <div style="color: #dc2626; text-align: center;">
                        <svg class="icon" style="width: 24px; height: 24px; margin-bottom: 8px;" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        <div>Impossibile caricare i dati dal CSV</div>
                        <div style="font-size: 12px; margin-top: 8px; color: #666;">${error.message}</div>
                    </div>
                `;
            }
        }

        function initializeFilters() {
            // Popola select agenti
            const agentSelect = document.getElementById('agentSelect');
            agentSelect.innerHTML = '<option value="all">Tutti gli Agenti</option>';
            
            allAgentsData.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.codice;
                option.textContent = `${agent.codice} - ${agent.ragioneSociale}`;
                agentSelect.appendChild(option);
            });

            // Popola select regioni e province
            const regioni = new Set();
            const province = new Set();
            
            allAgentsData.forEach(agent => {
                agent.clientiProvincia.forEach(prov => {
                    if (prov.provincia && prov.provincia !== '') {
                        province.add(prov.provincia);
                        if (provinceRegioni[prov.provincia]) {
                            regioni.add(provinceRegioni[prov.provincia]);
                        }
                    }
                });
            });

            const regionSelect = document.getElementById('regionSelect');
            regionSelect.innerHTML = '<option value="all">Tutte le Regioni</option>';
            Array.from(regioni).sort().forEach(regione => {
                const option = document.createElement('option');
                option.value = regione;
                option.textContent = regione;
                regionSelect.appendChild(option);
            });

            const provinciaSelect = document.getElementById('provinciaSelect');
            provinciaSelect.innerHTML = '<option value="all">Tutte le Province</option>';
            Array.from(province).sort().forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                provinciaSelect.appendChild(option);
            });
        }

        function updateAgentiTab() {
            document.getElementById('agenti-loading').style.display = 'none';
            document.getElementById('agenti-content').style.display = 'block';
            
            // Calcola metriche generali
            let totaleFatturato2025 = 0;
            let totaleFatturato2024 = 0;
            let totaleClienti = 0;
            let agentiAttivi = 0;
            
            allAgentsData.forEach(agent => {
                const generale = agent.obiettivi.find(o => o.Provincia === 'Generale');
                if (generale) {
                    totaleFatturato2025 += generale.Anno_Corrente || 0;
                    totaleFatturato2024 += generale.Anno_Precedente || 0;
                    totaleClienti += generale.Clienti_Anno_Corrente || 0;
                    if ((generale.Anno_Corrente || 0) > 0) agentiAttivi++;
                }
            });

            const crescita = calculateGrowth(totaleFatturato2025, totaleFatturato2024);
            
            // Crea cards metriche
            const metricsContainer = document.getElementById('agenti-metrics');
            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                            </svg>
                            Fatturato Totale 2025
                        </div>
                        <div class="trend-badge ${crescita >= 0 ? 'trend-positive' : 'trend-negative'}">
                            ${crescita >= 0 ? '+' : ''}${crescita.toFixed(1)}%
                        </div>
                    </div>
                    <div class="main-value">${formatCurrency(totaleFatturato2025)}</div>
                    <div class="comparison">vs 2024: ${formatCurrency(totaleFatturato2024)}</div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                            </svg>
                            Agenti Attivi
                        </div>
                    </div>
                    <div class="main-value">${agentiAttivi}</div>
                    <div class="comparison">su ${allAgentsData.length} totali</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${(agentiAttivi/allAgentsData.length)*100}%"></div>
                    </div>
                    <div class="progress-details">
                        <span>Attività</span>
                        <span>${Math.round((agentiAttivi/allAgentsData.length)*100)}%</span>
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                            </svg>
                            Clienti Totali
                        </div>
                    </div>
                    <div class="main-value">${totaleClienti}</div>
                    <div class="comparison">Media: ${(totaleClienti/agentiAttivi || 0).toFixed(1)} per agente</div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Performance Media
                        </div>
                    </div>
                    <div class="main-value">${formatCurrency(totaleFatturato2025/agentiAttivi || 0)}</div>
                    <div class="comparison">fatturato medio per agente</div>
                </div>
            `;

            // Crea tabella agenti
            createAgentiTable();
            
            // Crea grafici
            createFatturatoChart();
            createCategorieChart();
        }

        function createAgentiTable() {
            const tbody = document.getElementById('agenti-tbody');
            tbody.innerHTML = '';
            
            const selectedAgent = document.getElementById('agentSelect').value;
            const selectedStatus = document.getElementById('statusSelect').value;
            
            let agentsToShow = allAgentsData;
            
            // Filtra per agente selezionato
            if (selectedAgent !== 'all') {
                agentsToShow = agentsToShow.filter(agent => agent.codice === selectedAgent);
            }
            
            agentsToShow.forEach(agent => {
                const generale = agent.obiettivi.find(o => o.Provincia === 'Generale');
                if (!generale) return;
                
                const fatturato2025 = generale.Anno_Corrente || 0;
                const fatturato2024 = generale.Anno_Precedente || 0;
                const crescita = calculateGrowth(fatturato2025, fatturato2024);
                const clienti = generale.Clienti_Anno_Corrente || 0;
                
                const province = agent.clientiProvincia.map(p => p.provincia).filter(p => p).join(', ');
                const isActive = fatturato2025 > 0;
                
                // Filtra per status se selezionato
                if (selectedStatus === 'active' && !isActive) return;
                if (selectedStatus === 'inactive' && isActive) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${agent.codice}</strong></td>
                    <td>${agent.ragioneSociale}</td>
                    <td>
                        ${province.split(', ').map(p => `<span class="province-tag">${p}</span>`).join('')}
                    </td>
                    <td><strong>${formatCurrency(fatturato2025)}</strong></td>
                    <td>${formatCurrency(fatturato2024)}</td>
                    <td>
                        <span class="trend-badge ${crescita >= 0 ? 'trend-positive' : 'trend-negative'}">
                            ${crescita >= 0 ? '+' : ''}${crescita.toFixed(1)}%
                        </span>
                    </td>
                    <td>${clienti}</td>
                    <td>
                        <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                            ${isActive ? 'Attivo' : 'Inattivo'}
                        </span>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function createFatturatoChart() {
            const ctx = document.getElementById('fatturato-chart').getContext('2d');
            
            if (charts.fatturato) charts.fatturato.destroy();
            
            const topAgenti = allAgentsData
                .map(agent => {
                    const generale = agent.obiettivi.find(o => o.Provincia === 'Generale');
                    return {
                        nome: agent.ragioneSociale.split(' ')[0],
                        fatturato2025: generale?.Anno_Corrente || 0,
                        fatturato2024: generale?.Anno_Precedente || 0
                    };
                })
                .filter(a => a.fatturato2025 > 0)
                .sort((a, b) => b.fatturato2025 - a.fatturato2025)
                .slice(0, 8);

            charts.fatturato = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topAgenti.map(a => a.nome),
                    datasets: [{
                        label: '2025',
                        data: topAgenti.map(a => a.fatturato2025),
                        backgroundColor: '#1a1a1a',
                        borderRadius: 4
                    }, {
                        label: '2024',
                        data: topAgenti.map(a => a.fatturato2024),
                        backgroundColor: '#999',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCategorieChart() {
            const ctx = document.getElementById('categorie-chart').getContext('2d');
            
            if (charts.categorie) charts.categorie.destroy();
            
            // Aggrega categorie di tutti gli agenti
            const categorieMap = new Map();
            
            allAgentsData.forEach(agent => {
                agent.categorieRiepilogo.forEach(cat => {
                    if (cat.importoTotale > 0) {
                        const current = categorieMap.get(cat.categoria) || 0;
                        categorieMap.set(cat.categoria, current + cat.importoTotale);
                    }
                });
            });

            const topCategorie = Array.from(categorieMap.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);

            const colors = ['#1a1a1a', '#333', '#555', '#777', '#999', '#bbb'];

            charts.categorie = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: topCategorie.map(c => c[0].replace(/_/g, ' ')),
                    datasets: [{
                        data: topCategorie.map(c => c[1]),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateRegioniTab() {
            document.getElementById('regioni-loading').style.display = 'none';
            document.getElementById('regioni-content').style.display = 'block';
            
            // Aggrega dati per regione
            const regioniData = new Map();
            
            allAgentsData.forEach(agent => {
                agent.clientiProvincia.forEach(prov => {
                    if (prov.provincia && provinceRegioni[prov.provincia]) {
                        const regione = provinceRegioni[prov.provincia];
                        
                        if (!regioniData.has(regione)) {
                            regioniData.set(regione, {
                                regione,
                                province: new Set(),
                                agenti: new Set(),
                                fatturato: 0,
                                clienti: 0
                            });
                        }
                        
                        const regionData = regioniData.get(regione);
                        regionData.province.add(prov.provincia);
                        regionData.agenti.add(agent.codice);
                        regionData.fatturato += prov.fatturato;
                        regionData.clienti += prov.clientiServiti;
                    }
                });
            });

            // Calcola metriche regioni
            const regioni = Array.from(regioniData.values());
            const totaleFatturatoRegioni = regioni.reduce((sum, r) => sum + r.fatturato, 0);
            const totaleClientiRegioni = regioni.reduce((sum, r) => sum + r.clienti, 0);
            
            const topRegione = regioni.sort((a, b) => b.fatturato - a.fatturato)[0];

            // Crea cards metriche regioni
            const metricsContainer = document.getElementById('regioni-metrics');
            metricsContainer.innerHTML = `
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                            </svg>
                            Regioni Attive
                        </div>
                    </div>
                    <div class="main-value">${regioni.length}</div>
                    <div class="comparison">su tutto il territorio</div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                            </svg>
                            Top Regione
                        </div>
                    </div>
                    <div class="main-value">${topRegione?.regione || 'N/A'}</div>
                    <div class="comparison">${formatCurrency(topRegione?.fatturato || 0)}</div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
                            </svg>
                            Fatturato Territoriale
                        </div>
                    </div>
                    <div class="main-value">${formatCurrency(totaleFatturatoRegioni)}</div>
                    <div class="comparison">${totaleClientiRegioni} clienti totali</div>
                </div>
                
                <div class="metric-card">
                    <div class="card-header">
                        <div class="card-title">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            Concentrazione
                        </div>
                    </div>
                    <div class="main-value">${Math.round((topRegione?.fatturato / totaleFatturatoRegioni * 100) || 0)}%</div>
                    <div class="comparison">del fatturato totale</div>
                </div>
            `;

            // Crea tabella regioni
            createRegioniTable(regioni);
            
            // Crea grafici territoriali
            createTerritorioChart(regioni);
            createTrendChart();
        }

        function createRegioniTable(regioni) {
            const tbody = document.getElementById('regioni-tbody');
            tbody.innerHTML = '';
            
            // Aggrega dati per provincia
            const provinceData = new Map();
            
            allAgentsData.forEach(agent => {
                agent.clientiProvincia.forEach(prov => {
                    if (prov.provincia && prov.provincia !== '') {
                        if (!provinceData.has(prov.provincia)) {
                            provinceData.set(prov.provincia, {
                                provincia: prov.provincia,
                                regione: provinceRegioni[prov.provincia] || 'N/A',
                                agenti: new Set(),
                                fatturato: 0,
                                clienti: 0,
                                fatturato2024: 0
                            });
                        }
                        
                        const provData = provinceData.get(prov.provincia);
                        provData.agenti.add(agent.codice);
                        provData.fatturato += prov.fatturato;
                        provData.clienti += prov.clientiServiti;
                        
                        // Calcola fatturato 2024 per la crescita
                        const generale = agent.obiettivi.find(o => o.Provincia === 'Generale');
                        if (generale) {
                            provData.fatturato2024 += (generale.Anno_Precedente || 0) * (prov.fatturato / (generale.Anno_Corrente || 1));
                        }
                    }
                });
            });

            const province = Array.from(provinceData.values())
                .sort((a, b) => b.fatturato - a.fatturato);

            const totaleFatturato = province.reduce((sum, p) => sum + p.fatturato, 0);

            province.forEach(prov => {
                const concentrazione = totaleFatturato > 0 ? (prov.fatturato / totaleFatturato * 100) : 0;
                const crescita = calculateGrowth(prov.fatturato, prov.fatturato2024);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${prov.provincia}</strong></td>
                    <td>${prov.regione}</td>
                    <td>${prov.agenti.size}</td>
                    <td><strong>${formatCurrency(prov.fatturato)}</strong></td>
                    <td>${prov.clienti}</td>
                    <td>
                        <span class="trend-badge ${crescita >= 0 ? 'trend-positive' : 'trend-negative'}">
                            ${crescita >= 0 ? '+' : ''}${crescita.toFixed(1)}%
                        </span>
                    </td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${concentrazione}%"></div>
                        </div>
                        <div style="text-align: center; font-size: 12px; margin-top: 4px;">${concentrazione.toFixed(1)}%</div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function createTerritorioChart(regioni) {
            const ctx = document.getElementById('territorio-chart').getContext('2d');
            
            if (charts.territorio) charts.territorio.destroy();
            
            const sortedRegioni = regioni.sort((a, b) => b.fatturato - a.fatturato);

            charts.territorio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedRegioni.map(r => r.regione),
                    datasets: [{
                        label: 'Fatturato',
                        data: sortedRegioni.map(r => r.fatturato),
                        backgroundColor: '#1a1a1a',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTrendChart() {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            if (charts.trend) charts.trend.destroy();
            
            // Calcola trend basato sui dati reali
            const mesi = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Jul', 'Ago'];
            const trend2025 = [];
            const trend2024 = [];
            
            // Simula andamento mensile proporzionale al fatturato totale
            let totaleFatturato2025 = 0;
            let totaleFatturato2024 = 0;
            
            allAgentsData.forEach(agent => {
                const generale = agent.obiettivi.find(o => o.Provincia === 'Generale');
                if (generale) {
                    totaleFatturato2025 += generale.Anno_Corrente || 0;
                    totaleFatturato2024 += generale.Anno_Precedente || 0;
                }
            });
            
            // Genera trend progressivo
            for (let i = 0; i < 8; i++) {
                const progressione = (i + 1) / 8;
                trend2025.push(totaleFatturato2025 * progressione);
                trend2024.push(totaleFatturato2024 * progressione);
            }

            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: mesi,
                    datasets: [{
                        label: '2025',
                        data: trend2025,
                        borderColor: '#1a1a1a',
                        backgroundColor: 'rgba(26, 26, 26, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '2024',
                        data: trend2024,
                        borderColor: '#999',
                        backgroundColor: 'rgba(153, 153, 153, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }

        function switchTab(tabName) {
            // Rimuovi classe active da tutti i tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            // Aggiungi classe active al tab cliccato
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'regioni') {
                updateRegioniTab();
            }
        }

        function filterAgenti() {
            createAgentiTable();
            createFatturatoChart();
        }

        function filterRegioni() {
            updateRegioniTab();
        }

        // Inizializzazione al caricamento della pagina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard caricata, avvio automazione CSV...');
            loadData();
        });
    </script>
</body>
</html>
