<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Direzionale - Cotto Cusimano</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            color: #1e293b;
            overflow-x: hidden;
        }

        /* Background Effects */
        .bg-effects {
            position: fixed;
            inset: 0;
            overflow: hidden;
            pointer-events: none;
            opacity: 0.2;
            z-index: 0;
        }

        .bg-circle {
            position: absolute;
            border-radius: 50%;
            mix-blend-mode: multiply;
            filter: blur(60px);
            animation: float 6s ease-in-out infinite;
        }

        .bg-circle-1 {
            top: -160px;
            right: -160px;
            width: 384px;
            height: 384px;
            background: #3b82f6;
            animation-delay: 0s;
        }

        .bg-circle-2 {
            bottom: -160px;
            left: -160px;
            width: 384px;
            height: 384px;
            background: #6366f1;
            animation-delay: 2s;
        }

        .bg-circle-3 {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 384px;
            height: 384px;
            background: #06b6d4;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.05); }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 900;
            color: #1e293b;
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .header .subtitle {
            color: #64748b;
            font-size: 1.125rem;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .status-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-size: 0.875rem;
            color: #166534;
            font-weight: 500;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .date-info {
            background: rgba(243, 244, 246, 0.7);
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .controls-group {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-tab:not(.active) {
            background: rgba(243, 244, 246, 0.7);
            color: #374151;
            border-color: #d1d5db;
        }

        .nav-tab:not(.active):hover {
            background: rgba(229, 231, 235, 0.8);
            border-color: #9ca3af;
        }

        /* Region Filter */
        .region-filter {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .region-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }

        .region-btn.active {
            background: #6366f1;
            color: white;
        }

        .region-btn:not(.active) {
            background: rgba(229, 231, 235, 0.8);
            color: #374151;
        }

        .region-btn:not(.active):hover {
            background: rgba(209, 213, 219, 0.9);
        }

        /* Modal per regioni */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.show .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .region-option {
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }

        .region-option:hover {
            background: #f8fafc;
            border-color: #e2e8f0;
        }

        .region-option.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .region-option-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .region-option-subtitle {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
        }

        .kpi-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .kpi-icon.revenue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #2563eb; }
        .kpi-icon.performance { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #059669; }
        .kpi-icon.clients { background: linear-gradient(135deg, #fae8ff, #f3e8ff); color: #9333ea; }
        .kpi-icon.agents { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #ea580c; }
        .kpi-icon.regions { background: linear-gradient(135deg, #cffafe, #a5f3fc); color: #0891b2; }

        .kpi-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .kpi-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-change.positive { color: #059669; }
        .kpi-change.negative { color: #dc2626; }

        .progress-bar {
            background: #f1f5f9;
            border-radius: 8px;
            height: 8px;
            margin-top: 12px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 8px;
            transition: width 1s ease;
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 24px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Tables */
        .table-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 32px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            margin-bottom: 32px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            color: #1e293b;
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            color: white;
        }

        .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
        .rank-2 { background: linear-gradient(135deg, #9ca3af, #6b7280); }
        .rank-3 { background: linear-gradient(135deg, #fb923c, #ea580c); }
        .rank-other { background: linear-gradient(135deg, #3b82f6, #2563eb); }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #64748b;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .header {
                padding: 24px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .region-filter {
                flex-direction: column;
            }

            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Utility classes */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .text-sm { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .mb-4 { margin-bottom: 16px; }
        .mt-4 { margin-top: 16px; }

        /* Legends */
        .legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .legend-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
        }

        .legend-value {
            font-weight: 600;
            color: #1e293b;
        }

        .legend-percentage {
            font-size: 0.75rem;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Background Effects -->
    <div class="bg-effects">
        <div class="bg-circle bg-circle-1"></div>
        <div class="bg-circle bg-circle-2"></div>
        <div class="bg-circle bg-circle-3"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Dashboard Direzionale</h1>
            <p class="subtitle">Cotto Cusimano - Controllo Rete Vendita</p>
            
            <div class="status-line">
                <div class="status-dot"></div>
                <span class="status-text">Aggiornamento automatico attivo</span>
            </div>

            <div class="header-controls">
                <div class="date-info">
                    <span>üìÖ</span>
                    <span id="dateRange">01 Gen - 05 Set 2025</span>
                </div>

                <div class="controls-group">
                    <button class="btn btn-primary" id="downloadBtn">
                        <span>üì•</span>
                        Esporta Dashboard
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <span>üîÑ</span>
                        Aggiorna
                    </button>
                    <div id="agentCount" class="date-info">
                        <span>üè¢</span>
                        <span>Caricamento...</span>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="nav-tabs">
                <div class="nav-tab active" data-tab="overview">
                    <span>üìä</span>
                    Panoramica Aziendale
                </div>
                <div class="nav-tab" data-tab="agents">
                    <span>üë•</span>
                    Dettaglio Agenti
                </div>
            </div>

            <!-- Region Filter -->
            <div class="region-filter">
                <button class="region-btn active" data-region="all">Tutte le Regioni</button>
                <button class="region-btn" id="regionModalBtn">
                    <span>üó∫Ô∏è</span>
                    Seleziona Regione
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div id="loadingSection" class="loading">
            <div class="loading-spinner"></div>
            <h3>Caricamento dati in corso...</h3>
            <p>Lettura del file CSV da GitHub</p>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent" class="hidden">
            <!-- Overview Tab -->
            <div id="overviewTab">
                <!-- KPI Cards -->
                <div class="kpi-grid" id="kpiGrid">
                    <!-- KPI cards will be generated here -->
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Performance per Regione</h3>
                        <div class="chart-container">
                            <canvas id="regionChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Distribuzione Fatturato</h3>
                        <div class="chart-container">
                            <canvas id="distributionChart"></canvas>
                        </div>
                        <div class="legend" id="distributionLegend">
                            <!-- Legend will be generated here -->
                        </div>
                    </div>
                </div>

                <!-- Regions Table -->
                <div class="table-card">
                    <h3 class="chart-title">Dettaglio per Regione</h3>
                    <div style="overflow-x: auto;">
                        <table class="table" id="regionsTable">
                            <!-- Table will be generated here -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- Agents Tab -->
            <div id="agentsTab" class="hidden">
                <div class="table-card">
                    <h3 class="chart-title">Ranking Agenti</h3>
                    <div style="overflow-x: auto;">
                        <table class="table" id="agentsTable">
                            <!-- Table will be generated here -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Region Modal -->
    <div class="modal-overlay" id="regionModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Seleziona Regione</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div id="regionOptions">
                <!-- Region options will be generated here -->
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 24px;">
                <button class="btn btn-secondary" id="modalCancel">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CSV_URL = 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/csv-concatenato-2025-09-05.csv';
        
        // Global variables
        let rawData = [];
        let processedData = {};
        let selectedRegion = 'all';
        let activeTab = 'overview';
        let charts = {};

        // Utility functions
        function formatCurrency(value) {
            if (value >= 1000000) return `‚Ç¨${(value / 1000000).toFixed(1)}M`;
            if (value >= 1000) return `‚Ç¨${(value / 1000).toFixed(0)}k`;
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('it-IT').format(num);
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const data = [];
            let headers = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line || line.startsWith('#')) continue;
                
                if (!headers) {
                    headers = line.split(',').map(h => h.trim().replace(/"/g, ''));
                    continue;
                }

                const values = [];
                let currentValue = '';
                let inQuotes = false;
                
                for (let j = 0; j < line.length; j++) {
                    const char = line[j];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentValue.trim().replace(/"/g, ''));
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim().replace(/"/g, ''));

                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        let value = values[index] || '';
                        
                        if (['FATTURATO_2024', 'FATTURATO_2025', 'OBIETTIVO_2025', 'PERFORMANCE', 'CLIENTI'].includes(header)) {
                            value = parseFloat(value) || 0;
                        }
                        
                        row[header] = value;
                    });
                    data.push(row);
                }
            }

            return data;
        }

        function processData(data) {
            const processed = {
                agents: [],
                regions: new Map(),
                totals: {
                    fatturato2025: 0,
                    fatturato2024: 0,
                    obiettivo: 0,
                    clienti: 0,
                    agenti: 0
                }
            };

            console.log('Processing data, sample record:', data[0]);
            
            // Trova i nomi delle colonne reali
            const sampleRow = data[0] || {};
            const actualHeaders = Object.keys(sampleRow);
            console.log('Actual headers in data:', actualHeaders);

            // Mapping flessibile per i nomi delle colonne
            const findColumn = (possibleNames) => {
                for (const name of possibleNames) {
                    const found = actualHeaders.find(h => 
                        h.toLowerCase().includes(name.toLowerCase()) ||
                        h.toLowerCase().replace(/_/g, '').includes(name.toLowerCase().replace(/_/g, ''))
                    );
                    if (found) return found;
                }
                return null;
            };

            const codiceCol = findColumn(['CODICE_AGENTE', 'CODICE', 'ID_AGENTE', 'AGENTE_ID']);
            const nomeCol = findColumn(['RAGIONE_SOCIALE', 'NOME', 'RAGIONE_SOCIALE_AGENTE', 'AGENTE']);
            const regioneCol = findColumn(['REGIONE', 'REGION']);
            const fatturato2025Col = findColumn(['FATTURATO_2025', 'FATTURATO2025', 'FATTURATO_CORRENTE', 'ANNO_CORRENTE']);
            const fatturato2024Col = findColumn(['FATTURATO_2024', 'FATTURATO2024', 'FATTURATO_PRECEDENTE', 'ANNO_PRECEDENTE']);
            const obiettivoCol = findColumn(['OBIETTIVO_2025', 'OBIETTIVO2025', 'OBIETTIVO']);
            const performanceCol = findColumn(['PERFORMANCE', 'PERC_OBIETTIVO', 'PERCENTUALE_OBIETTIVO']);
            const clientiCol = findColumn(['CLIENTI', 'NUM_CLIENTI', 'CLIENTI_ATTIVI']);

            console.log('Column mapping:', {
                codice: codiceCol,
                nome: nomeCol,
                regione: regioneCol,
                fatturato2025: fatturato2025Col,
                fatturato2024: fatturato2024Col,
                obiettivo: obiettivoCol,
                performance: performanceCol,
                clienti: clientiCol
            });

            // Process agents
            data.forEach((row, index) => {
                const agent = {
                    codice: row[codiceCol] || `AGT_${index + 1}`,
                    nome: row[nomeCol] || `Agente ${index + 1}`,
                    regione: row[regioneCol] || 'Non Specificata',
                    fatturato2025: parseFloat(row[fatturato2025Col]) || 0,
                    fatturato2024: parseFloat(row[fatturato2024Col]) || 0,
                    obiettivo: parseFloat(row[obiettivoCol]) || 0,
                    performance: parseFloat(row[performanceCol]) || 0,
                    clienti: parseInt(row[clientiCol]) || 0,
                    crescita: 0
                };

                // Calcola crescita se hai i dati
                if (agent.fatturato2024 > 0) {
                    agent.crescita = ((agent.fatturato2025 - agent.fatturato2024) / agent.fatturato2024 * 100);
                }

                // Calcola performance se non presente ma hai obiettivo
                if (agent.performance === 0 && agent.obiettivo > 0) {
                    agent.performance = Math.round((agent.fatturato2025 / agent.obiettivo) * 100);
                }

                processed.agents.push(agent);

                // Aggregate by region
                if (!processed.regions.has(agent.regione)) {
                    processed.regions.set(agent.regione, {
                        regione: agent.regione,
                        agenti: 0,
                        fatturato2025: 0,
                        fatturato2024: 0,
                        obiettivo: 0,
                        clienti: 0,
                        crescita: 0,
                        performance: 0
                    });
                }

                const regionData = processed.regions.get(agent.regione);
                regionData.agenti++;
                regionData.fatturato2025 += agent.fatturato2025;
                regionData.fatturato2024 += agent.fatturato2024;
                regionData.obiettivo += agent.obiettivo;
                regionData.clienti += agent.clienti;

                // Update totals
                processed.totals.fatturato2025 += agent.fatturato2025;
                processed.totals.fatturato2024 += agent.fatturato2024;
                processed.totals.obiettivo += agent.obiettivo;
                processed.totals.clienti += agent.clienti;
                processed.totals.agenti++;
            });

            // Calculate regional averages
            processed.regions.forEach(region => {
                if (region.fatturato2024 > 0) {
                    region.crescita = ((region.fatturato2025 - region.fatturato2024) / region.fatturato2024 * 100);
                }
                if (region.obiettivo > 0) {
                    region.performance = Math.round((region.fatturato2025 / region.obiettivo) * 100);
                }
            });

            // Calculate total performance
            if (processed.totals.fatturato2024 > 0) {
                processed.totals.crescita = ((processed.totals.fatturato2025 - processed.totals.fatturato2024) / processed.totals.fatturato2024 * 100);
            }
            if (processed.totals.obiettivo > 0) {
                processed.totals.performance = Math.round((processed.totals.fatturato2025 / processed.totals.obiettivo) * 100);
            }

            // Sort agents by performance
            processed.agents.sort((a, b) => b.performance - a.performance);
            processed.agents.forEach((agent, index) => {
                agent.rank = index + 1;
            });

            console.log('Processed totals:', processed.totals);
            console.log('Sample processed agent:', processed.agents[0]);

            return processed;
        }

        function createKPICards() {
            const totals = selectedRegion === 'all' ? processedData.totals : 
                         Array.from(processedData.regions.values()).find(r => r.regione === selectedRegion) || processedData.totals;

            const kpiGrid = document.getElementById('kpiGrid');
            kpiGrid.innerHTML = `
                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon revenue">üìà</div>
                        <div class="kpi-title">Fatturato 2025</div>
                    </div>
                    <div class="kpi-value">${formatCurrency(totals.fatturato2025)}</div>
                    <div class="kpi-change ${totals.crescita >= 0 ? 'positive' : 'negative'}">
                        <span>${totals.crescita >= 0 ? '‚Üó' : '‚Üò'}</span>
                        <span>+${totals.crescita.toFixed(1)}% vs 2024</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon performance">üéØ</div>
                        <div class="kpi-title">Performance</div>
                    </div>
                    <div class="kpi-value">${totals.performance}%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${totals.performance}%"></div>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon clients">üë•</div>
                        <div class="kpi-title">Clienti Attivi</div>
                    </div>
                    <div class="kpi-value">${formatNumber(totals.clienti)}</div>
                    <div class="kpi-change positive">
                        <span>üìä</span>
                        <span>Totale portafoglio</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon agents">üè¢</div>
                        <div class="kpi-title">Agenti</div>
                    </div>
                    <div class="kpi-value">${formatNumber(totals.agenti || processedData.totals.agenti)}</div>
                    <div class="kpi-change positive">
                        <span>üåê</span>
                        <span>Rete vendita</span>
                    </div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-header">
                        <div class="kpi-icon regions">üó∫Ô∏è</div>
                        <div class="kpi-title">Regioni</div>
                    </div>
                    <div class="kpi-value">${selectedRegion === 'all' ? processedData.regions.size : 1}</div>
                    <div class="kpi-change positive">
                        <span>üìç</span>
                        <span>Copertura territorio</span>
                    </div>
                </div>
            `;
        }

        function createRegionChart() {
            const ctx = document.getElementById('regionChart').getContext('2d');
            
            if (charts.region) {
                charts.region.destroy();
            }

            const regions = Array.from(processedData.regions.values());
            const filteredRegions = selectedRegion === 'all' ? regions : regions.filter(r => r.regione === selectedRegion);

            charts.region = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filteredRegions.map(r => r.regione),
                    datasets: [{
                        label: 'Performance %',
                        data: filteredRegions.map(r => r.performance),
                        backgroundColor: '#3b82f6',
                        borderColor: '#2563eb',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createDistributionChart() {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (charts.distribution) {
                charts.distribution.destroy();
            }

            const regions = Array.from(processedData.regions.values());
            const filteredRegions = selectedRegion === 'all' ? regions : regions.filter(r => r.regione === selectedRegion);
            
            const colors = ['#3b82f6', '#f59e0b', '#10b981', '#8b5cf6', '#f97316', '#06b6d4'];

            charts.distribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredRegions.map(r => r.regione),
                    datasets: [{
                        data: filteredRegions.map(r => r.fatturato2025),
                        backgroundColor: colors.slice(0, filteredRegions.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Create legend
            const legendContainer = document.getElementById('distributionLegend');
            const total = filteredRegions.reduce((sum, r) => sum + r.fatturato2025, 0);
            
            legendContainer.innerHTML = filteredRegions.map((region, index) => {
                const percentage = total > 0 ? (region.fatturato2025 / total * 100).toFixed(1) : 0;
                return `
                    <div class="legend-item" style="border-left-color: ${colors[index]}">
                        <div class="legend-content">
                            <div class="legend-color" style="background-color: ${colors[index]}"></div>
                            <div>
                                <div class="legend-label">${region.regione}</div>
                                <div class="text-xs text-gray-600">${region.agenti} agenti ‚Ä¢ ${region.clienti} clienti</div>
                            </div>
                        </div>
                        <div>
                            <div class="legend-value">${formatCurrency(region.fatturato2025)}</div>
                            <div class="legend-percentage">${percentage}%</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createRegionsTable() {
            const table = document.getElementById('regionsTable');
            const regions = Array.from(processedData.regions.values()).sort((a, b) => b.fatturato2025 - a.fatturato2025);
            const filteredRegions = selectedRegion === 'all' ? regions : regions.filter(r => r.regione === selectedRegion);

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Regione</th>
                        <th>Agenti</th>
                        <th>Fatturato 2025</th>
                        <th>vs 2024</th>
                        <th>Performance</th>
                        <th>Clienti</th>
                    </tr>
                </thead>
                <tbody>
                    ${filteredRegions.map((region, index) => `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="rank-badge ${index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other'}">
                                        ${index + 1}
                                    </div>
                                    <span class="font-bold">${region.regione}</span>
                                </div>
                            </td>
                            <td>
                                <span style="background: #dbeafe; color: #1d4ed8; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                                    ${region.agenti}
                                </span>
                            </td>
                            <td class="font-bold">${formatCurrency(region.fatturato2025)}</td>
                            <td class="font-bold" style="color: #059669;">+${region.crescita.toFixed(1)}%</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="font-bold">${region.performance}%</span>
                                    <div style="width: 64px; height: 8px; background: #e5e7eb; border-radius: 4px;">
                                        <div style="width: ${region.performance}%; height: 100%; background: #22c55e; border-radius: 4px;"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="font-bold">${region.clienti}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function createAgentsTable() {
            const table = document.getElementById('agentsTable');
            const agents = selectedRegion === 'all' ? processedData.agents : 
                          processedData.agents.filter(a => a.regione === selectedRegion);

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Ranking</th>
                        <th>Agente</th>
                        <th>Regione</th>
                        <th>Fatturato 2025</th>
                        <th>Performance</th>
                        <th>Crescita</th>
                        <th>Clienti</th>
                    </tr>
                </thead>
                <tbody>
                    ${agents.map((agent, index) => `
                        <tr>
                            <td>
                                <div class="rank-badge ${agent.rank === 1 ? 'rank-1' : agent.rank === 2 ? 'rank-2' : agent.rank === 3 ? 'rank-3' : 'rank-other'}">
                                    ${agent.rank}
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="font-bold">${agent.nome}</div>
                                    <div class="text-sm" style="color: #64748b;">${agent.codice}</div>
                                </div>
                            </td>
                            <td class="font-bold">${agent.regione}</td>
                            <td class="font-bold">${formatCurrency(agent.fatturato2025)}</td>
                            <td>
                                <span class="font-bold" style="color: ${agent.performance >= 80 ? '#059669' : agent.performance >= 70 ? '#d97706' : '#dc2626'}">
                                    ${agent.performance}%
                                </span>
                            </td>
                            <td class="font-bold" style="color: #059669;">+${agent.crescita.toFixed(1)}%</td>
                            <td class="font-bold">${agent.clienti}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function createRegionModal() {
            const regions = Array.from(processedData.regions.keys());
            const optionsContainer = document.getElementById('regionOptions');
            
            optionsContainer.innerHTML = `
                <div class="region-option ${selectedRegion === 'all' ? 'selected' : ''}" data-region="all">
                    <div class="region-option-title">Tutte le Regioni</div>
                    <div class="region-option-subtitle">Panoramica completa di tutti i territori</div>
                </div>
                ${regions.map(region => {
                    const regionData = processedData.regions.get(region);
                    return `
                        <div class="region-option ${selectedRegion === region ? 'selected' : ''}" data-region="${region}">
                            <div class="region-option-title">${region}</div>
                            <div class="region-option-subtitle">${regionData.agenti} agenti ‚Ä¢ ${formatCurrency(regionData.fatturato2025)} ‚Ä¢ ${regionData.clienti} clienti</div>
                        </div>
                    `;
                }).join('')}
            `;

            // Add event listeners
            document.querySelectorAll('.region-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.region-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    
                    const region = option.dataset.region;
                    selectedRegion = region;
                    
                    updateDashboard();
                    closeModal();
                });
            });
        }

        function updateDashboard() {
            if (activeTab === 'overview') {
                createKPICards();
                createRegionChart();
                createDistributionChart();
                createRegionsTable();
            } else {
                createAgentsTable();
            }

            // Update region filter buttons
            document.querySelectorAll('.region-btn').forEach(btn => {
                if (btn.dataset.region) {
                    btn.classList.toggle('active', btn.dataset.region === selectedRegion);
                }
            });
        }

        function showTab(tabName) {
            activeTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Show/hide tab content
            document.getElementById('overviewTab').classList.toggle('hidden', tabName !== 'overview');
            document.getElementById('agentsTab').classList.toggle('hidden', tabName !== 'agents');

            updateDashboard();
        }

        function showModal() {
            document.getElementById('regionModal').classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('regionModal').classList.remove('show');
            document.body.style.overflow = '';
        }

        // Load and initialize
        async function loadData() {
            try {
                console.log('Loading data from:', CSV_URL);
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('CSV loaded successfully');
                
                rawData = parseCSV(csvText);
                console.log('Parsed data:', rawData.length, 'records');
                
                processedData = processData(rawData);
                console.log('Processed data:', processedData);
                
                // Update UI
                document.getElementById('agentCount').innerHTML = `
                    <span>üè¢</span>
                    <span>${processedData.totals.agenti} Agenti Attivi</span>
                `;
                
                // Hide loading and show content
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                
                createRegionModal();
                updateDashboard();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingSection').innerHTML = `
                    <div style="color: #dc2626; text-align: center;">
                        <h3>‚ùå Errore nel caricamento dei dati</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()" style="margin-top: 16px;">
                            Riprova
                        </button>
                    </div>
                `;
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    showTab(tab.dataset.tab);
                });
            });

            // Region buttons
            document.querySelectorAll('.region-btn').forEach(btn => {
                if (btn.dataset.region) {
                    btn.addEventListener('click', () => {
                        selectedRegion = btn.dataset.region;
                        updateDashboard();
                    });
                }
            });

            // Modal events
            document.getElementById('regionModalBtn').addEventListener('click', showModal);
            document.getElementById('modalClose').addEventListener('click', closeModal);
            document.getElementById('modalCancel').addEventListener('click', closeModal);
            
            document.getElementById('regionModal').addEventListener('click', (e) => {
                if (e.target.id === 'regionModal') closeModal();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });

            // Download button
            document.getElementById('downloadBtn').addEventListener('click', () => {
                alert('Funzione di export in sviluppo');
            });
        });
    </script>
</body>
</html>
