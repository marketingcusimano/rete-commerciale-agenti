<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Commerciale</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #ffffff;
            color: #1a1a1a;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 2rem;
            background: #f8fafc;
            padding: 8px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .nav-tab {
            flex: 1;
            background: transparent;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }

        .nav-tab:hover:not(.active) {
            background: #e2e8f0;
            color: #475569;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            margin-bottom: 1rem;
        }

        .metric-icon.revenue { background: linear-gradient(135deg, #667eea, #764ba2); }
        .metric-icon.clients { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .metric-icon.target { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .metric-icon.growth { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 1rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        .metric-change {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .change-positive {
            color: #10b981;
        }

        .change-negative {
            color: #ef4444;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .agent-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .agent-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .agent-card.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .agent-info h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .agent-code {
            font-size: 0.9rem;
            color: #64748b;
            font-family: 'Monaco', monospace;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .agent-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .agent-metric {
            text-align: center;
        }

        .agent-metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }

        .agent-metric-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 4px;
        }

        .agent-provinces {
            display: flex;
            gap: 8px;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .province-tag {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 1.1rem;
            color: #64748b;
        }

        .loading i {
            margin-right: 12px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        .filter-select {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
            min-width: 200px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-tabs {
                flex-direction: column;
            }

            .cards-grid,
            .agents-grid {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Dashboard Commerciale</h1>
            <p>Analisi performance rete vendita - Dati aggiornati automaticamente</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="agenti">
                <i class="fas fa-users"></i>
                Agenti
            </button>
            <button class="nav-tab" data-tab="regioni">
                <i class="fas fa-map-marked-alt"></i>
                Regioni
            </button>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-spinner"></i>
            Caricamento dati in corso...
        </div>

        <div id="error" style="display: none;"></div>

        <div id="agenti-tab" class="tab-content active">
            <div class="cards-grid" id="summary-cards"></div>

            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Filtro per provincia</label>
                    <select id="province-filter" class="filter-select">
                        <option value="all">Tutte le province</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Stato agente</label>
                    <select id="status-filter" class="filter-select">
                        <option value="all">Tutti gli stati</option>
                        <option value="active">Solo attivi</option>
                        <option value="inactive">Solo inattivi</option>
                    </select>
                </div>
            </div>

            <div class="agents-grid" id="agents-grid"></div>
        </div>

        <div id="regioni-tab" class="tab-content">
            <h2>Sezione Regioni in sviluppo</h2>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/csv-concatenato-2025-09-05.csv';
        
        let allData = [];
        let currentData = [];

        // FUNZIONI CORRETTE PER IL PARSING
        function parseCSVValue(value) {
            if (!value || value === '' || value === '0' || value === '0,00') return 0;
            
            // Rimuovi virgolette
            let cleaned = value.toString().replace(/"/g, '');
            
            // Gestione formato italiano: punto = separatore migliaia, virgola = decimale
            // Esempio: "31.318,46" diventa 31318.46
            cleaned = cleaned.replace(/\./g, '').replace(',', '.');
            
            const parsed = parseFloat(cleaned);
            return isNaN(parsed) ? 0 : parsed;
        }

        function formatCurrency(value) {
            if (value === 0) return '€0';
            
            if (value >= 1000000) {
                return '€' + (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return '€' + Math.round(value / 1000) + 'k';
            }
            
            return '€' + Math.round(value).toLocaleString('it-IT');
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const agents = [];
            let currentAgent = null;
            let currentHeaders = null;
            
            for (let line of lines) {
                line = line.trim();
                
                if (!line) continue;
                
                if (line.startsWith('# DATI STATISTICHE AGENTE')) {
                    currentAgent = {
                        code: '',
                        name: '',
                        period: '',
                        objectives: [],
                        provinces: [],
                        sales: [],
                        categories: [],
                        breakdown: []
                    };
                    agents.push(currentAgent);
                    continue;
                }
                
                if (line.startsWith('#') && currentAgent) {
                    if (line.includes('Codice Agente:')) {
                        currentAgent.code = line.split(':')[1]?.trim() || '';
                    } else if (line.includes('Ragione Sociale:')) {
                        currentAgent.name = line.split(':')[1]?.trim() || '';
                    } else if (line.includes('Periodo:')) {
                        currentAgent.period = line.split(':')[1]?.trim() || '';
                    }
                    continue;
                }
                
                if (line.includes('Tipo_Dato')) {
                    currentHeaders = line.split(',').map(h => h.trim());
                    continue;
                }
                
                if (currentHeaders && currentAgent && line && !line.startsWith('#')) {
                    const values = line.split(',').map(v => v.trim());
                    if (values.length >= currentHeaders.length) {
                        const row = {};
                        currentHeaders.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        switch (row.Tipo_Dato) {
                            case 'OBIETTIVI':
                                currentAgent.objectives.push(row);
                                break;
                            case 'CLIENTI_PROVINCIA':
                                currentAgent.provinces.push(row);
                                break;
                            case 'VENDITE_CLIENTE':
                                currentAgent.sales.push(row);
                                break;
                            case 'CATEGORIA_RIEPILOGO':
                                currentAgent.categories.push(row);
                                break;
                            case 'RIPARTIZIONE':
                                currentAgent.breakdown.push(row);
                                break;
                        }
                    }
                }
            }
            
            return agents.filter(agent => agent.code && agent.name);
        }

        function calculateAgentMetrics(agent) {
            const general = agent.objectives.find(obj => obj.Provincia === 'Generale');
            if (!general) return null;

            const currentRevenue = parseCSVValue(general.Anno_Corrente);
            const previousRevenue = parseCSVValue(general.Anno_Precedente);
            const currentClients = parseInt(general.Clienti_Anno_Corrente) || 0;
            const previousClients = parseInt(general.Clienti_Anno_Precedente) || 0;
            const target = parseCSVValue(general.Obiettivo);

            const revenueChange = previousRevenue > 0 ? 
                ((currentRevenue - previousRevenue) / previousRevenue * 100) : 0;
            const clientsChange = previousClients > 0 ? 
                ((currentClients - previousClients) / previousClients * 100) : 0;

            const provinces = [...new Set(agent.provinces
                .map(p => p.Provincia)
                .filter(p => p && p !== ''))]
                .filter(p => p.length <= 3); // Solo sigle province

            const isActive = currentRevenue > 0 || currentClients > 0;

            return {
                code: agent.code,
                name: agent.name,
                period: agent.period,
                currentRevenue,
                previousRevenue,
                currentClients,
                previousClients,
                target,
                revenueChange,
                clientsChange,
                provinces,
                isActive,
                agent: agent
            };
        }

        function createSummaryCards(data) {
            console.log('Creating summary cards with data:', data);
            
            const totalRevenue = data.reduce((sum, agent) => {
                console.log(`Agent ${agent.name}: ${agent.currentRevenue}`);
                return sum + agent.currentRevenue;
            }, 0);
            
            const totalPreviousRevenue = data.reduce((sum, agent) => sum + agent.previousRevenue, 0);
            const totalClients = data.reduce((sum, agent) => sum + agent.currentClients, 0);
            const activeAgents = data.filter(agent => agent.isActive).length;
            
            const totalRevenueChange = totalPreviousRevenue > 0 ? 
                ((totalRevenue - totalPreviousRevenue) / totalPreviousRevenue * 100) : 0;

            console.log(`Total Revenue: ${totalRevenue}, Previous: ${totalPreviousRevenue}, Change: ${totalRevenueChange}%`);

            return `
                <div class="metric-card">
                    <div class="metric-icon revenue">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                    <div class="metric-value">${formatCurrency(totalRevenue)}</div>
                    <div class="metric-label">Fatturato totale 2025</div>
                    <div class="metric-change ${totalRevenueChange >= 0 ? 'change-positive' : 'change-negative'}">
                        <i class="fas fa-arrow-${totalRevenueChange >= 0 ? 'up' : 'down'}"></i>
                        ${totalRevenueChange >= 0 ? '+' : ''}${totalRevenueChange.toFixed(1)}% vs 2024
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon clients">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metric-value">${totalClients}</div>
                    <div class="metric-label">Clienti attivi totali</div>
                    <div class="metric-change">
                        <i class="fas fa-building"></i>
                        ${activeAgents} agenti attivi
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon target">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="metric-value">${data.length}</div>
                    <div class="metric-label">Agenti totali</div>
                    <div class="metric-change change-positive">
                        <i class="fas fa-check-circle"></i>
                        ${activeAgents} con fatturato
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-icon growth">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="metric-value">${formatCurrency(totalRevenue / Math.max(activeAgents, 1))}</div>
                    <div class="metric-label">Fatturato medio per agente</div>
                    <div class="metric-change">
                        <i class="fas fa-calculator"></i>
                        Media rete vendita
                    </div>
                </div>
            `;
        }

        function createAgentCard(agent) {
            return `
                <div class="agent-card" data-agent="${agent.code}">
                    <div class="agent-header">
                        <div class="agent-info">
                            <h3>${agent.name}</h3>
                            <div class="agent-code">${agent.code}</div>
                        </div>
                        <div class="status-badge ${agent.isActive ? 'status-active' : 'status-inactive'}">
                            ${agent.isActive ? 'Attivo' : 'Inattivo'}
                        </div>
                    </div>
                    
                    <div class="agent-metrics">
                        <div class="agent-metric">
                            <div class="agent-metric-value">${formatCurrency(agent.currentRevenue)}</div>
                            <div class="agent-metric-label">Fatturato 2025</div>
                        </div>
                        <div class="agent-metric">
                            <div class="agent-metric-value">${agent.currentClients}</div>
                            <div class="agent-metric-label">Clienti attivi</div>
                        </div>
                    </div>

                    <div class="metric-change ${agent.revenueChange >= 0 ? 'change-positive' : 'change-negative'}">
                        <i class="fas fa-arrow-${agent.revenueChange >= 0 ? 'up' : 'down'}"></i>
                        ${agent.revenueChange >= 0 ? '+' : ''}${agent.revenueChange.toFixed(1)}% vs 2024
                    </div>

                    <div class="agent-provinces">
                        ${agent.provinces.map(prov => `<span class="province-tag">${prov}</span>`).join('')}
                    </div>
                </div>
            `;
        }

        function filterAgents() {
            const provinceFilter = document.getElementById('province-filter').value;
            const statusFilter = document.getElementById('status-filter').value;

            let filtered = allData;

            if (provinceFilter !== 'all') {
                filtered = filtered.filter(agent => agent.provinces.includes(provinceFilter));
            }

            if (statusFilter !== 'all') {
                filtered = filtered.filter(agent => 
                    statusFilter === 'active' ? agent.isActive : !agent.isActive
                );
            }

            currentData = filtered;
            updateAgentsDisplay();
        }

        function updateAgentsDisplay() {
            document.getElementById('summary-cards').innerHTML = createSummaryCards(currentData);
            document.getElementById('agents-grid').innerHTML = 
                currentData.map(agent => createAgentCard(agent)).join('');
        }

        // Tab navigation
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            document.getElementById('province-filter').addEventListener('change', filterAgents);
            document.getElementById('status-filter').addEventListener('change', filterAgents);

            loadData();
        });

        async function loadData() {
            try {
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('error').style.display = 'none';

                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                console.log('CSV loaded, first 500 chars:', csvText.substring(0, 500));
                
                const agents = parseCSV(csvText);
                console.log('Parsed agents:', agents.length);
                
                allData = agents.map(calculateAgentMetrics).filter(agent => agent !== null);
                console.log('Calculated metrics for agents:', allData.length);
                console.log('Sample agent data:', allData[0]);
                
                currentData = [...allData];

                // Populate province filter
                const allProvinces = [...new Set(allData.flatMap(agent => agent.provinces))].sort();
                const provinceSelect = document.getElementById('province-filter');
                allProvinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province;
                    option.textContent = province;
                    provinceSelect.appendChild(option);
                });

                updateAgentsDisplay();
                document.getElementById('loading').style.display = 'none';

                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Dati caricati con successo: ${allData.length} agenti processati
                `;
                document.querySelector('.container').insertBefore(successAlert, document.querySelector('.nav-tabs'));
                
                setTimeout(() => {
                    successAlert.remove();
                }, 3000);

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                
                const errorDiv = document.getElementById('error');
                errorDiv.className = 'alert alert-error';
                errorDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    Errore nel caricamento dei dati: ${error.message}
                `;
                errorDiv.style.display = 'block';
            }
        }
    </script>
</body>
</html>
