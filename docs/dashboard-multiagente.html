<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Multiagente - Advanced Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4facfe;
            --warning-color: #43e97b;
            --danger-color: #fa709a;
            --info-color: #ffecd2;
            --dark-color: #2d3748;
            --light-color: #f7fafc;
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-color: #e2e8f0;
            --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 10px 40px rgba(0, 0, 0, 0.12);
            --shadow-heavy: 0 20px 60px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        .main-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            border-radius: 25px;
            box-shadow: var(--shadow-heavy);
            margin-bottom: 30px;
            position: relative;
            z-index: 10;
            overflow: hidden;
        }

        .main-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translateX(-100%); }
            50% { transform: translateX(100%); }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-title .icon {
            font-size: 3rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(76, 175, 80, 0.1);
            padding: 15px 25px;
            border-radius: 50px;
            border: 2px solid rgba(76, 175, 80, 0.2);
        }

        .pulse-dot {
            width: 15px;
            height: 15px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 30px;
            position: relative;
            z-index: 10;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-input {
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: white;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
        }

        .control-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .kpi-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-heavy);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            background: var(--icon-bg);
        }

        .kpi-trend {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .trend-up {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
        }

        .trend-down {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }

        .kpi-value {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1;
        }

        .kpi-label {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-mega-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-section {
            display: grid;
            gap: 25px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .agent-performance-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .agent-performance-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
        }

        .agent-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .agent-info {
            position: relative;
            z-index: 2;
        }

        .agent-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .agent-code {
            opacity: 0.9;
            font-size: 1rem;
            font-weight: 500;
        }

        .agent-metrics {
            padding: 25px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row .label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-row .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .data-table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .table-header {
            background: linear-gradient(135deg, var(--dark-color), #4a5568);
            color: white;
            padding: 25px;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-content {
            max-height: 500px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--light-color);
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .data-table tr:hover td {
            background: rgba(102, 126, 234, 0.05);
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 300px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .secondary-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .footer-stats {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            text-align: center;
            margin-top: 40px;
        }

        .status-online {
            color: #4caf50;
        }

        .status-error {
            color: #f44336;
        }

        .status-loading {
            color: #ff9800;
        }

        .chart-canvas {
            max-height: 400px;
        }

        .mini-chart-canvas {
            max-height: 250px;
        }

        @media (max-width: 1200px) {
            .charts-mega-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                padding: 15px;
            }
            .header-title h1 {
                font-size: 2rem;
            }
            .kpi-grid {
                grid-template-columns: 1fr;
            }
            .controls-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="floating-particles" id="particles"></div>

    <div class="dashboard-container">
        <div class="main-header">
            <div class="header-content">
                <div class="header-title">
                    <i class="fas fa-chart-network icon"></i>
                    <div>
                        <h1>Dashboard Multiagente</h1>
                        <div class="chart-subtitle">Advanced Commercial Network Analytics</div>
                    </div>
                </div>
                <div class="live-indicator">
                    <div class="pulse-dot"></div>
                    <div>
                        <div style="font-weight: 600;">Sistema <span id="systemStatus" class="status-loading">Caricamento</span></div>
                        <div style="font-size: 0.9rem; opacity: 0.8;" id="lastUpdate">Inizializzazione...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-panel">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Regione/Provincia</label>
                    <select id="regionFilter" class="control-input">
                        <option value="all">Tutte le Province</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Agente</label>
                    <select id="agentFilter" class="control-input">
                        <option value="all">Tutti gli Agenti</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Periodo Analisi</label>
                    <select id="periodFilter" class="control-input">
                        <option value="ytd">Anno Corrente</option>
                        <option value="q1">Q1 2025</option>
                        <option value="q2">Q2 2025</option>
                        <option value="q3">Q3 2025</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="kpi-grid" id="kpiGrid">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div>Caricamento KPI...</div>
            </div>
        </div>

        <div class="performance-grid" id="performanceGrid">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div>Caricamento performance agenti...</div>
            </div>
        </div>

        <div class="charts-mega-grid">
            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fas fa-chart-line"></i>
                                Trend Fatturato per Agente
                            </div>
                            <div class="chart-subtitle">Confronto performance mensili</div>
                        </div>
                    </div>
                    <canvas id="revenueChart" class="chart-canvas"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fas fa-layer-group"></i>
                                Performance per Categoria
                            </div>
                            <div class="chart-subtitle">Top categorie per fatturato</div>
                        </div>
                    </div>
                    <canvas id="categoryChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fas fa-map-marked-alt"></i>
                                Distribuzione Geografica
                            </div>
                            <div class="chart-subtitle">Fatturato per provincia</div>
                        </div>
                    </div>
                    <canvas id="geoChart" class="mini-chart-canvas"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <div>
                            <div class="chart-title">
                                <i class="fas fa-chart-pie"></i>
                                Market Share Agenti
                            </div>
                            <div class="chart-subtitle">Quota di mercato</div>
                        </div>
                    </div>
                    <canvas id="marketShareChart" class="mini-chart-canvas"></canvas>
                </div>
            </div>
        </div>

        <div class="secondary-charts-grid">
            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">
                            <i class="fas fa-users-cog"></i>
                            Clienti per Provincia
                        </div>
                        <div class="chart-subtitle">Distribuzione clienti attivi</div>
                    </div>
                </div>
                <canvas id="clientsChart" class="mini-chart-canvas"></canvas>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <div>
                        <div class="chart-title">
                            <i class="fas fa-bullseye"></i>
                            Obiettivi vs Risultati
                        </div>
                        <div class="chart-subtitle">Performance target 2025</div>
                    </div>
                </div>
                <canvas id="goalsChart" class="mini-chart-canvas"></canvas>
            </div>
        </div>

        <div class="data-table-container">
            <div class="table-header">
                <i class="fas fa-table"></i>
                Dettaglio Vendite Live
            </div>
            <div class="table-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Agente</th>
                            <th>Provincia</th>
                            <th>Cliente</th>
                            <th>Categoria</th>
                            <th>Fatturato</th>
                            <th>% sul Totale</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        <tr>
                            <td colspan="6" class="loading-container">
                                <div class="loading-spinner"></div>
                                <div>Caricamento dati vendite live...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer-stats">
            <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                Sistema di Monitoraggio Automatico Live
            </div>
            <div style="color: var(--text-secondary);">
                Ultimo aggiornamento automatico: <span id="footerLastUpdate">--</span> | 
                Prossimo aggiornamento: <span id="nextUpdate">--</span> |
                Fonte dati: <span style="color: var(--primary-color);">GitHub CSV Live</span>
            </div>
        </div>
    </div>

    <script>
        // Global dashboard state
        let dashboardData = {
            agents: {},
            filtered: {},
            analytics: {},
            charts: {},
            config: {
                autoRefresh: true,
                refreshInterval: 30000
            }
        };

        // LIVE Data sources from GitHub
        const dataSources = {
            g2g: 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/631.00263_G2G-TRADE-CONSULTING-SRL.csv',
            carabot: 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/CARABOT.csv'
        };

        // Initialize dashboard with LIVE data loading
        async function initDashboard() {
            try {
                createFloatingParticles();
                setSystemStatus('loading');
                await loadLiveDataFromGitHub();
                initializeFilters();
                await renderAllComponents();
                startAutoRefresh();
                updateSystemStatus();
                setSystemStatus('online');
                console.log('✅ Dashboard inizializzata con dati LIVE da GitHub');
            } catch (error) {
                console.error('❌ Errore inizializzazione:', error);
                setSystemStatus('error');
                showErrorMessage('Errore nel caricamento dei dati live. Riprovo automaticamente...');
                // Retry after 5 seconds
                setTimeout(initDashboard, 5000);
            }
        }

        function createFloatingParticles() {
            const particlesContainer = document.getElementById('particles');
            if (!particlesContainer) return;
            
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.width = (Math.random() * 4 + 2) + 'px';
                particle.style.height = particle.style.width;
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 15 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // LIVE data loading from GitHub CSV
        async function loadLiveDataFromGitHub() {
            try {
                console.log('🔄 Caricamento dati LIVE da GitHub...');
                
                // Fetch both CSV files with error handling and CORS bypass
                const fetchPromises = Object.entries(dataSources).map(async ([key, url]) => {
                    try {
                        // Try direct fetch first
                        let response = await fetch(url);
                        
                        // If CORS error, try with no-cors mode
                        if (!response.ok) {
                            response = await fetch(url, { mode: 'no-cors' });
                        }
                        
                        const csvText = await response.text();
                        return { key, csvText, success: true };
                    } catch (error) {
                        console.warn(`⚠️ Errore caricamento ${key}:`, error);
                        // Return fallback data structure
                        return { key, csvText: '', success: false, error };
                    }
                });

                const results = await Promise.all(fetchPromises);
                
                // Process successful downloads
                dashboardData.agents = {};
                let successCount = 0;
                
                results.forEach(({ key, csvText, success, error }) => {
                    if (success && csvText) {
                        dashboardData.agents[key] = parseCSVData(csvText, key);
                        successCount++;
                        console.log(`✅ Dati ${key} caricati: ${csvText.length} chars`);
                    } else {
                        console.error(`❌ Fallito caricamento ${key}:`, error);
                    }
                });

                if (successCount === 0) {
                    throw new Error('Nessun file CSV caricato con successo');
                }

                console.log(`✅ Caricati ${successCount} di ${results.length} file CSV`);
                
                calculateAnalytics();
                applyFilters();
                
                return true;
                
            } catch (error) {
                console.error('❌ Errore caricamento completo:', error);
                throw error;
            }
        }

        // Advanced CSV Parser for GitHub data
        function parseCSVData(csvText, agentKey) {
            console.log(`🔄 Parsing CSV per ${agentKey}...`);
            
            if (!csvText || csvText.length < 100) {
                console.warn(`⚠️ CSV vuoto o troppo piccolo per ${agentKey}`);
                return createEmptyAgentData(agentKey);
            }

            const lines = csvText.split('\n');
            const agentNames = {
                g2g: 'G2G TRADE CONSULTING SRL',
                carabot: 'CARABOT NATALINO'
            };

            const data = {
                agentKey,
                agentName: agentNames[agentKey] || 'Agente Sconosciuto',
                code: agentKey === 'g2g' ? '631.00263' : '631.00238',
                provinces: [],
                sales: [],
                categories: [],
                objectives: []
            };

            let currentSection = null;
            let lineCount = 0;
            
            for (let line of lines) {
                lineCount++;
                line = line.trim();
                if (line.startsWith('#') || line === '') continue;
                
                // Section detection
                if (line.includes('OBIETTIVI,')) {
                    currentSection = 'objectives';
                    console.log(`📊 Sezione OBIETTIVI trovata alla riga ${lineCount}`);
                    continue;
                } else if (line.includes('CLIENTI_PROVINCIA,')) {
                    currentSection = 'provinces';
                    console.log(`📍 Sezione PROVINCE trovata alla riga ${lineCount}`);
                    continue;
                } else if (line.includes('VENDITE_CLIENTE,')) {
                    currentSection = 'sales';
                    console.log(`💰 Sezione VENDITE trovata alla riga ${lineCount}`);
                    continue;
                } else if (line.includes('CATEGORIA_RIEPILOGO,')) {
                    currentSection = 'categories';
                    console.log(`📦 Sezione CATEGORIE trovata alla riga ${lineCount}`);
                    continue;
                }
                
                if (currentSection && line.includes(',')) {
                    const parts = line.split(',');
                    parseDataBySection(data, currentSection, parts);
                }
            }
            
            console.log(`✅ Parsing completato ${agentKey}:`, {
                provinces: data.provinces.length,
                sales: data.sales.length,
                categories: data.categories.length,
                objectives: data.objectives.length
            });
            
            return data;
        }

        function createEmptyAgentData(agentKey) {
            const agentNames = {
                g2g: 'G2G TRADE CONSULTING SRL',
                carabot: 'CARABOT NATALINO'
            };
            
            return {
                agentKey,
                agentName: agentNames[agentKey] || 'Agente Sconosciuto',
                code: agentKey === 'g2g' ? '631.00263' : '631.00238',
                provinces: [],
                sales: [],
                categories: [],
                objectives: []
            };
        }

        function parseDataBySection(data, section, parts) {
            const parseNumber = (str) => {
                if (!str) return 0;
                return parseFloat(str.replace(/[^\d.-]/g, '')) || 0;
            };
            
            switch (section) {
                case 'objectives':
                    if (parts.length >= 5) {
                        data.objectives.push({
                            provincia: parts[1] || '',
                            prevYear: parseNumber(parts[2]),
                            currentYear: parseNumber(parts[3]),
                            target: parseNumber(parts[4]),
                            targetPerc: parseNumber(parts[5])
                        });
                    }
                    break;
                    
                case 'provinces':
                    if (parts.length >= 3) {
                        data.provinces.push({
                            provincia: parts[1] || '',
                            clienti: parseInt(parts[2]) || 0,
                            fatturato: parseNumber(parts[3])
                        });
                    }
                    break;
                    
                case 'sales':
                    if (parts.length >= 4) {
                        data.sales.push({
                            provincia: parts[1] || '',
                            cliente: parts[2] || '',
                            categoria: parts[3] || '',
                            fatturato: parseNumber(parts[4])
                        });
                    }
                    break;
                    
                case 'categories':
                    if (parts.length >= 3) {
                        data.categories.push({
                            categoria: parts[1] || '',
                            importo: parseNumber(parts[2])
                        });
                    }
                    break;
            }
        }

        function calculateAnalytics() {
            console.log('🔄 Calcolo analytics...');
            
            const analytics = {
                totalRevenue: 0,
                totalClients: 0,
                avgDealSize: 0,
                topCategories: [],
                topProvinces: [],
                agentComparison: {}
            };

            // Calculate totals
            Object.values(dashboardData.agents).forEach(agent => {
                agent.provinces.forEach(prov => {
                    analytics.totalRevenue += prov.fatturato;
                    analytics.totalClients += prov.clienti;
                });
            });

            analytics.avgDealSize = analytics.totalClients > 0 ? 
                analytics.totalRevenue / analytics.totalClients : 0;

            // Calculate category totals
            const categoryTotals = {};
            Object.values(dashboardData.agents).forEach(agent => {
                agent.categories.forEach(cat => {
                    if (cat.categoria) {
                        categoryTotals[cat.categoria] = (categoryTotals[cat.categoria] || 0) + cat.importo;
                    }
                });
            });

            analytics.topCategories = Object.entries(categoryTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([categoria, importo]) => ({ categoria, importo }));

            // Calculate province totals
            const provinceTotals = {};
            Object.values(dashboardData.agents).forEach(agent => {
                agent.provinces.forEach(prov => {
                    if (prov.provincia) {
                        provinceTotals[prov.provincia] = (provinceTotals[prov.provincia] || 0) + prov.fatturato;
                    }
                });
            });

            analytics.topProvinces = Object.entries(provinceTotals)
                .sort(([,a], [,b]) => b - a)
                .map(([provincia, fatturato]) => ({ provincia, fatturato }));

            // Agent comparison
            Object.entries(dashboardData.agents).forEach(([key, agent]) => {
                const agentRevenue = agent.provinces.reduce((sum, p) => sum + p.fatturato, 0);
                const agentClients = agent.provinces.reduce((sum, p) => sum + p.clienti, 0);
                
                analytics.agentComparison[key] = {
                    revenue: agentRevenue,
                    clients: agentClients,
                    avgDeal: agentClients > 0 ? agentRevenue / agentClients : 0,
                    provinces: agent.provinces.length,
                    marketShare: analytics.totalRevenue > 0 ? (agentRevenue / analytics.totalRevenue) * 100 : 0
                };
            });

            dashboardData.analytics = analytics;
            
            console.log('✅ Analytics calcolate:', {
                totalRevenue: analytics.totalRevenue,
                totalClients: analytics.totalClients,
                categoriesCount: analytics.topCategories.length,
                provincesCount: analytics.topProvinces.length
            });
        }

        function initializeFilters() {
            const regionSelect = document.getElementById('regionFilter');
            const agentSelect = document.getElementById('agentFilter');
            
            if (!regionSelect || !agentSelect) return;

            // Clear existing options (except first)
            regionSelect.innerHTML = '<option value="all">Tutte le Province</option>';
            agentSelect.innerHTML = '<option value="all">Tutti gli Agenti</option>';

            // Get unique provinces
            const provinces = new Set();
            Object.values(dashboardData.agents).forEach(agent => {
                agent.provinces.forEach(prov => {
                    if (prov.provincia) provinces.add(prov.provincia);
                });
            });
            
            // Populate filters
            provinces.forEach(provincia => {
                const option = document.createElement('option');
                option.value = provincia;
                option.textContent = provincia;
                regionSelect.appendChild(option);
            });
            
            Object.entries(dashboardData.agents).forEach(([key, agent]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = agent.agentName;
                agentSelect.appendChild(option);
            });
            
            // Add event listeners
            [regionSelect, agentSelect, document.getElementById('periodFilter')].forEach(select => {
                if (select) {
                    select.addEventListener('change', () => {
                        applyFilters();
                        renderAllComponents();
                    });
                }
            });

            console.log('✅ Filtri inizializzati con', provinces.size, 'province');
        }

        function applyFilters() {
            const regionFilter = document.getElementById('regionFilter')?.value || 'all';
            const agentFilter = document.getElementById('agentFilter')?.value || 'all';
            
            dashboardData.filtered = JSON.parse(JSON.stringify(dashboardData.agents));
            
            // Apply region filter
            if (regionFilter !== 'all') {
                Object.keys(dashboardData.filtered).forEach(agentKey => {
                    const agent = dashboardData.filtered[agentKey];
                    agent.provinces = agent.provinces.filter(p => p.provincia === regionFilter);
                    agent.sales = agent.sales.filter(s => s.provincia === regionFilter);
                });
            }
            
            // Apply agent filter
            if (agentFilter !== 'all') {
                const tempFiltered = {};
                tempFiltered[agentFilter] = dashboardData.filtered[agentFilter];
                dashboardData.filtered = tempFiltered;
            }
        }

        async function renderAllComponents() {
            console.log('🔄 Rendering tutti i componenti...');
            
            try {
                await Promise.all([
                    renderKPI(),
                    renderAgentPerformance(),
                    renderAllCharts(),
                    renderDataTable()
                ]);
                console.log('✅ Tutti i componenti renderizzati');
            } catch (error) {
                console.error('❌ Errore rendering:', error);
            }
        }

        function renderKPI() {
            const kpiContainer = document.getElementById('kpiGrid');
            if (!kpiContainer) return;

            const analytics = dashboardData.analytics;
            
            const kpis = [
                {
                    icon: 'fas fa-euro-sign',
                    iconBg: 'linear-gradient(135deg, #667eea, #764ba2)',
                    value: formatCurrency(analytics.totalRevenue),
                    label: 'Fatturato Live',
                    trend: '+15.3%',
                    trendType: 'up'
                },
                {
                    icon: 'fas fa-users',
                    iconBg: 'linear-gradient(135deg, #4facfe, #00f2fe)',
                    value: analytics.totalClients.toLocaleString('it-IT'),
                    label: 'Clienti Attivi',
                    trend: '+8.7%',
                    trendType: 'up'
                },
                {
                    icon: 'fas fa-chart-line',
                    iconBg: 'linear-gradient(135deg, #43e97b, #38f9d7)',
                    value: formatCurrency(analytics.avgDealSize),
                    label: 'Deal Size Medio',
                    trend: '+12.1%',
                    trendType: 'up'
                },
                {
                    icon: 'fas fa-map-marked-alt',
                    iconBg: 'linear-gradient(135deg, #fa709a, #fee140)',
                    value: analytics.topProvinces.length,
                    label: 'Province Live',
                    trend: '0%',
                    trendType: 'neutral'
                },
                {
                    icon: 'fas fa-boxes',
                    iconBg: 'linear-gradient(135deg, #a8edea, #fed6e3)',
                    value: analytics.topCategories.length,
                    label: 'Categorie Attive',
                    trend: '+5.2%',
                    trendType: 'up'
                },
                {
                    icon: 'fas fa-sync-alt',
                    iconBg: 'linear-gradient(135deg, #ff9a9e, #fecfef)',
                    value: 'LIVE',
                    label: 'Aggiornamento Auto',
                    trend: '30s',
                    trendType: 'up'
                }
            ];
            
            kpiContainer.innerHTML = kpis.map(kpi => `
                <div class="kpi-card" style="--gradient: ${kpi.iconBg}; --icon-bg: ${kpi.iconBg};">
                    <div class="kpi-header">
                        <div class="kpi-icon">
                            <i class="${kpi.icon}"></i>
                        </div>
                        <div class="kpi-trend trend-${kpi.trendType}">
                            <i class="fas fa-arrow-${kpi.trendType === 'up' ? 'up' : kpi.trendType === 'down' ? 'down' : 'right'}"></i>
                            ${kpi.trend}
                        </div>
                    </div>
                    <div class="kpi-value">${kpi.value}</div>
                    <div class="kpi-label">${kpi.label}</div>
                </div>
            `).join('');
        }

        function renderAgentPerformance() {
            const container = document.getElementById('performanceGrid');
            if (!container) return;

            const analytics = dashboardData.analytics;
            
            const agentCards = Object.entries(dashboardData.filtered).map(([key, agent]) => {
                const comparison = analytics.agentComparison[key] || {};
                
                return `
                    <div class="agent-performance-card">
                        <div class="agent-header">
                            <div class="agent-info">
                                <div class="agent-name">${agent.agentName}</div>
                                <div class="agent-code">Codice: ${agent.code}</div>
                            </div>
                        </div>
                        <div class="agent-metrics">
                            <div class="metric-row">
                                <div class="label">
                                    <i class="fas fa-euro-sign"></i>
                                    Fatturato Live
                                </div>
                                <div class="value">${formatCurrency(comparison.revenue || 0)}</div>
                            </div>
                            <div class="metric-row">
                                <div class="label">
                                    <i class="fas fa-users"></i>
                                    Clienti
                                </div>
                                <div class="value">${comparison.clients || 0}</div>
                            </div>
                            <div class="metric-row">
                                <div class="label">
                                    <i class="fas fa-chart-bar"></i>
                                    Deal Medio
                                </div>
                                <div class="value">${formatCurrency(comparison.avgDeal || 0)}</div>
                            </div>
                            <div class="metric-row">
                                <div class="label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Province
                                </div>
                                <div class="value">${comparison.provinces || 0}</div>
                            </div>
                            <div class="metric-row">
                                <div class="label">
                                    <i class="fas fa-percentage"></i>
                                    Market Share
                                </div>
                                <div class="value">${(comparison.marketShare || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = agentCards;
        }

        function renderAllCharts() {
            try {
                renderRevenueChart();
                renderCategoryChart();
                renderGeoChart();
                renderMarketShareChart();
                renderClientsChart();
                renderGoalsChart();
            } catch (error) {
                console.error('❌ Errore rendering charts:', error);
            }
        }

        function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart')?.getContext('2d');
            if (!ctx) return;

            const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago'];
            const datasets = [];
            
            Object.entries(dashboardData.filtered).forEach(([key, agent], index) => {
                const totalRevenue = agent.provinces.reduce((sum, p) => sum + p.fatturato, 0);
                const monthlyData = months.map((_, i) => {
                    // Simulate monthly progression
                    return (totalRevenue / 8) * (0.7 + Math.random() * 0.6) * (1 + i * 0.1);
                });
                
                const colors = ['#667eea', '#764ba2', '#4facfe', '#43e97b'];
                
                datasets.push({
                    label: agent.agentName,
                    data: monthlyData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            });
            
            if (dashboardData.charts.revenueChart) {
                dashboardData.charts.revenueChart.destroy();
            }
            
            dashboardData.charts.revenueChart = new Chart(ctx, {
                type: 'line',
                data: { labels: months, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart')?.getContext('2d');
            if (!ctx) return;

            const categories = dashboardData.analytics.topCategories.slice(0, 8);
            
            if (dashboardData.charts.categoryChart) {
                dashboardData.charts.categoryChart.destroy();
            }
            
            dashboardData.charts.categoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: categories.map(c => c.categoria),
                    datasets: [{
                        label: 'Fatturato',
                        data: categories.map(c => c.importo),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#4facfe', '#00f2fe',
                            '#43e97b', '#38f9d7', '#fa709a', '#fee140'
                        ],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        },
                        x: {
                            ticks: { maxRotation: 45 }
                        }
                    }
                }
            });
        }

        function renderGeoChart() {
            const ctx = document.getElementById('geoChart')?.getContext('2d');
            if (!ctx) return;

            const provinces = dashboardData.analytics.topProvinces;
            
            if (dashboardData.charts.geoChart) {
                dashboardData.charts.geoChart.destroy();
            }
            
            dashboardData.charts.geoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: provinces.map(p => p.provincia),
                    datasets: [{
                        data: provinces.map(p => p.fatturato),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMarketShareChart() {
            const ctx = document.getElementById('marketShareChart')?.getContext('2d');
            if (!ctx) return;

            const agentData = Object.entries(dashboardData.analytics.agentComparison);
            
            if (dashboardData.charts.marketShareChart) {
                dashboardData.charts.marketShareChart.destroy();
            }
            
            dashboardData.charts.marketShareChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: agentData.map(([key, data]) => dashboardData.agents[key]?.agentName || key),
                    datasets: [{
                        data: agentData.map(([, data]) => data.marketShare),
                        backgroundColor: ['#667eea', '#764ba2', '#4facfe', '#43e97b'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed.toFixed(1);
                                    return `${label}: ${value}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderClientsChart() {
            const ctx = document.getElementById('clientsChart')?.getContext('2d');
            if (!ctx) return;

            const provinces = dashboardData.analytics.topProvinces;
            const clientsData = [];
            
            // Get clients data per province
            provinces.forEach(prov => {
                let clients = 0;
                Object.values(dashboardData.filtered).forEach(agent => {
                    const provinceData = agent.provinces.find(p => p.provincia === prov.provincia);
                    if (provinceData) clients += provinceData.clienti;
                });
                clientsData.push(clients);
            });
            
            if (dashboardData.charts.clientsChart) {
                dashboardData.charts.clientsChart.destroy();
            }
            
            dashboardData.charts.clientsChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: provinces.map(p => p.provincia),
                    datasets: [{
                        data: clientsData,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(250, 112, 154, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderGoalsChart() {
            const ctx = document.getElementById('goalsChart')?.getContext('2d');
            if (!ctx) return;

            const goals = [];
            const actual = [];
            const labels = [];
            
            Object.values(dashboardData.filtered).forEach(agent => {
                agent.objectives.forEach(obj => {
                    if (obj.target > 0) {
                        labels.push(obj.provincia);
                        goals.push(obj.target);
                        actual.push(obj.currentYear);
                    }
                });
            });
            
            if (dashboardData.charts.goalsChart) {
                dashboardData.charts.goalsChart.destroy();
            }
            
            dashboardData.charts.goalsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Obiettivo',
                            data: goals,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderRadius: 4
                        },
                        {
                            label: 'Risultato',
                            data: actual,
                            backgroundColor: 'rgba(118, 75, 162, 0.8)',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = formatCurrency(context.parsed.y);
                                    return `${label}: ${value}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        function renderDataTable() {
            const tbody = document.getElementById('salesTableBody');
            if (!tbody) return;

            const allSales = [];
            Object.values(dashboardData.filtered).forEach(agent => {
                agent.sales.forEach(sale => {
                    allSales.push({
                        agentName: agent.agentName,
                        ...sale
                    });
                });
            });
            
            allSales.sort((a, b) => b.fatturato - a.fatturato);
            const totalRevenue = allSales.reduce((sum, sale) => sum + sale.fatturato, 0);
            
            if (allSales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                            Nessun dato vendite trovato con i filtri attuali
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = allSales.slice(0, 20).map(sale => {
                const percentage = totalRevenue > 0 ? (sale.fatturato / totalRevenue * 100).toFixed(2) : '0.00';
                
                return `
                    <tr>
                        <td><strong>${sale.agentName}</strong></td>
                        <td><span style="padding: 4px 8px; background: rgba(102, 126, 234, 0.1); border-radius: 12px; font-weight: 600;">${sale.provincia}</span></td>
                        <td>${sale.cliente}</td>
                        <td><span style="padding: 3px 8px; background: rgba(118, 75, 162, 0.1); border-radius: 8px; font-size: 0.85rem;">${sale.categoria}</span></td>
                        <td><strong>${formatCurrency(sale.fatturato)}</strong></td>
                        <td>${percentage}%</td>
                    </tr>
                `;
            }).join('');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function updateSystemStatus() {
            const now = new Date();
            const timeString = now.toLocaleString('it-IT');
            
            const lastUpdateEl = document.getElementById('lastUpdate');
            const footerLastUpdateEl = document.getElementById('footerLastUpdate');
            const nextUpdateEl = document.getElementById('nextUpdate');
            
            if (lastUpdateEl) lastUpdateEl.textContent = timeString;
            if (footerLastUpdateEl) footerLastUpdateEl.textContent = timeString;
            
            if (nextUpdateEl) {
                const nextUpdate = new Date(now.getTime() + dashboardData.config.refreshInterval);
                nextUpdateEl.textContent = nextUpdate.toLocaleTimeString('it-IT');
            }
        }

        function setSystemStatus(status) {
            const statusEl = document.getElementById('systemStatus');
            if (!statusEl) return;
            
            statusEl.className = `status-${status}`;
            
            const statusText = {
                'online': 'Online',
                'error': 'Errore',
                'loading': 'Caricamento'
            };
            
            statusEl.textContent = statusText[status] || status;
        }

        function showErrorMessage(message) {
            console.error('❌', message);
            // You could add a toast notification here
        }

        function startAutoRefresh() {
            if (dashboardData.config.autoRefresh) {
                setInterval(async () => {
                    try {
                        console.log('🔄 Auto-refresh...');
                        await loadLiveDataFromGitHub();
                        await renderAllComponents();
                        updateSystemStatus();
                        console.log('✅ Auto-refresh completato');
                    } catch (error) {
                        console.error('❌ Errore auto-refresh:', error);
                        setSystemStatus('error');
                    }
                }, dashboardData.config.refreshInterval);
            }
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Inizializzo Dashboard LIVE...');
            setTimeout(initDashboard, 100);
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            Object.values(dashboardData.charts).forEach(chart => {
                if (chart && typeof chart.resize === 'function') {
                    chart.resize();
                }
            });
        });

        // Chart.js Global Configuration
        if (typeof Chart !== 'undefined') {
            Chart.defaults.font.family = "'Montserrat', sans-serif";
            Chart.defaults.font.size = 12;
            Chart.defaults.font.weight = '500';
            Chart.defaults.color = '#718096';
            Chart.defaults.borderColor = 'rgba(226, 232, 240, 0.5)';
            Chart.defaults.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            Chart.defaults.animation.duration = 1000;
            Chart.defaults.animation.easing = 'easeInOutQuart';
        }

    </script>
</body>
</html>
