<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dashboard - Parsing Numeri</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
        .metric { display: inline-block; margin: 10px; padding: 15px; background: #e3f2fd; border-radius: 5px; min-width: 150px; text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; color: #1976d2; }
        .metric-label { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Test Dashboard - Debug Parsing Numeri</h1>
        
        <div class="test-section">
            <h3>Stato Connessione CSV</h3>
            <div id="connectionStatus">Testando connessione...</div>
        </div>
        
        <div class="test-section">
            <h3>Test Parsing Numeri</h3>
            <div id="parsingTest"></div>
        </div>
        
        <div class="test-section">
            <h3>Dati Raw dal CSV</h3>
            <div id="rawData">Caricamento...</div>
        </div>
        
        <div class="test-section">
            <h3>Metriche Calcolate</h3>
            <div id="metrics">Elaborazione...</div>
        </div>
        
        <div class="test-section">
            <h3>Log Debug</h3>
            <div id="debugLog" class="debug"></div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/csv-concatenato-agenti.csv';
        let debugLog = [];

        function log(message) {
            console.log(message);
            debugLog.push(new Date().toLocaleTimeString() + ': ' + message);
            document.getElementById('debugLog').innerHTML = debugLog.join('<br>');
        }

        // Funzione di parsing numeri specifica per il tuo formato
        function parseMyNumber(value) {
            log(`Input: "${value}" (tipo: ${typeof value})`);
            
            // Se è già un numero
            if (typeof value === 'number') {
                log(`  -> Già numero: ${value}`);
                return value;
            }
            
            // Se non è stringa
            if (typeof value !== 'string') {
                const result = parseFloat(value) || 0;
                log(`  -> Convertito: ${result}`);
                return result;
            }
            
            // Rimuovi virgolette e spazi
            let clean = value.trim().replace(/"/g, '');
            log(`  -> Pulito: "${clean}"`);
            
            // Vuoto
            if (!clean || clean === '') {
                log(`  -> Vuoto: 0`);
                return 0;
            }
            
            // Percentuali: "27,%" -> 27
            if (clean.includes('%')) {
                const num = clean.replace('%', '').replace(',', '.');
                const result = Math.round(parseFloat(num) || 0);
                log(`  -> Percentuale: ${result}`);
                return result;
            }
            
            // Formato italiano completo: "67.611,27" -> 67611
            if (clean.includes('.') && clean.includes(',')) {
                const num = clean.replace(/\./g, '').replace(',', '.');
                const result = Math.round(parseFloat(num) || 0);
                log(`  -> Formato italiano: ${result}`);
                return result;
            }
            
            // Solo virgola: "8,00" -> 8
            if (clean.includes(',') && !clean.includes('.')) {
                const num = clean.replace(',', '.');
                const result = Math.round(parseFloat(num) || 0);
                log(`  -> Solo virgola: ${result}`);
                return result;
            }
            
            // Numero normale
            const result = Math.round(parseFloat(clean) || 0);
            log(`  -> Numero normale: ${result}`);
            return result;
        }

        // Test dei numeri
        function testParsing() {
            const testCases = [
                '"67.611,27"',
                '67.611,27',
                '"8,00"',
                '8,00',
                '"27,%"',
                '27,%',
                '""',
                '',
                '8',
                '0',
                '"0,00"'
            ];
            
            let html = '<h4>Test Casi:</h4>';
            testCases.forEach(test => {
                const result = parseMyNumber(test);
                html += `<div><code>${test}</code> → <strong>${result}</strong></div>`;
            });
            
            document.getElementById('parsingTest').innerHTML = html;
        }

        // Carica e testa CSV
        async function loadAndTest() {
            try {
                log('Inizio caricamento CSV...');
                document.getElementById('connectionStatus').innerHTML = '<span class="success">Connessione in corso...</span>';
                
                const response = await fetch(CSV_URL + '?t=' + Date.now());
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                log(`CSV caricato, dimensione: ${csvText.length} caratteri`);
                document.getElementById('connectionStatus').innerHTML = '<span class="success">✓ CSV caricato correttamente</span>';
                
                // Mostra primi 500 caratteri
                document.getElementById('rawData').innerHTML = `
                    <pre style="max-height: 200px; overflow-y: auto; font-size: 12px;">
                    ${csvText.substring(0, 1000)}...
                    </pre>
                `;
                
                // Parsing semplice
                parseCSVSimple(csvText);
                
            } catch (error) {
                log(`ERRORE: ${error.message}`);
                document.getElementById('connectionStatus').innerHTML = `<span class="error">✗ Errore: ${error.message}</span>`;
            }
        }

        function parseCSVSimple(csvText) {
            log('Inizio parsing CSV...');
            
            const lines = csvText.split('\n');
            let agenti = [];
            let currentAgent = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.includes('Codice Agente:')) {
                    if (currentAgent) agenti.push(currentAgent);
                    currentAgent = {
                        codice: line.split(':')[1]?.trim() || '',
                        nome: '',
                        fatturato_attuale: 0,
                        fatturato_precedente: 0,
                        clienti: 0
                    };
                    log(`Nuovo agente trovato: ${currentAgent.codice}`);
                }
                
                if (line.includes('Ragione Sociale:') && currentAgent) {
                    currentAgent.nome = line.split(':')[1]?.trim() || '';
                    log(`Nome agente: ${currentAgent.nome}`);
                }
                
                // Cerca righe OBIETTIVI con Generale
                if (line.startsWith('OBIETTIVI,Generale,') && currentAgent) {
                    const parts = line.split(',');
                    if (parts.length >= 4) {
                        currentAgent.fatturato_precedente = parseMyNumber(parts[2]);
                        currentAgent.fatturato_attuale = parseMyNumber(parts[3]);
                        if (parts.length >= 8) {
                            currentAgent.clienti = parseMyNumber(parts[7]);
                        }
                        log(`Dati agente ${currentAgent.nome}: ${currentAgent.fatturato_attuale} (${currentAgent.fatturato_precedente}) - ${currentAgent.clienti} clienti`);
                    }
                }
            }
            
            if (currentAgent) agenti.push(currentAgent);
            
            log(`Parsing completato. Agenti trovati: ${agenti.length}`);
            
            // Calcola metriche
            let totaleCorrente = 0;
            let totalePrecedente = 0;
            let totaleClienti = 0;
            
            agenti.forEach(agente => {
                totaleCorrente += agente.fatturato_attuale;
                totalePrecedente += agente.fatturato_precedente;
                totaleClienti += agente.clienti;
            });
            
            const crescita = totalePrecedente > 0 ? 
                ((totaleCorrente - totalePrecedente) / totalePrecedente * 100) : 0;
            
            // Mostra metriche
            document.getElementById('metrics').innerHTML = `
                <div class="metric">
                    <div class="metric-value">€${Math.round(totaleCorrente/1000)}k</div>
                    <div class="metric-label">Fatturato 2025</div>
                </div>
                <div class="metric">
                    <div class="metric-value">€${Math.round(totalePrecedente/1000)}k</div>
                    <div class="metric-label">Fatturato 2024</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${totaleClienti}</div>
                    <div class="metric-label">Clienti Totali</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${crescita.toFixed(1)}%</div>
                    <div class="metric-label">Crescita</div>
                </div>
                <div class="metric">
                    <div class="metric-value">${agenti.length}</div>
                    <div class="metric-label">Agenti</div>
                </div>
            `;
            
            log(`METRICHE FINALI - Fatturato: €${totaleCorrente}, Clienti: ${totaleClienti}, Crescita: ${crescita.toFixed(1)}%`);
        }

        // Avvia test
        document.addEventListener('DOMContentLoaded', () => {
            testParsing();
            loadAndTest();
        });
    </script>
</body>
</html>
