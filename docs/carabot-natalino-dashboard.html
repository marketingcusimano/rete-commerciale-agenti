<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CARABOT NATALINO</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Montserrat', sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            color: #2d3748;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .header-subtitle {
            color: #718096;
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .refresh-button {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        
        .refresh-button:hover {
            background: #38a169;
            transform: translateY(-1px);
        }
        
        .refresh-button.loading {
            background: #4299e1;
        }
        
        .theme-toggle {
            background: #2d3748;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .theme-toggle:hover {
            background: #1a202c;
            transform: translateY(-1px);
        }
        
        .info-bar {
            background: white;
            padding: 20px 32px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 32px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #4a5568;
            font-weight: 500;
        }
        
        .info-item i {
            color: #667eea;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #48bb78;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.loading {
            background: #4299e1;
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.error {
            background: #e53e3e;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .filter-section {
            background: white;
            padding: 24px 32px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
        }
        
        .filter-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        .province-selector {
            position: relative;
        }
        
        .selector-button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        
        .selector-button:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        
        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            padding: 16px;
            min-width: 320px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s;
        }
        
        .dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-header {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .dropdown-subtitle {
            color: #718096;
            font-size: 0.875rem;
            margin-bottom: 16px;
        }
        
        .province-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        
        .province-option:hover {
            background: #f7fafc;
        }
        
        .province-option.selected {
            background: #4299e1;
            color: white;
        }
        
        .province-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .province-option.selected .province-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .province-option:not(.selected) .province-icon {
            background: #edf2f7;
            color: #4a5568;
        }
        
        .province-info h4 {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .province-info span {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        .radio-button {
            margin-left: auto;
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-radius: 50%;
            position: relative;
        }
        
        .province-option.selected .radio-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .cancel-btn {
            width: 100%;
            background: #f7fafc;
            color: #4a5568;
            border: none;
            padding: 12px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 12px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .metric-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .metric-title {
            color: #718096;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .growth-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .growth-positive {
            background: #c6f6d5;
            color: #25855a;
        }
        
        .growth-negative {
            background: #fed7d7;
            color: #c53030;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 8px;
        }
        
        .metric-subtitle {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .progress-section {
            margin-top: 20px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .progress-label {
            color: #4a5568;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: #48bb78;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #edf2f7;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78, #38a169);
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .progress-fill.warning {
            background: linear-gradient(90deg, #ed8936, #dd6b20);
        }
        
        .progress-details {
            color: #718096;
            font-size: 0.85rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 4px;
        }
        
        .performance-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .performance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .performance-card .metric-title,
        .performance-card .metric-subtitle {
            color: white;
        }
        
        .performance-card .metric-value {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .performance-card .growth-indicator {
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .performance-card .stat-value {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .performance-card .stat-label {
            color: white;
        }
        
        .trend-card {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .trend-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .trend-card .metric-title,
        .trend-card .metric-subtitle {
            color: white;
        }
        
        .trend-card .metric-value {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .trend-card .growth-indicator {
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .trend-card .stat-value {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .trend-card .stat-label {
            color: white;
        }
        
        .efficiency-card {
            background: linear-gradient(135deg, #3182ce 0%, #2c5aa0 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .efficiency-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .efficiency-card .metric-title,
        .efficiency-card .metric-subtitle {
            color: white;
        }
        
        .efficiency-card .metric-value {
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .efficiency-card .growth-indicator {
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .efficiency-card .stat-value {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .efficiency-card .stat-label {
            color: white;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 16px;
            }
            
            .info-bar {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .dropdown {
                min-width: 280px;
            }
        }
        
        @media (max-width: 480px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>CARABOT NATALINO</h1>
                <div class="header-subtitle">Dashboard Performance Vendite</div>
            </div>
            <div class="header-right">
                <button class="refresh-button" onclick="manualRefresh()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Aggiorna</span>
                </button>
                <button class="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
        
        <!-- Info Bar -->
        <div class="info-bar">
            <div class="info-item">
                <i class="fas fa-id-card"></i>
                <span>ID: <strong>631.00238</strong></span>
            </div>
            <div class="info-item">
                <i class="fas fa-calendar-alt"></i>
                <span>Gen - Ago 2025 (8 mesi)</span>
            </div>
            <div class="info-item">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text">Caricamento dati...</span>
            </div>
        </div>
        
        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-title">Filtro Territorio</div>
            <div class="province-selector">
                <button class="selector-button" onclick="toggleDropdown()">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="selected-province">Tutte le Province</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div class="dropdown" id="province-dropdown">
                    <div class="dropdown-header">Selezione Provincia</div>
                    <div class="dropdown-subtitle">Scegli il territorio da visualizzare</div>
                    
                    <div class="province-option selected" data-province="all">
                        <div class="province-icon">
                            <i class="fas fa-globe-europe"></i>
                        </div>
                        <div class="province-info">
                            <h4>Tutte le Province</h4>
                            <span>Panoramica completa</span>
                        </div>
                        <div class="radio-button"></div>
                    </div>
                    
                    <div class="province-option" data-province="LT">
                        <div class="province-icon">
                            <i class="fas fa-map-marker-alt" style="color: #48bb78;"></i>
                        </div>
                        <div class="province-info">
                            <h4>Latina</h4>
                            <span id="lt-stats">Caricamento...</span>
                        </div>
                        <div class="radio-button"></div>
                    </div>
                    
                    <div class="province-option" data-province="RM">
                        <div class="province-icon">
                            <i class="fas fa-map-marker-alt" style="color: #3182ce;"></i>
                        </div>
                        <div class="province-info">
                            <h4>Roma</h4>
                            <span id="rm-stats">Caricamento...</span>
                        </div>
                        <div class="radio-button"></div>
                    </div>
                    
                    <button class="cancel-btn" onclick="closeDropdown()">Annulla</button>
                </div>
            </div>
        </div>
        
        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Fatturato Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Fatturato 2025</div>
                    <div class="growth-indicator growth-positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="growth-rate">+0%</span>
                    </div>
                </div>
                <div class="metric-value" id="fatturato-value">€0</div>
                <div class="metric-subtitle">vs 2024: <strong>€80k</strong></div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Obiettivo Fatturato</span>
                        <span class="progress-percentage">€155k</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="fatturato-progress" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        Mancano: <strong id="fatturato-mancante">€155k</strong>
                    </div>
                </div>
            </div>
            
            <!-- Obiettivo Card -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Obiettivo 2025</div>
                </div>
                <div class="metric-value">€155k</div>
                <div class="metric-subtitle">Da raggiungere: <strong id="da-raggiungere">€155k</strong></div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Progressione Obiettivo</span>
                        <span class="progress-percentage" id="progressione-perc">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="obiettivo-progress" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        Mancano: <strong id="obiettivo-mancante">€155k</strong> • <strong id="obiettivo-percent">0%</strong>
                    </div>
                </div>
            </div>
            
            <!-- Clienti Attivi -->
            <div class="metric-card">
                <div class="metric-header">
                    <div class="metric-title">Clienti Attivi</div>
                </div>
                <div class="metric-value" id="clienti-value">0</div>
                <div class="metric-subtitle" id="clienti-obiettivo">Obiettivo: 35 clienti</div>
                
                <div class="progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Obiettivo Clienti</span>
                        <span class="progress-percentage" id="clienti-perc">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill warning" id="clienti-progress" style="width: 0%"></div>
                    </div>
                    <div class="progress-details">
                        Obiettivo: <strong>35 clienti</strong> • Mancano: <strong id="clienti-mancanti">35</strong>
                    </div>
                </div>
            </div>
            
            <!-- Top Performance -->
            <div class="metric-card performance-card">
                <div class="metric-header">
                    <div class="metric-title">Top Performance</div>
                    <div class="growth-indicator">
                        <i class="fas fa-arrow-up"></i>
                        +4.3%
                    </div>
                </div>
                <div class="metric-value" id="top-province">--</div>
                <div class="metric-subtitle" id="top-province-name">Caricamento...</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="top-fatturato">€0</div>
                        <div class="stat-label">fatturato totale</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="top-clienti">0</div>
                        <div class="stat-label">clienti</div>
                    </div>
                </div>
            </div>
            
            <!-- Trend Mensile -->
            <div class="metric-card trend-card">
                <div class="metric-header">
                    <div class="metric-title">Trend Mensile</div>
                    <div class="growth-indicator">
                        <i class="fas fa-chart-line"></i>
                        Stabile
                    </div>
                </div>
                <div class="metric-value" id="media-mensile">€0</div>
                <div class="metric-subtitle">Media mensile 2025</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">€10.6k</div>
                        <div class="stat-label">Media 2024</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="vs-2024">+0%</div>
                        <div class="stat-label">vs 2024</div>
                    </div>
                </div>
            </div>
            
            <!-- Efficienza Vendite -->
            <div class="metric-card efficiency-card">
                <div class="metric-header">
                    <div class="metric-title">Efficienza Vendite</div>
                    <div class="growth-indicator">
                        <i class="fas fa-trophy"></i>
                        Alta
                    </div>
                </div>
                <div class="metric-value" id="media-cliente">€0</div>
                <div class="metric-subtitle">Fatturato medio per cliente</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="media-giorno">€0</div>
                        <div class="stat-label">Media/Giorno</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="clienti-mese">0</div>
                        <div class="stat-label">Clienti/Mese</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedProvince = 'all';
        let csvData = [];
        let productsChart = null;
        
        // URL del CSV - ASSICURATI CHE SIA CORRETTO
        const CSV_URL = 'https://marketingcusimano.github.io/rete-commerciale-agenti/63100238_CARABOT-NATALINO.csv';
        
        // Funzione per caricare e aggiornare i dati dal CSV
        async function loadDataFromCSV() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            try {
                // Mostra stato di caricamento
                statusIndicator.className = 'status-indicator loading';
                statusText.textContent = 'Caricamento dati...';
                
                console.log('Caricamento CSV da:', CSV_URL);
                
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`Errore HTTP ${response.status}: ${response.statusText}`);
                }
                
                const csvContent = await response.text();
                console.log('CSV caricato, dimensione:', csvContent.length, 'caratteri');
                
                // Parsing specifico per il formato del CSV
                const lines = csvContent.split('\n');
                const data = [];
                
                // Trova la sezione "DETTAGLIO VENDITE PER CLIENTE"
                let detailSectionStart = -1;
                let detailSectionEnd = -1;
                
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('DETTAGLIO VENDITE PER CLIENTE')) {
                        detailSectionStart = i + 1; // Salta l'intestazione della sezione
                        console.log('Trovata sezione dettaglio vendite alla riga:', i);
                        break;
                    }
                }
                
                // Trova la fine della sezione (prossima sezione che inizia con ===)
                if (detailSectionStart >= 0) {
                    for (let i = detailSectionStart + 1; i < lines.length; i++) {
                        if (lines[i].includes('===') || lines[i].includes('RIEPILOGO')) {
                            detailSectionEnd = i;
                            break;
                        }
                    }
                    if (detailSectionEnd === -1) detailSectionEnd = lines.length;
                    
                    console.log('Sezione dettaglio vendite: righe', detailSectionStart, '-', detailSectionEnd);
                    
                    // Parse dei dati vendite
                    const headers = ['Provincia', 'Ragione Sociale Cliente', 'Categoria ARTICOLI', 'Fatturato'];
                    
                    for (let i = detailSectionStart + 1; i < detailSectionEnd; i++) {
                        const line = lines[i].trim();
                        if (line && !line.includes('===') && line.includes(',')) {
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                // Ricostruisci i campi considerando che il fatturato può contenere virgole
                                const provincia = parts[0];
                                let cliente = '';
                                let categoria = '';
                                let fatturato = '';
                                
                                // Il fatturato è sempre l'ultima parte (con le virgole)
                                fatturato = parts[parts.length - 1].replace(/"/g, '');
                                
                                // Categoria è la penultima parte
                                categoria = parts[parts.length - 2];
                                
                                // Cliente è tutto quello che sta nel mezzo
                                for (let j = 1; j < parts.length - 2; j++) {
                                    cliente += (j > 1 ? ',' : '') + parts[j];
                                }
                                cliente = cliente.replace(/"/g, '');
                                categoria = categoria.replace(/"/g, '');
                                
                                const row = {
                                    'Provincia': provincia,
                                    'Cliente': cliente,
                                    'Categoria': categoria,
                                    'Fatturato': fatturato
                                };
                                data.push(row);
                            }
                        }
                    }
                }
                
                console.log('Dati elaborati dalla sezione vendite:', data.length, 'righe');
                
                // Aggiungi anche i dati dalle altre sezioni per completezza
                parseOtherSections(lines, data);
                
                csvData = data;
                
                // Aggiorna la dashboard
                updateDashboardFromData(data);
                
                // Stato successo
                statusIndicator.className = 'status-indicator';
                statusText.textContent = `Dati aggiornati: ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                statusIndicator.className = 'status-indicator error';
                statusText.textContent = 'Errore caricamento dati: ' + error.message;
            }
        }
        
        // Funzione per estrarre i dati riassuntivi dalle altre sezioni
        function parseOtherSections(lines, data) {
            // Estrai i totali dalla sezione TOTALI
            const totalsSection = lines.find(line => line.includes('Fatturato Totale'));
            if (totalsSection) {
                console.log('Trovati totali:', totalsSection);
            }
            
            // Estrai dati clienti per provincia dalla sezione CLIENTI PER PROVINCIA
            let clientiProvinciaStart = -1;
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].includes('CLIENTI PER PROVINCIA')) {
                    clientiProvinciaStart = i + 1;
                    break;
                }
            }
            
            if (clientiProvinciaStart >= 0) {
                // Salta l'header e leggi i dati
                for (let i = clientiProvinciaStart + 1; i < lines.length && !lines[i].includes('==='); i++) {
                    const line = lines[i].trim();
                    if (line && line.includes(',')) {
                        console.log('Riga clienti provincia:', line);
                    }
                }
            }
        }
        
        // Funzione per convertire valori europei (virgola decimale) in numeri
        function parseEuropeanNumber(value) {
            if (!value) return 0;
            // Rimuove tutto tranne numeri, virgole e punti
            const cleaned = value.toString().replace(/[^0-9,.]/g, '');
            
            // Se ha sia punto che virgola, considera il punto come separatore delle migliaia
            if (cleaned.includes('.') && cleaned.includes(',')) {
                return parseFloat(cleaned.replace(/\./g, '').replace(',', '.')) || 0;
            }
            // Se ha solo la virgola, la considera come separatore decimale
            else if (cleaned.includes(',') && !cleaned.includes('.')) {
                return parseFloat(cleaned.replace(',', '.')) || 0;
            }
            // Altrimenti parsing normale
            else {
                return parseFloat(cleaned) || 0;
            }
        }
        
        // Funzione per aggiornare la dashboard con i dati
        function updateDashboardFromData(data) {
            let totalFatturato = 0;
            let clientiUnici = new Set();
            let provinceStats = { LT: { fatturato: 0, clienti: new Set() }, RM: { fatturato: 0, clienti: new Set() } };
            let prodottiStats = { 'Pieni e Coppi': 0, 'Altri Prodotti': 0 };
            
            console.log('Elaborando', data.length, 'righe di dati...');
            
            // Elabora i dati delle vendite
            data.forEach((row, index) => {
                const fatturato = parseEuropeanNumber(row.Fatturato);
                const cliente = row.Cliente || '';
                const provincia = row.Provincia || '';
                const categoria = row.Categoria || '';
                
                if (index < 3) {
                    console.log(`Riga ${index}:`, {
                        cliente: cliente.substring(0, 20),
                        provincia,
                        categoria: categoria.substring(0, 15),
                        fatturatoRaw: row.Fatturato,
                        fatturatoParsed: fatturato
                    });
                }
                
                if (fatturato > 0) {
                    totalFatturato += fatturato;
                }
                
                if (cliente) {
                    clientiUnici.add(cliente);
                }
                
                // Statistiche province
                if (provincia === 'LT') {
                    provinceStats.LT.fatturato += fatturato;
                    if (cliente) provinceStats.LT.clienti.add(cliente);
                } else if (provincia === 'RM') {
                    provinceStats.RM.fatturato += fatturato;
                    if (cliente) provinceStats.RM.clienti.add(cliente);
                }
                
                // Categorizza prodotti
                if (categoria) {
                    const catLower = categoria.toLowerCase();
                    if (catLower.includes('mattone') || catLower.includes('pieno') || 
                        catLower.includes('coppi') || catLower.includes('coperture')) {
                        prodottiStats['Pieni e Coppi'] += fatturato;
                    } else {
                        prodottiStats['Altri Prodotti'] += fatturato;
                    }
                }
            });
            
            console.log('Totali calcolati:', {
                fatturato: totalFatturato,
                clienti: clientiUnici.size,
                LT: { fatturato: provinceStats.LT.fatturato, clienti: provinceStats.LT.clienti.size },
                RM: { fatturato: provinceStats.RM.fatturato, clienti: provinceStats.RM.clienti.size }
            });
            
            // Aggiorna i valori nella dashboard
            const fatturatoK = Math.round(totalFatturato / 1000);
            const obiettivo = 155000; // €155k
            const progressione = Math.round((totalFatturato / obiettivo) * 100);
            const mancante = Math.max(0, obiettivo - totalFatturato);
            
            // Aggiorna elementi
            document.getElementById('fatturato-value').textContent = `€${fatturatoK}k`;
            document.getElementById('clienti-value').textContent = clientiUnici.size;
            document.getElementById('fatturato-progress').style.width = `${Math.min(progressione, 100)}%`;
            document.getElementById('obiettivo-progress').style.width = `${Math.min(progressione, 100)}%`;
            document.getElementById('progressione-perc').textContent = `${progressione}%`;
            document.getElementById('fatturato-mancante').textContent = `€${Math.round(mancante/1000)}k`;
            document.getElementById('da-raggiungere').textContent = `€${Math.round(mancante/1000)}k`;
            document.getElementById('obiettivo-mancante').textContent = `€${Math.round(mancante/1000)}k`;
            document.getElementById('obiettivo-percent').textContent = `${progressione}%`;
            
            // Calcola crescita vs 2024 (dal CSV: era €80.238,72, ora €90.159,79)
            const fatturato2024 = 80238.72;
            const crescita = ((totalFatturato - fatturato2024) / fatturato2024 * 100).toFixed(1);
            document.getElementById('growth-rate').textContent = `+${crescita}%`;
            
            // Clienti
            const obiettivoClienti = 35;
            const progressioneClienti = Math.round((clientiUnici.size / obiettivoClienti) * 100);
            document.getElementById('clienti-progress').style.width = `${Math.min(progressioneClienti, 100)}%`;
            document.getElementById('clienti-perc').textContent = `${progressioneClienti}%`;
            document.getElementById('clienti-mancanti').textContent = Math.max(0, obiettivoClienti - clientiUnici.size);
            
            // Media mensile (8 mesi: Gennaio-Agosto)
            const mesi = 8;
            const mediaMensile = Math.round(totalFatturato / mesi / 1000);
            document.getElementById('media-mensile').textContent = `€${mediaMensile}k`;
            
            // Vs 2024 media mensile
            const mediaMensile2024 = 10.6; // €10.6k dal CSV
            const crescitaMensile = ((mediaMensile - mediaMensile2024) / mediaMensile2024 * 100).toFixed(1);
            document.getElementById('vs-2024').textContent = `+${crescitaMensile}%`;
            
            // Efficienza
            const mediaCliente = clientiUnici.size > 0 ? Math.round(totalFatturato / clientiUnici.size / 1000) : 0;
            document.getElementById('media-cliente').textContent = `€${mediaCliente}k`;
            
            const mediaGiorno = Math.round(totalFatturato / (31 * mesi)); // ~31 giorni per mese
            document.getElementById('media-giorno').textContent = `€${mediaGiorno}`;
            
            const clientiMese = Math.round(clientiUnici.size / mesi * 10) / 10;
            document.getElementById('clienti-mese').textContent = clientiMese;
            
            // Top performance
            const topProv = provinceStats.LT.fatturato >= provinceStats.RM.fatturato ? 'LT' : 'RM';
            const topStats = provinceStats[topProv];
            document.getElementById('top-province').textContent = topProv;
            document.getElementById('top-province-name').textContent = `Provincia ${topProv === 'LT' ? 'Latina' : 'Roma'}`;
            document.getElementById('top-fatturato').textContent = `€${Math.round(topStats.fatturato/1000)}k`;
            document.getElementById('top-clienti').textContent = topStats.clienti.size;
            
            // Aggiorna statistiche province nel dropdown
            document.getElementById('lt-stats').textContent = `€${Math.round(provinceStats.LT.fatturato/1000)}k • ${provinceStats.LT.clienti.size} clienti`;
            document.getElementById('rm-stats').textContent = `€${Math.round(provinceStats.RM.fatturato/1000)}k • ${provinceStats.RM.clienti.size} clienti`;
            
            console.log('Dashboard aggiornata con i dati CSV reali');
        }
        
        // Refresh manuale
        async function manualRefresh() {
            const button = document.querySelector('.refresh-button');
            const originalContent = button.innerHTML;
            
            // Stato loading
            button.classList.add('loading');
            button.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i><span>Aggiornando...</span>';
            
            try {
                await loadDataFromCSV();
                
                // Successo
                button.innerHTML = '<i class="fas fa-check"></i><span>Aggiornato!</span>';
                button.style.background = '#48bb78';
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('loading');
                    button.style.background = '';
                }, 2000);
                
            } catch (error) {
                // Errore
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Errore</span>';
                button.style.background = '#e53e3e';
                
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('loading');
                    button.style.background = '';
                }, 3000);
            }
        }
        
        // Funzioni dropdown province
        function toggleDropdown() {
            const dropdown = document.getElementById('province-dropdown');
            dropdown.classList.toggle('active');
        }
        
        function closeDropdown() {
            const dropdown = document.getElementById('province-dropdown');
            dropdown.classList.remove('active');
        }
        
        // Gestione selezione provincia
        document.addEventListener('click', function(e) {
            if (e.target.closest('.province-option')) {
                const option = e.target.closest('.province-option');
                const province = option.getAttribute('data-province');
                
                // Rimuovi selezione precedente
                document.querySelectorAll('.province-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Aggiungi selezione corrente
                option.classList.add('selected');
                
                // Aggiorna testo bottone
                const provinceName = option.querySelector('h4').textContent;
                document.getElementById('selected-province').textContent = provinceName;
                
                // Aggiorna dati per provincia specifica
                updateDashboardForProvince(province);
                closeDropdown();
            }
            
            // Chiudi dropdown se click esterno
            if (!e.target.closest('.province-selector')) {
                closeDropdown();
            }
        });
        
        // Aggiorna dashboard per provincia specifica
        function updateDashboardForProvince(province) {
            selectedProvince = province;
            
            if (!csvData || csvData.length === 0) {
                console.log('Nessun dato disponibile per il filtro');
                return;
            }
            
            let filteredData = csvData;
            
            if (province !== 'all') {
                filteredData = csvData.filter(row => {
                    const prov = (row['Provincia'] || row['Prov'] || row['PR'] || '').toUpperCase();
                    return prov === province.toUpperCase() || 
                           (province === 'LT' && prov === 'LATINA') ||
                           (province === 'RM' && prov === 'ROMA');
                });
            }
            
            console.log(`Filtrati ${filteredData.length} righe per provincia ${province}`);
            updateDashboardFromData(filteredData);
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Inizializzazione dashboard...');
            
            // Carica i dati iniziali
            loadDataFromCSV();
            
            // Auto-refresh ogni 5 minuti (300000 ms)
            setInterval(loadDataFromCSV, 300000);
            
            console.log('Auto-refresh impostato ogni 5 minuti');
        });
    </script>
</body>
</html>
