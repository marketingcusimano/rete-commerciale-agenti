<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        body.dark-mode { 
            background: #0f172a; 
            color: #f8fafc; 
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 2rem; 
        }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 2rem; 
            flex-wrap: wrap; 
            gap: 1rem; 
        }
        
        .header-info h1 { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: #1f2937; 
            margin-bottom: 0.5rem; 
        }
        
        body.dark-mode .header-info h1 { 
            color: #f8fafc; 
        }
        
        .header-info p { 
            color: #6b7280; 
            font-size: 1.1rem; 
            font-weight: 500; 
        }
        
        .theme-toggle { 
            background: #374151; 
            color: white; 
            border: none; 
            padding: 0.75rem; 
            border-radius: 50%; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            font-size: 1.25rem; 
            width: 50px; 
            height: 50px; 
        }
        
        .theme-toggle:hover { 
            background: #4b5563; 
            transform: scale(1.1); 
        }
        
        .status-bar { 
            display: flex; 
            align-items: center; 
            gap: 2rem; 
            margin-bottom: 2rem; 
            flex-wrap: wrap; 
        }
        
        .status-item { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-size: 0.9rem; 
            color: #6b7280; 
        }
        
        .status-item i { 
            color: #3b82f6; 
        }
        
        .status-item strong { 
            color: #1f2937; 
        }
        
        body.dark-mode .status-item strong { 
            color: #f8fafc; 
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Filter Section */
        .filter-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        body.dark-mode .filter-label {
            color: #d1d5db;
        }

        .province-selector {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .province-selector:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        /* Province Selection Popup */
        .province-popup {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            padding: 1rem;
            display: none;
        }

        .popup-content {
            background: white;
            border-radius: 1rem;
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        body.dark-mode .popup-content {
            background: #1e293b;
            color: #f8fafc;
        }

        .province-option {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            background: white;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 0.75rem;
        }

        body.dark-mode .province-option {
            background: #374151;
            border-color: #4b5563;
            color: #f8fafc;
        }

        .province-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        body.dark-mode .province-option:hover {
            background: #4b5563;
        }

        .province-option.selected {
            border-color: #3b82f6;
            background: #f0f9ff;
        }

        body.dark-mode .province-option.selected {
            background: #4b5563;
        }
        
        .cards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 1.5rem; 
            margin-bottom: 2rem; 
        }
        
        .card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        body.dark-mode .card { 
            background: #1e293b; 
            border-color: #334155; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); 
        }
        
        .card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1); 
        }
        
        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            margin-bottom: 1rem; 
        }
        
        .card-title { 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #6b7280; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
        }
        
        .card-badge { 
            background: #dcfce7; 
            color: #16a34a; 
            padding: 0.25rem 0.75rem; 
            border-radius: 1rem; 
            font-size: 0.75rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 0.25rem; 
        }
        
        .card-badge.warning {
            background: #fef3c7;
            color: #d97706;
        }
        
        .card-value { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: #1f2937; 
            margin-bottom: 0.5rem; 
        }
        
        body.dark-mode .card-value { 
            color: #f8fafc; 
        }
        
        .card-subtitle { 
            color: #6b7280; 
            font-size: 0.9rem; 
            margin-bottom: 1rem; 
        }

        .progress-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }

        body.dark-mode .progress-section {
            background: #0f172a;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .progress-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1f2937;
        }

        body.dark-mode .progress-label {
            color: #f8fafc;
        }

        .progress-value {
            font-size: 0.875rem;
            font-weight: 700;
            color: #6b7280;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 1rem;
            overflow: hidden;
        }

        body.dark-mode .progress-bar-container {
            background: #374151;
        }

        .progress-bar {
            height: 100%;
            border-radius: 1rem;
            transition: width 2s ease-in-out;
            position: relative;
        }

        .progress-bar.green {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-bar.blue {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .progress-bar.orange {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            font-size: 0.875rem;
        }

        .progress-remaining {
            color: #6b7280;
        }

        .progress-percentage {
            color: #3b82f6;
            font-weight: 700;
        }
        
        .province-badge { 
            display: inline-block; 
            padding: 0.25rem 0.5rem; 
            border-radius: 9999px; 
            font-size: 0.75rem; 
            font-weight: 700; 
        }
        
        .province-badge.LT { 
            background: rgba(139, 92, 246, 0.1); 
            color: #8b5cf6; 
        }
        
        .province-badge.RM { 
            background: rgba(34, 211, 238, 0.1); 
            color: #22d3ee; 
        }
        
        .loading-container, .error-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 200px; 
            color: #6b7280; 
            flex-direction: column; 
            gap: 1rem; 
        }
        
        .loading-spinner { 
            animation: spin 1s linear infinite; 
            font-size: 2rem; 
        }
        
        @keyframes spin { 
            from { transform: rotate(0deg); } 
            to { transform: rotate(360deg); } 
        }
        
        .error-container { 
            background: #fee2e2; 
            color: #dc2626; 
            padding: 1rem; 
            border-radius: 0.75rem; 
            text-align: center; 
            margin: 2rem 0; 
        }
        
        body.dark-mode .error-container { 
            background: #7f1d1d; 
            color: #fca5a5; 
        }
        
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { flex-direction: column; align-items: flex-start; }
            .header-info h1 { font-size: 2rem; }
            .cards-grid { grid-template-columns: 1fr; }
            .card-value { font-size: 2rem; }
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> 631.00238</span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong>Gen - Ago 2025</strong> (8 mesi)</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati CSV aggiornati</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div>
                <div class="filter-label">Filtro Territorio</div>
                <div style="color: #3b82f6; font-weight: 600; margin-top: 0.25rem;" id="current-filter">Tutte le Province</div>
            </div>
            <button class="province-selector" id="province-selector">
                <i class="fas fa-chevron-down"></i>
                <span>Selezione Provincia</span>
            </button>
        </div>

        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <div id="main-content" style="display: none;">
            <div class="cards-grid">
                <!-- Fatturato Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fatturato 2025</div>
                        <div class="card-badge">
                            <i class="fas fa-arrow-up"></i>
                            <span id="growth-badge">+0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="fatturato-value">€0k</div>
                    <div class="card-subtitle">vs 2024: <strong id="fatturato-vs">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Fatturato</div>
                            <div class="progress-value" id="obiettivo-fatturato">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar green" id="progress-fatturato" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="fatturato-remaining">€0k</strong></div>
                            <div class="progress-percentage" id="fatturato-percentage">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Obiettivo Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Obiettivo 2025</div>
                        <div class="card-badge" id="obiettivo-badge">
                            <span id="obiettivo-percentage">0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="obiettivo-value">€0k</div>
                    <div class="card-subtitle">Da raggiungere: <strong id="obiettivo-remaining">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Progressione Obiettivo</div>
                            <div class="progress-value" id="obiettivo-target">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar blue" id="progress-obiettivo" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="obiettivo-mancano">€0k</strong></div>
                            <div class="progress-percentage" id="obiettivo-perc-display">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Clienti Attivi Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Clienti Attivi</div>
                        <div class="card-badge">
                            <span id="clienti-percentage">0</span>
                        </div>
                    </div>
                    <div class="card-value" id="clienti-count">0</div>
                    <div class="card-subtitle">LT: <span id="clienti-lt">0</span> • RM: <span id="clienti-rm">0</span></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Clienti</div>
                            <div class="progress-value" id="clienti-target-value">0</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar orange" id="progress-clienti" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="clienti-mancanti">0 clienti</strong></div>
                            <div class="progress-percentage" id="clienti-perc-display">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Province Servite Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Province Servite</div>
                    </div>
                    <div class="card-value" id="province-count">0</div>
                    <div class="card-subtitle" id="province-list">Caricamento...</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <!-- Confronto Clienti per Provincia -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Clienti per Provincia</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="clientiChart"></canvas>
                    </div>
                    
                    <!-- Province Info Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #fef2f2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-growth">0%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="rm-growth">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confronto Province (Fatturato) -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Province</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="fatturatoChart"></canvas>
                    </div>
                    
                    <!-- Province Revenue Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong id="lt-fatturato-prev">€0k</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-fatturato-growth">0%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong>0 €</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;">+∞%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top 10 Vendite per Cliente -->
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Top 10 Vendite per Cliente</h3>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Provincia</th>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Cliente</th>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Categoria</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Fatturato</th>
                            </tr>
                        </thead>
                        <tbody id="vendite-tbody">
                            <!-- Automatically populated from CSV -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="top-clienti-count">0</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Clienti Top 10</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="top-fatturato-total">€0k</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Top 10</div>
                    </div>
                </div>
            </div>

            <!-- Riepilogo per Categoria -->
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Riepilogo per Categoria</h3>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Categoria</th>
                                <th style="text-align: center; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Clienti LT</th>
                                <th style="text-align: center; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Clienti RM</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">Fatturato</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280;">% Totale</th>
                            </tr>
                        </thead>
                        <tbody id="categoria-tbody">
                            <!-- Automatically populated from CSV -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="categoria-totale">€0k</div>
                    <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Totale Categorie</div>
                </div>
            </div>

            <!-- Mix Prodotti Section -->
            <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Mix Prodotti</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                    <!-- Doughnut Chart -->
                    <div style="position: relative; height: 300px;">
                        <canvas id="mixProdottiChart"></canvas>
                    </div>
                    
                    <!-- Product Details -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Mattone + Pavimentazione -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #3b82f6;">Mattone + Pavimentazione</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #3b82f6;" id="core-percentage">0%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="core-amount">€0k</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Mattone:</span>
                                    <span id="mattone-amount">€0k</span>
                                </div>
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Pavimentazione:</span>
                                    <span id="pavimentazione-amount">€0k</span>
                                </div>
                            </div>
                        </div>

                        <!-- Altri Prodotti -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #6b7280;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #6b7280;">Altri Prodotti</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #6b7280;" id="other-percentage">0%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="other-amount">€0k</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Refrattari:</span>
                                    <span id="refrattari-amount">€0k</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Altri:</span>
                                    <span id="altri-amount">€0k</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Mix Prodotti -->
                <div style="background: linear-gradient(135deg, #f0f4ff, #e0e7ff); padding: 1.5rem; border-radius: 1rem; margin-top: 2rem; border: 1px solid #c7d2fe;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                        <span style="font-weight: 700; color: #3730a3;">Performance Mix Prodotti</span>
                        <span style="margin-left: auto; font-weight: 700; color: #3730a3;">Equilibrio Ottimo</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="core-perf">0%</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Prodotti Core</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="categories-count">0</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Categorie Attive</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="involved-clients">0</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Clienti Coinvolti</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Province Selection Popup -->
    <div id="province-popup" class="province-popup">
        <div class="popup-content">
            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Seleziona Provincia</h3>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button class="province-option" data-province="all">
                    <strong>Tutte le Province</strong>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="all-desc">€0k • 0 clienti</div>
                </button>
                <button class="province-option" data-province="LT">
                    <strong>Latina (LT)</strong>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="lt-desc">€0k • 0 clienti</div>
                </button>
                <button class="province-option" data-province="RM">
                    <strong>Roma (RM)</strong>
                    <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="rm-desc">€0k • 0 clienti</div>
                </button>
            </div>
            <button id="close-popup" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: #374151; color: white; border: none; border-radius: 0.5rem; cursor: pointer; width: 100%;">Chiudi</button>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.csvData = null;
                this.selectedProvince = 'all';
                this.isLoading = false;
                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv',
                    'CARABOT-NATALINO.csv',
                    'carabot.csv'
                ];
                this.charts = {}; // Store chart instances
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                
                // Province selector
                document.getElementById('province-selector').addEventListener('click', () => this.showProvincePopup());
                document.getElementById('close-popup').addEventListener('click', () => this.hideProvincePopup());
                
                // Province options
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.province-option')) {
                        const province = e.target.closest('.province-option').dataset.province;
                        this.selectProvince(province);
                    }
                });

                // Close popup on backdrop click
                document.getElementById('province-popup').addEventListener('click', (e) => {
                    if (e.target.id === 'province-popup') {
                        this.hideProvincePopup();
                    }
                });
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                }
            }

            showProvincePopup() {
                if (this.csvData) {
                    this.updateProvinceOptions();
                    document.getElementById('province-popup').style.display = 'block';
                }
            }

            hideProvincePopup() {
                document.getElementById('province-popup').style.display = 'none';
            }

            updateProvinceOptions() {
                if (!this.csvData) return;
                
                const allDesc = document.getElementById('all-desc');
                const ltDesc = document.getElementById('lt-desc');
                const rmDesc = document.getElementById('rm-desc');
                
                if (allDesc) allDesc.textContent = `${this.formatEuroK(this.csvData.generale.annoCorrente)} • ${this.csvData.generale.clienti} clienti`;
                if (ltDesc) ltDesc.textContent = `${this.formatEuroK(this.csvData.latina.annoCorrente)} • ${this.csvData.latina.clientiCorrente} clienti`;
                if (rmDesc) rmDesc.textContent = `${this.formatEuroK(this.csvData.roma.annoCorrente)} • ${this.csvData.roma.clienti} clienti`;
                
                // Update selected state
                document.querySelectorAll('.province-option').forEach(option => {
                    const province = option.dataset.province;
                    if (province === this.selectedProvince) {
                        option.classList.add('selected');
                    } else {
                        option.classList.remove('selected');
                    }
                });
            }

            selectProvince(province) {
                this.selectedProvince = province;
                
                const labels = { 
                    all: 'Tutte le Province', 
                    LT: 'Provincia Latina', 
                    RM: 'Provincia Roma' 
                };
                
                document.getElementById('current-filter').textContent = labels[province] || 'Tutte le Province';
                this.hideProvincePopup();
                this.updateDisplayForProvince();
            }

            updateDisplayForProvince() {
                if (!this.csvData) return;
                
                // Filter data based on selected province and update display
                this.updateDashboard();
            }

            async loadData() {
                this.isLoading = true;
                this.showLoading();

                try {
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Timeout: caricamento CSV troppo lento')), 10000);
                    });

                    const loadPromise = this.tryLoadCSV();
                    const result = await Promise.race([loadPromise, timeoutPromise]);
                    
                    this.csvData = this.parseCSV(result);
                    if (!this.csvData) {
                        throw new Error('Errore nel parsing del CSV - struttura non riconosciuta');
                    }

                    console.log('Parsed CSV data:', this.csvData);
                    this.showSuccess();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Errore caricamento completo:', error);
                    
                    // Fallback con dati di esempio
                    console.log('Usando dati di fallback...');
                    try {
                        const sampleData = this.createSampleCSV();
                        this.csvData = this.parseCSV(sampleData);
                        if (this.csvData) {
                            this.showSuccess();
                            this.updateDashboard();
                            return;
                        }
                    } catch (fallbackError) {
                        console.error('Errore anche con i dati di fallback:', fallbackError);
                    }
                    
                    this.showError(error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            async tryLoadCSV() {
                const candidates = this.buildCandidateUrls();
                let csvText = null;
                
                console.log('Trying to load CSV from these URLs:', candidates);
                
                for (const url of candidates) {
                    try {
                        console.log('Attempting to load:', url);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(url + '?t=' + Date.now(), {
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log(`Response for ${url}:`, response.status, response.ok);
                        if (response.ok) {
                            csvText = await response.text();
                            if (csvText && csvText.trim().length > 0) {
                                console.log('Successfully loaded CSV from:', url);
                                console.log('CSV content preview:', csvText.substring(0, 200));
                                return csvText;
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to load from:', url, e.message);
                        if (e.name === 'AbortError') {
                            console.warn('Request timed out for:', url);
                        }
                    }
                }

                console.warn('No CSV found, using sample data');
                return this.createSampleCSV();
            }

            createSampleCSV() {
                return `=== VERIFICA OBIETTIVI ===
Generale;79000;90000;;;20;25;;
LT;79000;82000;150000;55%;23;18;35;51%

=== CLIENTI PER PROVINCIA ===
LT;18;82000;;;;;;;
RM;2;8000;;;;;;;

=== VENDITE PER CLIENTE ===
LT;CENTRO EDILE DE GREGORIS SRL;MATTONE PIENO;9000
LT;ADDESSI COMMERCIALE SRL;MATTONE PIENO;8500
LT;D'URSO MAT.DA COSTRUZIONE;MATTONE PIENO;7200
LT;F.LLI TORA SRL;MATTONE PIENO;6800
LT;EDILIZIA SETINA S.R.L.;MATTONE PIENO;5500
LT;COMMERCIALE LATINA SNC;PAVIMENTAZIONE POLIS;4800
RM;ROMANO EDILIZIA SRL;MATTONE PIENO;4000
LT;MATERIALI COSTRUZIONI SRL;PAVIMENTAZIONE POLIS;4200
LT;FORNITURE EDILI LATINA;REFRATTARI RETTIFICATI;3500
RM;COSTRUZIONI CAPITOLINE;PAVIMENTAZIONE POLIS;3200

=== RIEPILOGO PER CATEGORIA ===
MATTONE PIENO;16;1;55000
PAVIMENTAZIONE POLIS;8;1;17000
REFRATTARI RETTIFICATI;5;0;8000
REFRATTARI;4;1;5500
FACCIAVISTA;2;0;4500
`;
            }

            buildCandidateUrls() {
                // Primary URLs - GitHub Raw (most reliable)
                const githubRawUrls = [
                    'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/631.00238_CARABOT-NATALINO.csv',
                    'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/refs/heads/main/docs/631.00238_CARABOT NATALINO.csv',
                    'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/main/docs/631.00238_CARABOT-NATALINO.csv',
                    'https://raw.githubusercontent.com/marketingcusimano/rete-commerciale-agenti/main/docs/631.00238_CARABOT NATALINO.csv'
                ];

                // Fallback URLs - GitHub Pages
                const { pathname, origin } = window.location;
                const segs = pathname.split('/').filter(Boolean);
                const repoSlug = segs.length ? segs[0] : '';

                const bases = [
                    './docs/',
                    'docs/',
                    '/docs/',
                    `/${repoSlug}/docs/`,
                    './',
                    '',
                    pathname.endsWith('/') ? pathname : pathname.replace(/[^/]*$/, ''),
                    repoSlug ? `/${repoSlug}/` : '/'
                ];

                const fallbackUrls = [];
                for (const base of bases) {
                    for (const name of this.csvFileNames) {
                        try {
                            fallbackUrls.push(new URL(base + name, origin).href);
                        } catch (e) {}
                    }
                }

                // Combine: GitHub Raw first (most reliable), then fallbacks
                const allUrls = [...githubRawUrls, ...fallbackUrls];
                console.log('Candidate URLs (GitHub Raw first):', [...new Set(allUrls)]);
                return [...new Set(allUrls)];
            }

            parseCSV(csvText) {
                try {
                    const data = {
                        generale: {},
                        latina: {},
                        roma: {},
                        clienti: [],
                        categorie: []
                    };

                    // Parse OBIETTIVI section
                    const obiettiviMatch = csvText.match(/=== VERIFICA OBIETTIVI ===([\s\S]*?)===.*===/);
                    if (obiettiviMatch) {
                        const obiettiviText = obiettiviMatch[1];
                        
                        // Parse GENERALE data
                        const generaleMatch = obiettiviText.match(/Generale;([\d.,]+);([\d.,]+);;;(\d+);(\d+);;/);
                        if (generaleMatch) {
                            data.generale = {
                                annoPrecedente: this.parseNumber(generaleMatch[1]),
                                annoCorrente: this.parseNumber(generaleMatch[2]),
                                clienti: parseInt(generaleMatch[3], 10),
                                obiettivoClienti: parseInt(generaleMatch[4], 10)
                            };
                        }

                        // Parse LATINA data
                        const ltMatch = obiettiviText.match(/LT;([\d.,]+);([\d.,]+);([\d.,]+);(\d+)%;(\d+);(\d+);(\d+);(\d+)%/);
                        if (ltMatch) {
                            data.latina = {
                                annoPrecedente: this.parseNumber(ltMatch[1]),
                                annoCorrente: this.parseNumber(ltMatch[2]),
                                obiettivo: this.parseNumber(ltMatch[3]),
                                percentualeObiettivo: parseInt(ltMatch[4], 10),
                                clientiPrecedenti: parseInt(ltMatch[5], 10),
                                clientiCorrente: parseInt(ltMatch[6], 10),
                                obiettivoClienti: parseInt(ltMatch[7], 10),
                                percentualeClienti: parseInt(ltMatch[8], 10)
                            };
                        }
                    }

                    // Parse ROMA data from CLIENTI PER PROVINCIA section
                    const clientiMatch = csvText.match(/=== CLIENTI PER PROVINCIA ===([\s\S]*?)===.*===/);
                    if (clientiMatch) {
                        const rmMatch = clientiMatch[1].match(/RM;(\d+);([\d.,]+);;;;;;/);
                        if (rmMatch) {
                            data.roma = {
                                clienti: parseInt(rmMatch[1], 10),
                                annoCorrente: this.parseNumber(rmMatch[2])
                            };
                        }
                    }

                    // Parse VENDITE PER CLIENTE section
                    const venditeMatch = csvText.match(/=== VENDITE PER CLIENTE ===([\s\S]*?)===.*===/);
                    if (venditeMatch) {
                        const venditeLines = venditeMatch[1].split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('===') && 
                            line.split(';').length >= 4
                        );
                        
                        venditeLines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                data.clienti.push({
                                    provincia: parts[0].trim(),
                                    cliente: parts[1].trim(),
                                    categoria: parts[2].trim(),
                                    fatturato: this.parseNumber(parts[3])
                                });
                            }
                        });
                    }

                    // Parse CATEGORIE data
                    const categorieMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===([\s\S]*?)$/);
                    if (categorieMatch) {
                        const categorieLines = categorieMatch[1].split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('===') && 
                            line.split(';').length >= 4
                        );
                        
                        categorieLines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                data.categorie.push({
                                    categoria: parts[0].trim(),
                                    clientiLT: parseInt(parts[1], 10) || 0,
                                    clientiRM: parseInt(parts[2], 10) || 0,
                                    fatturato: this.parseNumber(parts[3])
                                });
                            }
                        });
                    }

                    return data;
                    
                } catch (e) {
                    console.error('Parse error:', e);
                    return null;
                }
            }

            parseNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                return Number(String(input).replace(/\s+/g, '').replace(/€/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
            }

            formatEuroK(value) {
                if (!value) return '€0k';
                const k = Math.round(value / 1000);
                return `€${k}k`;
            }

            formatEuro(value) {
                if (!value) return '0 €';
                return `${Math.round(value).toLocaleString()} €`;
            }

            calculateGrowthPercentage(current, previous) {
                if (!previous) return '0.0';
                return (((current - previous) / previous) * 100).toFixed(1);
            }

            getDisplayData() {
                if (!this.csvData) return null;
                
                switch (this.selectedProvince) {
                    case 'all':
                        return {
                            fatturato: this.csvData.generale.annoCorrente,
                            fatturatoVs: this.csvData.generale.annoPrecedente,
                            clienti: this.csvData.generale.clienti,
                            clientiLT: this.csvData.latina.clientiCorrente,
                            clientiRM: this.csvData.roma.clienti,
                            obiettivo: this.csvData.latina.obiettivo,
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.generale.obiettivoClienti
                        };
                    case 'LT':
                        return {
                            fatturato: this.csvData.latina.annoCorrente,
                            fatturatoVs: this.csvData.latina.annoPrecedente,
                            clienti: this.csvData.latina.clientiCorrente,
                            clientiLT: this.csvData.latina.clientiCorrente,
                            clientiRM: 0,
                            obiettivo: this.csvData.latina.obiettivo,
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.latina.obiettivoClienti
                        };
                    case 'RM':
                        return {
                            fatturato: this.csvData.roma.annoCorrente,
                            fatturatoVs: 0,
                            clienti: this.csvData.roma.clienti,
                            clientiLT: 0,
                            clientiRM: this.csvData.roma.clienti,
                            obiettivo: null,
                            percentualeObiettivo: null,
                            obiettivoClienti: null
                        };
                    default:
                        return null;
                }
            }

            updateDashboard() {
                if (!this.csvData) return;

                const data = this.getDisplayData();
                if (!data) return;

                // Calculate growth
                const growthPercent = this.calculateGrowthPercentage(data.fatturato, data.fatturatoVs);
                
                // Update Fatturato Card
                document.getElementById('fatturato-value').textContent = this.formatEuroK(data.fatturato);
                document.getElementById('fatturato-vs').textContent = this.formatEuroK(data.fatturatoVs);
                document.getElementById('growth-badge').textContent = `+${growthPercent}%`;
                
                if (data.obiettivo) {
                    document.getElementById('obiettivo-fatturato').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('fatturato-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('fatturato-percentage').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Animate progress bar
                    setTimeout(() => {
                        document.getElementById('progress-fatturato').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 100);
                }

                // Update Obiettivo Card
                if (data.obiettivo) {
                    document.getElementById('obiettivo-value').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-percentage').textContent = `${data.percentualeObiettivo}%`;
                    document.getElementById('obiettivo-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-target').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-mancano').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-perc-display').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Update badge color
                    const badge = document.getElementById('obiettivo-badge');
                    if (data.percentualeObiettivo >= 80) {
                        badge.className = 'card-badge';
                    } else {
                        badge.className = 'card-badge warning';
                    }
                    
                    setTimeout(() => {
                        document.getElementById('progress-obiettivo').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 200);
                } else {
                    // Hide objective elements for provinces without targets
                    document.getElementById('obiettivo-value').textContent = 'N/A';
                    document.getElementById('obiettivo-percentage').textContent = 'N/A';
                    document.getElementById('progress-obiettivo').style.width = '0%';
                }

                // Update Clienti Card
                document.getElementById('clienti-count').textContent = data.clienti;
                document.getElementById('clienti-lt').textContent = data.clientiLT;
                document.getElementById('clienti-rm').textContent = data.clientiRM;
                
                if (data.obiettivoClienti) {
                    document.getElementById('clienti-target-value').textContent = data.obiettivoClienti;
                    const clientiPercentuale = Math.round((data.clienti / data.obiettivoClienti) * 100);
                    document.getElementById('clienti-mancanti').textContent = `${Math.max(0, data.obiettivoClienti - data.clienti)} clienti`;
                    document.getElementById('clienti-perc-display').textContent = `${clientiPercentuale}%`;
                    document.getElementById('clienti-percentage').textContent = clientiPercentuale;
                    
                    setTimeout(() => {
                        document.getElementById('progress-clienti').style.width = `${Math.min(100, clientiPercentuale)}%`;
                    }, 300);
                }

                // Update Province count
                const provinceUnique = new Set();
                if (this.csvData.latina.clientiCorrente > 0) provinceUnique.add('Latina');
                if (this.csvData.roma.clienti > 0) provinceUnique.add('Roma');
                document.getElementById('province-count').textContent = provinceUnique.size;
                document.getElementById('province-list').textContent = Array.from(provinceUnique).join(' • ');

                // Update other components
                this.updateProvinceDisplays();
                this.updateTables();
                this.updateMixProdotti();
                this.createAllCharts();
            }

            updateProvinceDisplays() {
                const data = this.csvData;
                
                // Update Clienti displays
                document.getElementById('lt-clienti-count').textContent = `${data.latina.clientiCorrente} clienti`;
                document.getElementById('rm-clienti-count').textContent = `${data.roma.clienti} clienti`;

                // Calculate client growth for LT
                const ltClientGrowth = data.latina.clientiPrecedenti > 0 ? 
                    this.calculateGrowthPercentage(data.latina.clientiCorrente, data.latina.clientiPrecedenti) : '0.0';
                
                // Update growth badges for clients
                const ltGrowthEl = document.getElementById('lt-growth');
                if (parseFloat(ltClientGrowth) >= 0) {
                    ltGrowthEl.textContent = `+${ltClientGrowth}%`;
                    ltGrowthEl.style.background = '#f0fdf4';
                    ltGrowthEl.style.color = '#16a34a';
                } else {
                    ltGrowthEl.textContent = `${ltClientGrowth}%`;
                    ltGrowthEl.style.background = '#fef2f2';
                    ltGrowthEl.style.color = '#dc2626';
                }

                // RM is new, so always positive
                document.getElementById('rm-growth').textContent = data.roma.clienti > 0 ? '+∞%' : '0%';

                // Update Fatturato displays
                document.getElementById('lt-fatturato-display').textContent = this.formatEuroK(data.latina.annoCorrente);
                document.getElementById('lt-fatturato-prev').textContent = this.formatEuroK(data.latina.annoPrecedente);
                document.getElementById('rm-fatturato-display').textContent = this.formatEuroK(data.roma.annoCorrente);

                // Update fatturato growth
                const ltFatturatoGrowth = this.calculateGrowthPercentage(data.latina.annoCorrente, data.latina.annoPrecedente);
                document.getElementById('lt-fatturato-growth').textContent = `+${ltFatturatoGrowth}%`;
            }

            updateTables() {
                const data = this.csvData;

                // Filter clients based on selected province
                let filteredClienti = [...data.clienti];
                if (this.selectedProvince === 'LT') {
                    filteredClienti = data.clienti.filter(c => c.provincia === 'LT');
                } else if (this.selectedProvince === 'RM') {
                    filteredClienti = data.clienti.filter(c => c.provincia === 'RM');
                }

                // Update Top 10 clients table
                const tbody = document.getElementById('vendite-tbody');
                tbody.innerHTML = '';
                
                const sortedClienti = [...filteredClienti].sort((a, b) => b.fatturato - a.fatturato);
                let totalTop10 = 0;

                sortedClienti.forEach((cliente, index) => {
                    if (index < 10) {
                        totalTop10 += cliente.fatturato;
                        const row = document.createElement('tr');
                        row.style.borderBottom = '1px solid rgba(107, 114, 128, 0.05)';
                        row.innerHTML = `
                            <td style="padding: 0.75rem 1rem;"><span class="province-badge ${cliente.provincia}">${cliente.provincia}</span></td>
                            <td style="padding: 0.75rem 1rem;">${cliente.cliente}</td>
                            <td style="padding: 0.75rem 1rem;">${cliente.categoria}</td>
                            <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 700;">${this.formatEuroK(cliente.fatturato)}</td>
                        `;
                        tbody.appendChild(row);
                    }
                });

                document.getElementById('top-clienti-count').textContent = Math.min(10, sortedClienti.length);
                document.getElementById('top-fatturato-total').textContent = this.formatEuroK(totalTop10);

                // Filter categories based on selected province
                let filteredCategorie = [...data.categorie];
                if (this.selectedProvince === 'LT') {
                    filteredCategorie = data.categorie.map(cat => ({
                        ...cat,
                        clientiRM: 0,
                        fatturato: Math.round(cat.fatturato * (cat.clientiLT / (cat.clientiLT + cat.clientiRM || 1)))
                    }));
                } else if (this.selectedProvince === 'RM') {
                    filteredCategorie = data.categorie.map(cat => ({
                        ...cat,
                        clientiLT: 0,
                        fatturato: Math.round(cat.fatturato * (cat.clientiRM / (cat.clientiLT + cat.clientiRM || 1)))
                    })).filter(cat => cat.clientiRM > 0);
                }

                // Update category table
                const catTbody = document.getElementById('categoria-tbody');
                catTbody.innerHTML = '';
                
                const totalFatturato = filteredCategorie.reduce((sum, cat) => sum + cat.fatturato, 0);

                filteredCategorie.forEach(categoria => {
                    const percentage = totalFatturato > 0 ? ((categoria.fatturato / totalFatturato) * 100).toFixed(1) : '0.0';
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(107, 114, 128, 0.05)';
                    row.innerHTML = `
                        <td style="padding: 0.75rem 1rem; font-weight: 600;">${categoria.categoria}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${categoria.clientiLT}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${categoria.clientiRM}</td>
                        <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 700;">${this.formatEuroK(categoria.fatturato)}</td>
                        <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 600; color: #3b82f6;">${percentage}%</td>
                    `;
                    catTbody.appendChild(row);
                });

                document.getElementById('categoria-totale').textContent = this.formatEuroK(totalFatturato);
            }

            updateMixProdotti() {
                const data = this.csvData;
                
                // Filter categories based on selected province
                let activeCategorie = [...data.categorie];
                if (this.selectedProvince === 'LT') {
                    activeCategorie = data.categorie.map(cat => ({
                        ...cat,
                        fatturato: Math.round(cat.fatturato * (cat.clientiLT / (cat.clientiLT + cat.clientiRM || 1)))
                    }));
                } else if (this.selectedProvince === 'RM') {
                    activeCategorie = data.categorie.map(cat => ({
                        ...cat,
                        fatturato: Math.round(cat.fatturato * (cat.clientiRM / (cat.clientiLT + cat.clientiRM || 1)))
                    })).filter(cat => cat.clientiRM > 0);
                }
                
                // Calculate mix based on categories
                let mattone = 0, pavimentazione = 0, refrattari = 0, altri = 0;

                activeCategorie.forEach(cat => {
                    const nome = cat.categoria.toLowerCase();
                    if (nome.includes('mattone') || nome.includes('laterizio')) {
                        mattone += cat.fatturato;
                    } else if (nome.includes('paviment') || nome.includes('cotto') || nome.includes('polis')) {
                        pavimentazione += cat.fatturato;
                    } else if (nome.includes('refratt')) {
                        refrattari += cat.fatturato;
                    } else {
                        altri += cat.fatturato;
                    }
                });

                const total = mattone + pavimentazione + refrattari + altri;
                const coreAmount = mattone + pavimentazione;
                const otherAmount = refrattari + altri;

                if (total > 0) {
                    const corePercentage = ((coreAmount / total) * 100).toFixed(1);
                    const otherPercentage = ((otherAmount / total) * 100).toFixed(1);

                    document.getElementById('core-percentage').textContent = `${corePercentage}%`;
                    document.getElementById('core-amount').textContent = this.formatEuroK(coreAmount);
                    document.getElementById('other-percentage').textContent = `${otherPercentage}%`;
                    document.getElementById('other-amount').textContent = this.formatEuroK(otherAmount);

                    document.getElementById('mattone-amount').textContent = this.formatEuroK(mattone);
                    document.getElementById('pavimentazione-amount').textContent = this.formatEuroK(pavimentazione);
                    document.getElementById('refrattari-amount').textContent = this.formatEuroK(refrattari);
                    document.getElementById('altri-amount').textContent = this.formatEuroK(altri);

                    document.getElementById('core-perf').textContent = `${corePercentage}%`;
                    document.getElementById('categories-count').textContent = activeCategorie.filter(c => c.fatturato > 0).length;
                    
                    // Calculate involved clients based on filter
                    let involvedClients = 0;
                    if (this.selectedProvince === 'all') {
                        involvedClients = this.csvData.generale.clienti;
                    } else if (this.selectedProvince === 'LT') {
                        involvedClients = this.csvData.latina.clientiCorrente;
                    } else if (this.selectedProvince === 'RM') {
                        involvedClients = this.csvData.roma.clienti;
                    }
                    document.getElementById('involved-clients').textContent = involvedClients;
                }
            }

            createAllCharts() {
                // Destroy existing charts
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};

                // Create new charts
                this.createClientiChart();
                this.createFatturatoChart();
                this.createMixProdottiChart();
            }

            createClientiChart() {
                const ctx = document.getElementById('clientiChart');
                if (!ctx) return;

                const data = this.csvData;

                this.charts.clienti = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            {
                                label: '2024',
                                data: [data.latina.clientiPrecedenti, 0],
                                backgroundColor: '#cbd5e1',
                                borderRadius: 8,
                                maxBarThickness: 60
                            },
                            {
                                label: '2025',
                                data: [data.latina.clientiCorrente, data.roma.clienti],
                                backgroundColor: ['#22d3ee', '#22d3ee'],
                                borderRadius: 8,
                                maxBarThickness: 60
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.raw} clienti`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#6b7280' },
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                ticks: { color: '#6b7280', font: { size: 12, weight: '600' } },
                                grid: { display: false }
                            }
                        },
                        animation: { duration: 1500, easing: 'easeOutBounce' }
                    }
                });
            }

            createFatturatoChart() {
                const ctx = document.getElementById('fatturatoChart');
                if (!ctx) return;

                const data = this.csvData;

                this.charts.fatturato = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            {
                                label: '2024',
                                data: [data.latina.annoPrecedente, 0],
                                backgroundColor: '#cbd5e1',
                                borderRadius: 8,
                                maxBarThickness: 80
                            },
                            {
                                label: '2025',
                                data: [data.latina.annoCorrente, data.roma.annoCorrente],
                                backgroundColor: ['#8b5cf6', '#6366f1'],
                                borderRadius: 8,
                                maxBarThickness: 80
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${this.formatEuroK(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatEuroK(value),
                                    color: '#6b7280'
                                },
                                grid: { color: '#e5e7eb' }
                            },
                            x: {
                                ticks: { color: '#6b7280', font: { size: 12, weight: '600' } },
                                grid: { display: false }
                            }
                        },
                        animation: { duration: 2000, easing: 'easeOutQuart' }
                    }
                });
            }

            createMixProdottiChart() {
                const ctx = document.getElementById('mixProdottiChart');
                if (!ctx) return;

                const data = this.csvData;
                
                // Filter categories based on selected province
                let activeCategorie = [...data.categorie];
                if (this.selectedProvince === 'LT') {
                    activeCategorie = data.categorie.map(cat => ({
                        ...cat,
                        fatturato: Math.round(cat.fatturato * (cat.clientiLT / (cat.clientiLT + cat.clientiRM || 1)))
                    }));
                } else if (this.selectedProvince === 'RM') {
                    activeCategorie = data.categorie.map(cat => ({
                        ...cat,
                        fatturato: Math.round(cat.fatturato * (cat.clientiRM / (cat.clientiLT + cat.clientiRM || 1)))
                    })).filter(cat => cat.clientiRM > 0);
                }
                
                // Calculate mix from categories
                let mattone = 0, pavimentazione = 0, refrattari = 0, altri = 0;

                activeCategorie.forEach(cat => {
                    const nome = cat.categoria.toLowerCase();
                    if (nome.includes('mattone') || nome.includes('laterizio')) {
                        mattone += cat.fatturato;
                    } else if (nome.includes('paviment') || nome.includes('cotto') || nome.includes('polis')) {
                        pavimentazione += cat.fatturato;
                    } else if (nome.includes('refratt')) {
                        refrattari += cat.fatturato;
                    } else {
                        altri += cat.fatturato;
                    }
                });

                const coreAmount = mattone + pavimentazione;
                const otherAmount = refrattari + altri;

                this.charts.mixProdotti = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mattone + Pavimentazione', 'Altri Prodotti'],
                        datasets: [{
                            data: [coreAmount, otherAmount],
                            backgroundColor: ['#3b82f6', '#6b7280'],
                            borderColor: ['#1e40af', '#4b5563'],
                            borderWidth: 3,
                            cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuroK(context.raw);
                                        const total = coreAmount + otherAmount;
                                        const percentage = total > 0 ? 
                                            ((context.raw / total) * 100).toFixed(1) : '0';
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: { duration: 2000, easing: 'easeOutBounce' }
                    }
                });
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new Dashboard();
        });
    </script>
</body>
</html>
