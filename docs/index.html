<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard CARABOT NATALINO - Performance Analytics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ==================== VARIABLES & BASE ==================== */
        :root {
          --primary-blue: #3b82f6;
          --primary-violet: #8b5cf6;
          --primary-cyan: #22d3ee;
          --primary-emerald: #10b981;
          --text-primary: #1f2937;
          --text-secondary: #6b7280;
          --bg-primary: #f8fafc;
          --bg-card: rgba(255, 255, 255, 0.95);
          --border-color: rgba(255, 255, 255, 0.9);
          --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
          --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        [class*="dark-mode"] {
          --text-primary: #f9fafb;
          --text-secondary: #9ca3af;
          --bg-primary: #0f172a;
          --bg-card: rgba(30, 41, 59, 0.9);
          --border-color: rgba(51, 65, 85, 0.6);
          --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
          --gradient-primary: linear-gradient(135deg, #1e293b 0%, #581c87 50%, #0f172a 100%);
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          min-height: 100vh;
          transition: all 0.5s ease;
          overflow-x: hidden;
        }

        .light-mode {
          background: var(--gradient-primary);
          color: var(--text-primary);
        }

        .dark-mode {
          background: var(--gradient-primary);
          color: var(--text-primary);
        }

        /* Animated background particles */
        .bg-particles {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: -1;
        }

        .particle {
          position: absolute;
          width: 4px;
          height: 4px;
          background: rgba(255, 255, 255, 0.1);
          border-radius: 50%;
          animation: float 20s infinite linear;
        }

        @keyframes float {
          0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
          10% { opacity: 1; }
          90% { opacity: 1; }
          100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        #dashboard-container {
          max-width: 1600px;
          margin: 0 auto;
          padding: 1.5rem;
          position: relative;
        }

        /* ==================== HEADER ==================== */
        .dashboard-header {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          margin-bottom: 2rem;
          overflow: hidden;
          position: relative;
        }

        .dashboard-header::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 4px;
          background: linear-gradient(90deg, var(--primary-blue), var(--primary-violet), var(--primary-cyan), var(--primary-emerald));
          animation: gradient-shift 3s ease-in-out infinite;
        }

        @keyframes gradient-shift {
          0%, 100% { transform: translateX(-100%); }
          50% { transform: translateX(100%); }
        }

        .header-content {
          padding: 2.5rem;
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          flex-wrap: wrap;
          gap: 2rem;
        }

        .agent-info h1 {
          font-size: 3rem;
          font-weight: 900;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-violet));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 0.5rem;
          animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
          from { filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.3)); }
          to { filter: drop-shadow(0 0 30px rgba(139, 92, 246, 0.5)); }
        }

        .agent-info p {
          color: var(--text-secondary);
          font-size: 1.25rem;
          font-weight: 500;
        }

        .header-controls {
          display: flex;
          gap: 1rem;
        }

        .control-btn {
          padding: 1rem;
          border-radius: 1rem;
          border: none;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-violet));
          color: white;
          cursor: pointer;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          font-size: 1.25rem;
          position: relative;
          overflow: hidden;
        }

        .control-btn::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
          transition: left 0.5s;
        }

        .control-btn:hover {
          transform: scale(1.1) rotate(5deg);
          box-shadow: 0 20px 40px rgba(59, 130, 246, 0.4);
        }

        .control-btn:hover::before {
          left: 100%;
        }

        .spinning {
          animation: spin-3d 1s linear infinite;
        }

        @keyframes spin-3d {
          0% { transform: rotateY(0deg); }
          100% { transform: rotateY(360deg); }
        }

        .status-info {
          padding: 0 2.5rem 2rem;
          display: flex;
          flex-wrap: wrap;
          gap: 2rem;
          align-items: center;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          font-size: 1rem;
          font-weight: 500;
          padding: 0.75rem 1.25rem;
          background: rgba(59, 130, 246, 0.1);
          border-radius: 1rem;
          backdrop-filter: blur(10px);
        }

        .status-dot {
          width: 12px;
          height: 12px;
          border-radius: 50%;
          position: relative;
        }

        .status-dot::after {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          transform: translate(-50%, -50%);
          animation: pulse-ring 2s infinite;
        }

        .status-dot.online { background: #10b981; }
        .status-dot.online::after { background: rgba(16, 185, 129, 0.3); }
        .status-dot.offline { background: #ef4444; }
        .status-dot.offline::after { background: rgba(239, 68, 68, 0.3); }
        .status-dot.updating { background: var(--primary-blue); }
        .status-dot.updating::after { background: rgba(59, 130, 246, 0.3); }

        @keyframes pulse-ring {
          0% { transform: translate(-50%, -50%) scale(0.8); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }

        /* ==================== CHARTS SECTION ==================== */
        .charts-hero {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          margin-bottom: 2rem;
          overflow: hidden;
          position: relative;
        }

        .charts-hero::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                      radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
          pointer-events: none;
        }

        .charts-header {
          padding: 2.5rem 2.5rem 1.5rem;
          text-align: center;
          position: relative;
          z-index: 1;
        }

        .charts-title {
          font-size: 2.5rem;
          font-weight: 800;
          background: linear-gradient(135deg, var(--primary-emerald), var(--primary-cyan));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 1rem;
        }

        .charts-subtitle {
          font-size: 1.25rem;
          color: var(--text-secondary);
          margin-bottom: 2rem;
        }

        .charts-grid {
          padding: 0 2.5rem 2.5rem;
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
          gap: 2rem;
          position: relative;
          z-index: 1;
        }

        .chart-card {
          background: rgba(255, 255, 255, 0.08);
          backdrop-filter: blur(20px);
          border-radius: 1.5rem;
          border: 1px solid rgba(255, 255, 255, 0.2);
          padding: 2rem;
          position: relative;
          overflow: hidden;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .chart-card::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: conic-gradient(transparent, rgba(59, 130, 246, 0.1), transparent 30%);
          animation: rotate 20s linear infinite;
          z-index: -1;
        }

        @keyframes rotate {
          100% { transform: rotate(360deg); }
        }

        .chart-card:hover {
          transform: translateY(-10px);
          box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
        }

        .chart-header {
          display: flex;
          align-items: center;
          gap: 1rem;
          margin-bottom: 2rem;
        }

        .chart-icon {
          width: 50px;
          height: 50px;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-violet));
          border-radius: 1rem;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5rem;
          color: white;
          box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }

        .chart-title {
          font-size: 1.25rem;
          font-weight: 700;
          color: var(--text-primary);
        }

        .chart-container {
          position: relative;
          height: 350px;
          width: 100%;
        }

        /* ==================== KPI SECTION ==================== */
        .kpi-section {
          margin-bottom: 2rem;
        }

        .kpi-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
          gap: 2rem;
        }

        .kpi-card {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          padding: 2.5rem;
          position: relative;
          overflow: hidden;
          transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .kpi-card::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          height: 6px;
          background: linear-gradient(90deg, var(--primary-blue), var(--primary-violet), var(--primary-cyan));
          opacity: 0;
          transition: opacity 0.4s ease;
        }

        .kpi-card:hover {
          transform: translateY(-15px) scale(1.02);
          box-shadow: 0 50px 100px rgba(0, 0, 0, 0.3);
        }

        .kpi-card:hover::before {
          opacity: 1;
        }

        .kpi-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1.5rem;
        }

        .kpi-info .kpi-label {
          color: var(--text-secondary);
          font-size: 1rem;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.1em;
          margin-bottom: 1rem;
        }

        .kpi-value {
          font-size: 3.5rem;
          font-weight: 900;
          color: var(--text-primary);
          line-height: 1;
          background: linear-gradient(135deg, var(--primary-blue), var(--primary-violet));
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          filter: drop-shadow(0 4px 20px rgba(59, 130, 246, 0.3));
          transition: all 0.5s ease;
        }

        .kpi-badge {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          padding: 0.75rem 1rem;
          border-radius: 1rem;
          background: rgba(16, 185, 129, 0.15);
          color: #10b981;
          font-size: 1rem;
          font-weight: 700;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .progress-container {
          margin: 2rem 0;
        }

        .progress-bar {
          width: 100%;
          height: 12px;
          background: rgba(107, 114, 128, 0.2);
          border-radius: 1rem;
          overflow: hidden;
          position: relative;
        }

        .progress-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary-emerald), #34d399);
          border-radius: 1rem;
          transition: width 2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          position: relative;
          overflow: hidden;
        }

        .progress-fill::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
          animation: progress-shine 2s infinite;
        }

        @keyframes progress-shine {
          0% { left: -100%; }
          100% { left: 100%; }
        }

        /* ==================== TABLE SECTION ==================== */
        .table-section {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          padding: 2.5rem;
          position: relative;
          overflow: hidden;
        }

        .table-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .table-title {
          font-size: 2rem;
          font-weight: 800;
          color: var(--text-primary);
          display: flex;
          align-items: center;
          gap: 1rem;
        }

        .table-icon {
          width: 45px;
          height: 45px;
          background: linear-gradient(135deg, var(--primary-cyan), var(--primary-emerald));
          border-radius: 1rem;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.25rem;
          color: white;
        }

        .enhanced-table {
          width: 100%;
          border-collapse: separate;
          border-spacing: 0;
          background: transparent;
          border-radius: 1rem;
          overflow: hidden;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .enhanced-table th {
          background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
          color: var(--text-primary);
          padding: 1.25rem;
          text-align: left;
          font-weight: 700;
          font-size: 0.9rem;
          text-transform: uppercase;
          letter-spacing: 0.1em;
          border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .enhanced-table td {
          padding: 1.25rem;
          background: rgba(255, 255, 255, 0.05);
          border-bottom: 1px solid rgba(255, 255, 255, 0.05);
          transition: all 0.3s ease;
          font-weight: 500;
        }

        .enhanced-table tr:hover td {
          background: rgba(59, 130, 246, 0.1);
          transform: scale(1.01);
        }

        .province-badge {
          display: inline-flex;
          align-items: center;
          padding: 0.5rem 1rem;
          border-radius: 1rem;
          font-size: 0.8rem;
          font-weight: 700;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        .province-badge.LT {
          background: rgba(139, 92, 246, 0.2);
          color: #8b5cf6;
          border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .province-badge.RM {
          background: rgba(34, 211, 238, 0.2);
          color: #22d3ee;
          border: 1px solid rgba(34, 211, 238, 0.3);
        }

        /* ==================== LOADING & ERROR STATES ==================== */
        .loading-container, .error-container {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          padding: 4rem;
          text-align: center;
          margin-bottom: 2rem;
          position: relative;
          overflow: hidden;
        }

        .loading-container::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
          animation: loading-sweep 2s infinite;
        }

        @keyframes loading-sweep {
          0% { left: -100%; }
          100% { left: 100%; }
        }

        .loading-spinner {
          font-size: 3rem;
          color: var(--primary-blue);
          margin-bottom: 2rem;
          animation: spin-pulse 2s ease-in-out infinite;
        }

        @keyframes spin-pulse {
          0%, 100% { transform: rotate(0deg) scale(1); }
          50% { transform: rotate(180deg) scale(1.2); }
        }

        /* ==================== POPUP ==================== */
        .popup-overlay {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.8);
          backdrop-filter: blur(10px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 1000;
          padding: 1rem;
          opacity: 0;
          transition: opacity 0.3s ease;
        }

        .popup-overlay.show {
          opacity: 1;
        }

        .popup-content {
          background: var(--bg-card);
          backdrop-filter: blur(30px);
          border-radius: 2rem;
          border: 1px solid var(--border-color);
          box-shadow: var(--shadow);
          width: 100%;
          max-width: 500px;
          transform: scale(0.9);
          transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .popup-overlay.show .popup-content {
          transform: scale(1);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
          .charts-grid {
            grid-template-columns: 1fr;
          }
          
          .chart-container {
            height: 300px;
          }
          
          .kpi-grid {
            grid-template-columns: 1fr;
          }
          
          .agent-info h1 {
            font-size: 2.5rem;
          }
          
          .kpi-value {
            font-size: 2.5rem;
          }
        }
    </style>
</head>
<body class="light-mode">
    <!-- Animated Background Particles -->
    <div class="bg-particles" id="particles"></div>

    <div id="dashboard-container">
        
        <!-- HEADER -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="agent-info">
                    <h1>CARABOT NATALINO</h1>
                    <p>Performance Analytics Dashboard - Real-time CSV Data</p>
                </div>
                
                <div class="header-controls">
                    <button id="refresh-btn" class="control-btn" title="Refresh Data">
                        <i class="fas fa-sync-alt" id="refresh-icon"></i>
                    </button>
                    <button id="theme-toggle" class="control-btn" title="Toggle Theme">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    <button id="province-filter" class="control-btn" title="Filter by Province">
                        <i class="fas fa-map-marker-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="status-info">
                <div class="status-item">
                    <i class="fas fa-id-card"></i>
                    <span><strong>ID:</strong> 631.00238</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-calendar"></i>
                    <span>Gen - Ago 2025</span>
                </div>
                <div class="status-item">
                    <div class="status-dot offline" id="connection-dot"></div>
                    <span id="connection-status">Connecting...</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span>Last: <span id="last-update">Never</span></span>
                </div>
                <div class="status-badge" id="status-badge">
                    ðŸ”„ Loading real data...
                </div>
            </div>
        </header>

        <!-- LOADING STATE -->
        <div id="loading-state" class="loading-container">
            <div class="loading-content">
                <i class="fas fa-sync-alt loading-spinner"></i>
                <h2>Loading Real Data from GitHub CSV...</h2>
                <p>Connecting to live data source</p>
            </div>
        </div>

        <!-- ERROR STATE -->
        <div id="error-state" class="error-container" style="display: none;">
            <div class="error-content">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ef4444; margin-bottom: 1rem;"></i>
                <h2>Connection Error</h2>
                <p id="error-message"></p>
                <button class="control-btn" onclick="window.dashboard?.fetchCSVData(true)" style="margin-top: 1rem;">
                    <i class="fas fa-redo"></i> Retry
                </button>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div id="main-content" style="display: none;">
            
            <!-- KPI SECTION -->
            <div class="kpi-section">
                <div class="kpi-grid">
                    
                    <!-- Fatturato Card -->
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-info">
                                <p class="kpi-label">Fatturato 2025</p>
                                <p class="kpi-value" id="fatturato-value">â‚¬0k</p>
                            </div>
                            <div class="kpi-badge">
                                <i class="fas fa-arrow-up"></i>
                                <span id="growth-value">+0%</span>
                            </div>
                        </div>
                        <div class="kpi-footer" style="color: var(--text-secondary); font-size: 1rem;">
                            <span>vs 2024: </span>
                            <span id="previous-value" style="font-weight: 700;">â‚¬0k</span>
                        </div>
                    </div>

                    <!-- Obiettivo Card -->
                    <div class="kpi-card" id="obiettivo-card" style="display: none;">
                        <div class="kpi-header">
                            <div class="kpi-info">
                                <p class="kpi-label">Target 2025</p>
                                <p class="kpi-value" id="obiettivo-value">â‚¬0k</p>
                            </div>
                            <div class="kpi-badge" style="background: rgba(34, 211, 238, 0.15); color: #22d3ee;">
                                <span id="obiettivo-percentage">0%</span>
                            </div>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill"></div>
                            </div>
                        </div>
                        <div class="kpi-footer" style="color: var(--text-secondary); font-size: 1rem;">
                            <span>Remaining: </span>
                            <span id="remaining-value" style="font-weight: 700;">â‚¬0k</span>
                        </div>
                    </div>

                    <!-- Clienti Card -->
                    <div class="kpi-card">
                        <div class="kpi-header">
                            <div class="kpi-info">
                                <p class="kpi-label">Active Clients</p>
                                <p class="kpi-value" id="clienti-value">0</p>
                            </div>
                            <div class="kpi-badge" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6;">
                                <span id="provincia-label">TOT</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CHARTS HERO SECTION -->
            <div class="charts-hero">
                <div class="charts-header">
                    <h2 class="charts-title">Sales Analytics</h2>
                    <p class="charts-subtitle">Real-time performance insights from your CSV data</p>
                </div>
                
                <div class="charts-grid">
                    <!-- Province Distribution -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-map-marked-alt"></i>
                            </div>
                            <h3 class="chart-title">Revenue by Province</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="provinceChart"></canvas>
                        </div>
                    </div>

                    <!-- Target Progress -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-bullseye"></i>
                            </div>
                            <h3 class="chart-title">Target Achievement</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>

                    <!-- Product Categories -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <h3 class="chart-title">Product Categories</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>

                    <!-- Top Clients -->
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <h3 class="chart-title">Top 5 Clients</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="topClientsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABLE SECTION -->
            <div class="table-section">
                <div class="table-header">
                    <div class="table-title">
                        <div class="table-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        Top Client Sales (Live CSV Data)
                    </div>
                    <div class="status-badge success" id="table-status-badge">
                        <i class="fas fa-check-circle"></i>
                        <span>Live Data</span>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="enhanced-table">
                        <thead>
                            <tr>
                                <th>Province</th>
                                <th>Client</th>
                                <th>Category</th>
                                <th style="text-align: right;">Revenue</th>
                            </tr>
                        </thead>
                        <tbody id="vendite-tbody">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-blue);" id="total-clients">0</div>
                        <div style="color: var(--text-secondary);">Top Clients</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-emerald);" id="total-top-revenue">â‚¬0k</div>
                        <div style="color: var(--text-secondary);">Top Revenue</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-violet);" id="update-status-icon">â³</div>
                        <div style="color: var(--text-secondary);">Status</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-cyan);">2min</div>
                        <div style="color: var(--text-secondary);">Auto Update</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROVINCE FILTER POPUP -->
        <div id="province-popup" class="popup-overlay">
            <div class="popup-content">
                <div style="padding: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">Select Province</h3>
                    <p style="color: var(--text-secondary);">Filter data by territory</p>
                </div>
                
                <div style="padding: 2rem; max-height: 60vh; overflow-y: auto;" id="popup-options">
                    <!-- Populated by JavaScript -->
                </div>
                
                <div style="padding: 1.5rem 2rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <div class="status-dot online" id="popup-status-dot"></div>
                        <span id="popup-status-text">CSV data auto-updated</span>
                    </div>
                    <button id="close-popup" class="control-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Create animated particles background
        function createParticles() {
            const container = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                container.appendChild(particle);
            }
        }

        // Initialize particles on load
        createParticles();

        // Enhanced Dashboard Manager with Charts
        class DashboardManager {
            constructor() {
                this.csvData = null;
                this.selectedProvince = 'all';
                this.isLoading = false;
                this.lastUpdate = null;
                this.updateInterval = null;
                this.charts = {};

                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv'
                ];

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadInitialData();
                this.startAutoUpdate();
                this.initAnimations();
            }

            initAnimations() {
                // Animate elements on load
                gsap.from('.kpi-card', {
                    duration: 1,
                    y: 50,
                    opacity: 0,
                    stagger: 0.2,
                    ease: "back.out(1.7)"
                });
                
                gsap.from('.chart-card', {
                    duration: 1.2,
                    scale: 0.8,
                    opacity: 0,
                    stagger: 0.15,
                    delay: 0.5,
                    ease: "back.out(1.7)"
                });
            }

            setupEventListeners() {
                const byId = (id) => document.getElementById(id);

                const refreshBtn = byId('refresh-btn');
                if (refreshBtn) refreshBtn.addEventListener('click', () => this.fetchCSVData(true));

                const themeToggle = byId('theme-toggle');
                if (themeToggle) themeToggle.addEventListener('click', () => this.toggleTheme());

                const provinceFilter = byId('province-filter');
                if (provinceFilter) provinceFilter.addEventListener('click', () => this.showProvincePopup());

                const closePopup = byId('close-popup');
                if (closePopup) closePopup.addEventListener('click', () => this.hideProvincePopup());

                const provincePopup = byId('province-popup');
                if (provincePopup) {
                    provincePopup.addEventListener('click', (e) => {
                        if (e.target === provincePopup) this.hideProvincePopup();
                    });
                }
            }

            toggleTheme() {
                const body = document.body;
                const themeIcon = document.getElementById('theme-icon');
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    if (themeIcon) themeIcon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    if (themeIcon) themeIcon.className = 'fas fa-moon';
                }
            }

            async loadInitialData() { 
                await this.fetchCSVData(); 
            }

            buildCandidateUrls() {
                const { pathname, origin } = window.location;
                const segs = pathname.split('/').filter(Boolean);
                const repoSlug = segs.length ? segs[0] : '';

                const bases = new Set([
                    './',
                    '',
                    pathname.endsWith('/') ? pathname : pathname.replace(/[^/]*$/, ''),
                    repoSlug ? `/${repoSlug}/` : '/',
                    repoSlug ? `/${repoSlug}/docs/` : '/docs/'
                ]);

                const urls = [];
                for (const base of bases) {
                    for (const name of this.csvFileNames) {
                        try {
                            const abs = new URL(base + name, origin).href;
                            urls.push(abs);
                        } catch { /* ignore */ }
                    }
                }
                return Array.from(new Set(urls));
            }

            async fetchCSVData(isManual = false) {
                if (this.isLoading) return;

                this.isLoading = true;
                this.updateLoadingState('updating');

                try {
                    const cacheBuster = `?t=${Date.now()}&r=${Math.random()}`;
                    const candidates = this.buildCandidateUrls();
                    let lastError = null;
                    let text = null;

                    console.log('ðŸ”Ž CSV candidate URLs:', candidates);

                    for (const url of candidates) {
                        const u = url + cacheBuster;
                        try {
                            console.log('â†—ï¸ GET', u);
                            const res = await fetch(u, {
                                method: 'GET',
                                cache: 'no-cache',
                                headers: {
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache'
                                }
                            });
                            if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                            const t = await res.text();
                            if (t && t.trim().length > 0) { text = t; break; }
                            lastError = new Error('CSV empty');
                        } catch (e) {
                            console.warn('âš ï¸ Failed', u, e);
                            lastError = e;
                        }
                    }

                    if (!text) throw lastError || new Error('Cannot read CSV');

                    console.log('âœ… CSV loaded, length:', text.length);

                    const parsedData = this.parseCSV(text);
                    if (!parsedData) throw new Error('CSV parsing failed');

                    this.csvData = parsedData;
                    this.lastUpdate = new Date();
                    this.updateLoadingState('success');
                    this.renderDashboard();

                } catch (error) {
                    console.error('âŒ CSV fetch error:', error);
                    this.updateLoadingState('error', error?.message || 'Unknown error');
                } finally {
                    this.isLoading = false;
                }
            }

            parseCSV(csvText) {
                try {
                    const obiettiviMatch = csvText.match(/=== VERIFICA OBIETTIVI ===([\s\S]*?)===.*===/);
                    if (!obiettiviMatch) throw new Error('Objectives section not found');
                    const obiettiviText = obiettiviMatch[1];

                    const generaleMatch = obiettiviText.match(/Generale;([\d.,]+);([\d.,]+);;;(\d+);(\d+);;/);
                    if (!generaleMatch) throw new Error('General data not found');
                    const generale = {
                        annoPrecedente: this.parseNumber(generaleMatch[1]),
                        annoCorrente: this.parseNumber(generaleMatch[2]),
                        clienti: parseInt(generaleMatch[4], 10)
                    };

                    const ltMatch = obiettiviText.match(/LT;([\d.,]+);([\d.,]+);([\d.,]+);(\d+)%;(\d+);(\d+);(\d+);(\d+)%/);
                    if (!ltMatch) throw new Error('Latina data not found');
                    const latinaObiettivoRaw = this.parseNumber(ltMatch[3]);
                    const latina = {
                        annoPrecedente: this.parseNumber(ltMatch[1]),
                        annoCorrente: this.parseNumber(ltMatch[2]),
                        obiettivo: latinaObiettivoRaw * 1000,
                        percentualeObiettivo: parseInt(ltMatch[4], 10),
                        clientiPrecedenti: parseInt(ltMatch[5], 10),
                        clientiCorrente: parseInt(ltMatch[6], 10),
                        obiettivoClienti: parseInt(ltMatch[7], 10)
                    };

                    const clientiMatch = csvText.match(/=== CLIENTI PER PROVINCIA ===([\s\S]*?)===.*===/);
                    let roma = { annoCorrente: 0, clienti: 0 };
                    if (clientiMatch) {
                        const clientiText = clientiMatch[1];
                        const rmMatch = clientiText.match(/RM;(\d+);([\d.,]+);;;;;;/);
                        if (rmMatch) {
                            roma = {
                                annoCorrente: this.parseNumber(rmMatch[2]),
                                clienti: parseInt(rmMatch[1], 10)
                            };
                        }
                    }

                    const dettaglioStart = csvText.indexOf('=== DETTAGLIO VENDITE PER CLIENTE ===');
                    const dettaglioEnd = csvText.indexOf('=== RIEPILOGO PER CATEGORIA ===');
                    let vendite = [];
                    if (dettaglioStart !== -1 && dettaglioEnd !== -1) {
                        const dettaglioSection = csvText.substring(dettaglioStart, dettaglioEnd);
                        const lines = dettaglioSection.split('\n').filter(line =>
                            line.trim() && !line.includes('===') && !line.includes('Provincia;Ragione Sociale Cliente') && line.includes(';') && line.split(';').length >= 4
                        );
                        const venditeMap = new Map();
                        lines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const fatturato = this.parseNumber(parts[3]);
                                if (!isNaN(fatturato) && fatturato > 0) {
                                    const cliente = parts[1].trim();
                                    if (!venditeMap.has(cliente) || venditeMap.get(cliente).fatturato < fatturato) {
                                        venditeMap.set(cliente, {
                                            provincia: parts[0].trim(),
                                            cliente: cliente,
                                            categoria: parts[2].trim(),
                                            fatturato: fatturato
                                        });
                                    }
                                }
                            }
                        });
                        vendite = Array.from(venditeMap.values()).sort((a,b)=>b.fatturato-a.fatturato).slice(0,10);
                    }

                    return { generale, latina, roma, vendite, timestamp: new Date() };
                } catch (e) {
                    console.error('âŒ Parsing error:', e);
                    return null;
                }
            }

            updateLoadingState(state, errorMessage = null) {
                const byId = (id) => document.getElementById(id);
                const loadingEl = byId('loading-state');
                const errorEl = byId('error-state');
                const mainEl = byId('main-content');
                const refreshIcon = byId('refresh-icon');
                const connectionDot = byId('connection-dot');
                const connectionStatus = byId('connection-status');
                const statusBadge = byId('status-badge');

                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.style.display = 'none';
                if (mainEl) mainEl.style.display = 'none';

                if (refreshIcon) {
                    if (state === 'updating') refreshIcon.classList.add('spinning');
                    else refreshIcon.classList.remove('spinning');
                }

                if (connectionDot) connectionDot.className = 'status-dot ' + (state === 'updating' ? 'updating' : state === 'success' ? 'online' : 'offline');

                switch (state) {
                    case 'updating':
                        if (loadingEl) loadingEl.style.display = 'block';
                        if (connectionStatus) connectionStatus.textContent = 'Updating...';
                        if (statusBadge) { statusBadge.className = 'status-badge updating'; statusBadge.textContent = 'ðŸ”„ Loading real data...'; }
                        break;
                    case 'success':
                        if (mainEl) mainEl.style.display = 'block';
                        if (connectionStatus) connectionStatus.textContent = 'Online';
                        if (statusBadge) { statusBadge.className = 'status-badge success'; statusBadge.textContent = 'âœ… CSV loaded successfully'; }
                        this.updateLastUpdateDisplay();
                        break;
                    case 'error':
                        if (errorEl) errorEl.style.display = 'block';
                        if (connectionStatus) connectionStatus.textContent = 'Error';
                        if (statusBadge) { statusBadge.className = 'status-badge error'; statusBadge.textContent = 'âš ï¸ CSV error'; }
                        const err = byId('error-message');
                        if (err) err.textContent = errorMessage || 'Unknown error';
                        break;
                }
            }

            updateLastUpdateDisplay() {
                if (!this.lastUpdate) return;
                const now = new Date();
                const diff = Math.floor((now - this.lastUpdate) / 1000);
                let timeText;
                if (diff < 60) timeText = diff + 's ago';
                else if (diff < 3600) timeText = Math.floor(diff / 60) + 'm ago';
                else timeText = this.lastUpdate.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });

                const lastUpdateEl = document.getElementById('last-update');
                if (lastUpdateEl) lastUpdateEl.textContent = timeText;
            }

            renderDashboard() {
                if (!this.csvData) return;
                this.renderKPICards();
                this.renderVenditeTable();
                this.renderCharts();
                this.updateProvinceOptions();
            }

            renderKPICards() {
                const data = this.getDisplayData();

                // Animate value changes
                this.animateValue('fatturato-value', this.formatEuroK3(data.fatturato));
                this.animateValue('growth-value', '+' + data.crescita + '%');
                this.animateValue('previous-value', this.formatEuroK3(data.annoPrecedente));
                this.animateValue('clienti-value', String(data.clienti));

                const obiettivoCard = document.getElementById('obiettivo-card');
                if (obiettivoCard) {
                    if (data.obiettivo) {
                        obiettivoCard.style.display = 'block';
                        this.animateValue('obiettivo-value', this.formatEuroK3(data.obiettivo));
                        this.animateValue('obiettivo-percentage', (data.percentualeObiettivo || 0) + '%');
                        this.animateValue('remaining-value', this.formatEuroK3((data.obiettivo || 0) - data.fatturato));
                        
                        const progressFill = document.getElementById('progress-fill');
                        if (progressFill) {
                            gsap.to(progressFill, {
                                width: (data.percentualeObiettivo || 0) + '%',
                                duration: 2,
                                ease: "power2.out"
                            });
                        }
                    } else {
                        obiettivoCard.style.display = 'none';
                    }
                }

                const provinciaLabel = document.getElementById('provincia-label');
                if (provinciaLabel) provinciaLabel.textContent = this.selectedProvince === 'all' ? 'TOT' : this.selectedProvince;
            }

            animateValue(elementId, newValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                gsap.to(element, {
                    duration: 0.5,
                    scale: 1.1,
                    ease: "power2.out",
                    onComplete: () => {
                        element.textContent = newValue;
                        gsap.to(element, {
                            duration: 0.3,
                            scale: 1,
                            ease: "power2.out"
                        });
                    }
                });
            }

            renderVenditeTable() {
                if (!this.csvData.vendite || this.csvData.vendite.length === 0) return;

                const tbody = document.getElementById('vendite-tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                this.csvData.vendite.forEach((vendita, index) => {
                    const row = document.createElement('tr');
                    row.style.opacity = '0';
                    row.innerHTML = `
                        <td><span class="province-badge ${vendita.provincia}">${vendita.provincia}</span></td>
                        <td>${vendita.cliente.length > 35 ? vendita.cliente.slice(0,35)+'...' : vendita.cliente}</td>
                        <td>${vendita.categoria}</td>
                        <td style="text-align: right; font-weight: 700; color: var(--primary-emerald);">${this.formatEuroK3(vendita.fatturato)}</td>
                    `;
                    tbody.appendChild(row);
                    
                    // Animate row appearance
                    gsap.to(row, {
                        opacity: 1,
                        y: 0,
                        duration: 0.5,
                        delay: index * 0.1,
                        ease: "back.out(1.7)"
                    });
                });

                this.animateValue('total-clients', String(this.csvData.vendite.length));
                this.animateValue('total-top-revenue', this.formatEuroK3(
                    this.csvData.vendite.reduce((sum, v) => sum + v.fatturato, 0)
                ));

                const updateStatusIcon = document.getElementById('update-status-icon');
                if (updateStatusIcon) updateStatusIcon.textContent = 'âœ…';
            }

            renderCharts() {
                if (!this.csvData) return;
                this.renderProvinceChart();
                this.renderCategoryChart();
                this.renderTopClientsChart();
                this.renderProgressChart();
            }

            renderProvinceChart() {
                const ctx = document.getElementById('provinceChart');
                if (!ctx) return;

                if (this.charts.province) this.charts.province.destroy();

                const data = {
                    labels: ['Latina (LT)', 'Roma (RM)'],
                    datasets: [{
                        data: [this.csvData.latina.annoCorrente, this.csvData.roma.annoCorrente],
                        backgroundColor: [
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(34, 211, 238, 0.8)'
                        ],
                        borderColor: [
                            'rgba(139, 92, 246, 1)',
                            'rgba(34, 211, 238, 1)'
                        ],
                        borderWidth: 3,
                        hoverBackgroundColor: [
                            'rgba(139, 92, 246, 1)',
                            'rgba(34, 211, 238, 1)'
                        ]
                    }]
                };

                this.charts.province = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    font: { size: 14, weight: '600' },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuroK3(context.raw);
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.raw / total) * 100).toFixed(1);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '60%',
                        animation: {
                            animateRotate: true,
                            duration: 2000
                        }
                    }
                });
            }

            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;

                if (this.charts.category) this.charts.category.destroy();

                const categories = this.extractCategoryData();
                
                const data = {
                    labels: categories.map(c => c.name.length > 15 ? c.name.substring(0, 15) + '...' : c.name),
                    datasets: [{
                        data: categories.map(c => c.value),
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(132, 204, 22, 0.8)',
                            'rgba(249, 115, 22, 0.8)'
                        ],
                        borderColor: [
                            'rgba(59, 130, 246, 1)',
                            'rgba(16, 185, 129, 1)',
                            'rgba(245, 158, 11, 1)',
                            'rgba(239, 68, 68, 1)',
                            'rgba(139, 92, 246, 1)',
                            'rgba(6, 182, 212, 1)',
                            'rgba(132, 204, 22, 1)',
                            'rgba(249, 115, 22, 1)'
                        ],
                        borderWidth: 2
                    }]
                };

                this.charts.category = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => `${categories[context.dataIndex].name}: ${this.formatEuroK3(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatK3(value),
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    font: { weight: '500' }
                                },
                                grid: { 
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                }
                            },
                            x: {
                                ticks: { 
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    maxRotation: 45,
                                    font: { size: 11, weight: '500' }
                                },
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutBounce'
                        }
                    }
                });
            }

            renderTopClientsChart() {
                const ctx = document.getElementById('topClientsChart');
                if (!ctx) return;

                if (this.charts.topClients) this.charts.topClients.destroy();

                const topClients = this.csvData.vendite.slice(0, 5);
                
                const data = {
                    labels: topClients.map(c => c.cliente.length > 25 ? c.cliente.substring(0, 25) + '...' : c.cliente),
                    datasets: [{
                        data: topClients.map(c => c.fatturato),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2
                    }]
                };

                this.charts.topClients = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => this.formatEuroK3(context.raw)
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatK3(value),
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    font: { weight: '500' }
                                },
                                grid: { 
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                }
                            },
                            y: {
                                ticks: { 
                                    color: 'rgba(255, 255, 255, 0.7)',
                                    font: { size: 12, weight: '500' }
                                },
                                grid: { display: false }
                            }
                        },
                        animation: {
                            duration: 2000,
                            delay: (context) => context.dataIndex * 200
                        }
                    }
                });
            }

            renderProgressChart() {
                const ctx = document.getElementById('progressChart');
                if (!ctx) return;

                if (this.charts.progress) this.charts.progress.destroy();

                const data = this.getDisplayData();
                const obiettivo = data.obiettivo || 0;
                const fatturato = data.fatturato || 0;
                const rimanente = Math.max(0, obiettivo - fatturato);

                if (obiettivo === 0) {
                    ctx.getContext('2d').fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.getContext('2d').font = '18px Inter';
                    ctx.getContext('2d').textAlign = 'center';
                    ctx.getContext('2d').fillText('No target set for this province', ctx.width/2, ctx.height/2);
                    return;
                }

                const chartData = {
                    labels: ['Achieved', 'Remaining'],
                    datasets: [{
                        data: [fatturato, rimanente],
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(229, 231, 235, 0.3)'
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(209, 213, 219, 0.5)'
                        ],
                        borderWidth: 3
                    }]
                };

                this.charts.progress = new Chart(ctx, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    font: { size: 14, weight: '600' },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: 'white',
                                bodyColor: 'white',
                                borderColor: 'rgba(255, 255, 255, 0.2)',
                                borderWidth: 1,
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuroK3(context.raw);
                                        const percentage = ((context.raw / obiettivo) * 100).toFixed(1);
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            animateRotate: true,
                            duration: 2000
                        }
                    }
                });
            }

            extractCategoryData() {
                if (!this.csvData.vendite) return [];
                
                const categoryMap = new Map();
                
                this.csvData.vendite.forEach(vendita => {
                    const cat = vendita.categoria;
                    if (categoryMap.has(cat)) {
                        categoryMap.set(cat, categoryMap.get(cat) + vendita.fatturato);
                    } else {
                        categoryMap.set(cat, vendita.fatturato);
                    }
                });

                return Array.from(categoryMap.entries())
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value)
                    .slice(0, 8);
            }

            showProvincePopup() {
                if (!this.csvData) return;
                this.updateProvinceOptions();
                const popup = document.getElementById('province-popup');
                if (popup) {
                    popup.style.display = 'flex';
                    popup.classList.add('show');
                }
            }

            hideProvincePopup() {
                const popup = document.getElementById('province-popup');
                if (popup) {
                    popup.classList.remove('show');
                    setTimeout(() => {
                        popup.style.display = 'none';
                    }, 300);
                }
            }

            updateProvinceOptions() {
                if (!this.csvData) return;
                const popupOptions = document.getElementById('popup-options');
                if (!popupOptions) return;
                popupOptions.innerHTML = '';

                const options = [
                    {
                        province: 'all',
                        title: 'All Provinces',
                        description: `${this.formatEuroK3(this.csvData.generale.annoCorrente)} â€¢ ${this.csvData.generale.clienti} clients`,
                        className: ''
                    },
                    {
                        province: 'LT',
                        title: 'Latina (LT)',
                        description: `${this.formatEuroK3(this.csvData.latina.annoCorrente)} â€¢ ${this.csvData.latina.clientiCorrente} clients â€¢ Target: ${this.csvData.latina.percentualeObiettivo || 0}%`,
                        className: 'LT'
                    },
                    {
                        province: 'RM',
                        title: 'Roma (RM)',
                        description: `${this.formatEuroK3(this.csvData.roma.annoCorrente)} â€¢ ${this.csvData.roma.clienti} clients`,
                        className: 'RM'
                    }
                ];

                options.forEach(opt => {
                    const option = document.createElement('button');
                    option.className = `province-option ${this.selectedProvince === opt.province ? 'selected ' + opt.className : ''}`;
                    option.innerHTML = `
                        <div class="option-info">
                            <h4>${opt.title}</h4>
                            <p>${opt.description}</p>
                        </div>
                        <div class="option-radio ${this.selectedProvince === opt.province ? 'selected' : ''}"></div>
                    `;

                    option.addEventListener('click', () => {
                        this.selectedProvince = opt.province;
                        this.renderDashboard();
                        this.hideProvincePopup();
                    });

                    popupOptions.appendChild(option);
                });
            }

            getDisplayData() {
                if (!this.csvData) {
                    return { fatturato: 0, annoPrecedente: 0, crescita: 0, clienti: 0, obiettivo: null, percentualeObiettivo: null };
                }

                if (this.selectedProvince === 'all') {
                    const prev = this.csvData.generale.annoPrecedente || 0;
                    const curr = this.csvData.generale.annoCorrente || 0;
                    const crescita = prev > 0 ? (((curr - prev) / prev) * 100).toFixed(1) : '0.0';
                    return { 
                        fatturato: curr, 
                        annoPrecedente: prev, 
                        crescita, 
                        clienti: this.csvData.generale.clienti, 
                        obiettivo: null, 
                        percentualeObiettivo: null 
                    };
                } else if (this.selectedProvince === 'LT') {
                    const prev = this.csvData.latina.annoPrecedente || 0;
                    const curr = this.csvData.latina.annoCorrente || 0;
                    const crescita = prev > 0 ? (((curr - prev) / prev) * 100).toFixed(1) : '0.0';
                    return { 
                        fatturato: curr, 
                        annoPrecedente: prev, 
                        crescita, 
                        clienti: this.csvData.latina.clientiCorrente, 
                        obiettivo: this.csvData.latina.obiettivo, 
                        percentualeObiettivo: this.csvData.latina.percentualeObiettivo 
                    };
                } else if (this.selectedProvince === 'RM') {
                    return { 
                        fatturato: this.csvData.roma.annoCorrente, 
                        annoPrecedente: 0, 
                        crescita: '0.0', 
                        clienti: this.csvData.roma.clienti, 
                        obiettivo: null, 
                        percentualeObiettivo: null 
                    };
                }

                return { fatturato: 0, annoPrecedente: 0, crescita: '0.0', clienti: 0, obiettivo: null, percentualeObiettivo: null };
            }

            parseNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                const cleaned = String(input)
                    .replace(/\s+/g, '')
                    .replace(/â‚¬/g, '')
                    .replace(/\./g, '')
                    .replace(/,/g, '.');
                const n = Number(cleaned);
                return Number.isFinite(n) ? n : 0;
            }

            formatK3(value) {
                const num = Number(value) || 0;
                const sign = num < 0 ? '-' : '';
                const v = Math.abs(num);
                const k = v / 1000;
                let out;
                if (k >= 100) out = String(Math.round(k));
                else if (k >= 10) out = (Math.round(k * 10) / 10).toString().replace('.', ',');
                else out = (Math.round(k * 100) / 100).toString().replace('.', ',');
                out = out.replace(/,?0+$/, '');
                return sign + out + 'k';
            }

            formatEuroK3(value) {
                if (!value) return 'â‚¬0k';
                const k = this.formatK3(value);
                return 'â‚¬' + k.replace('k','') + 'k';
            }

            startAutoUpdate() {
                this.updateInterval = setInterval(() => {
                    this.fetchCSVData();
                }, 2 * 60 * 1000);

                setInterval(() => this.updateLastUpdateDisplay(), 30 * 1000);
            }

            destroy() { 
                if (this.updateInterval) clearInterval(this.updateInterval); 
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new DashboardManager();
        });

        window.addEventListener('beforeunload', () => {
            if (window.dashboard) window.dashboard.destroy();
        });
    </script>
</body>
</html>
