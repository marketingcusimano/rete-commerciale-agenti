<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          color: #1f2937;
          line-height: 1.6;
          transition: all 0.3s ease;
        }

        body.dark-mode {
          background: #0f172a;
          color: #f8fafc;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .header-info h1 {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .header-info h1 {
          color: #f8fafc;
        }

        .header-info p {
          color: #6b7280;
          font-size: 1.1rem;
          font-weight: 500;
        }

        .theme-toggle {
          background: #374151;
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1.25rem;
          width: 50px;
          height: 50px;
        }

        .theme-toggle:hover {
          background: #4b5563;
          transform: scale(1.1);
        }

        .status-bar {
          display: flex;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.9rem;
          color: #6b7280;
        }

        .status-item i {
          color: #3b82f6;
        }

        .status-item strong {
          color: #1f2937;
        }

        body.dark-mode .status-item strong {
          color: #f8fafc;
        }

        .status-dot {
          width: 8px;
          height: 8px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        .card {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          margin-bottom: 2rem;
        }

        body.dark-mode .card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .loading-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          color: #6b7280;
        }

        .loading-spinner {
          animation: spin 1s linear infinite;
          font-size: 2rem;
          margin-right: 1rem;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        .error-container {
          background: #fee2e2;
          color: #dc2626;
          padding: 1rem;
          border-radius: 0.75rem;
          text-align: center;
          margin: 2rem 0;
        }

        body.dark-mode .error-container {
          background: #7f1d1d;
          color: #fca5a5;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        th, td {
          padding: 1rem;
          border-bottom: 1px solid #e5e7eb;
        }

        th {
          background: #f8fafc;
          font-weight: 700;
          color: #374151;
          text-align: left;
        }

        .client-card {
          background: #f8fafc;
          padding: 1.5rem;
          border-radius: 1rem;
          margin-bottom: 1rem;
          border: 2px solid #e5e7eb;
          position: relative;
        }

        @media (max-width: 768px) {
          .container {
            padding: 1rem;
          }
          
          .header {
            flex-direction: column;
            align-items: flex-start;
          }
          
          .header-info h1 {
            font-size: 2rem;
          }
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> <span id="agent-id">631.00238</span></span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong id="period-display">Gen - Ago 2025</strong></span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati aggiornati dal file CSV</span>
            </div>
        </div>

        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <div id="main-content" style="display: none;">
            <!-- RIEPILOGO PER CATEGORIA -->
            <div class="card">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Riepilogo per Categoria</h3>
                
                <div style="overflow-x: auto;">
                    <table id="categorie-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th style="text-align: right;">Importo</th>
                                <th style="text-align: center;">Clienti LT</th>
                                <th style="text-align: center;">Clienti RM</th>
                                <th style="text-align: center;">% sul Totale</th>
                            </tr>
                        </thead>
                        <tbody id="categorie-tbody">
                        </tbody>
                    </table>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <div style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #0284c7;" id="total-categories">0</div>
                        <div style="color: #0891b2; font-size: 0.875rem; font-weight: 600;">Categorie Totali</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #16a34a;" id="active-categories">0</div>
                        <div style="color: #059669; font-size: 0.875rem; font-weight: 600;">Categorie Attive</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef7ed, #fed7aa); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #ea580c;" id="total-category-amount">€0</div>
                        <div style="color: #c2410c; font-size: 0.875rem; font-weight: 600;">Fatturato Categorie</div>
                    </div>
                </div>
            </div>

            <!-- DETTAGLIO VENDITE PER CLIENTE -->
            <div class="card">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Top Clienti</h3>
                
                <div id="top-clienti-container">
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                    <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #7c3aed;" id="total-transactions">0</div>
                        <div style="color: #6d28d9; font-size: 0.875rem; font-weight: 600;">Transazioni Totali</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #0891b2;" id="unique-clients">0</div>
                        <div style="color: #0e7490; font-size: 0.875rem; font-weight: 600;">Clienti Unici</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #d97706;" id="avg-transaction">€0</div>
                        <div style="color: #b45309; font-size: 0.875rem; font-weight: 600;">Transazione Media</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); padding: 1.5rem; border-radius: 1rem; text-align: center;">
                        <div style="font-size: 2rem; font-weight: 900; color: #16a34a;" id="product-categories">0</div>
                        <div style="color: #15803d; font-size: 0.875rem; font-weight: 600;">Categorie Prodotti</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ExecutiveDashboard {
            constructor() {
                this.csvData = null;
                this.isLoading = false;
                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv'
                ];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                }
            }

            async loadData() {
                this.isLoading = true;
                this.showLoading();

                try {
                    const csvText = this.createRealCSVData();
                    this.csvData = this.parseCSV(csvText);
                    
                    if (!this.csvData) {
                        throw new Error('Errore nel parsing del CSV');
                    }

                    console.log('Parsed CSV data:', this.csvData);
                    this.showSuccess();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Errore caricamento:', error);
                    this.showError(error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            createRealCSVData() {
                return `==================== CARABOT NATALINO ====================;;;;;;;;
;;;;;;;;
=== INFORMAZIONI AGENTE ===;;;;;;;;
Codice Agente;Ragione Sociale;Dalla data;Alla data;;;;;
631.00238;CARABOT NATALINO;01/01/2025;17/08/2025;;;;;
;;;;;;;;
=== VERIFICA OBIETTIVI ===;;;;;;;;
Provincia;AnnoPrec.;AnnoCorr.;Obiettivo;% su obiet.;ClientiAnnoPrec.;ClientiAnnoCorr.;Obiettivo;% su obiet.
Generale;80.238,72;190.159,79;;;352;20;;
LT;79.029,16;82.389,23;350.000;58%;23;18;35;51%
;;;;;;;;
=== CLIENTI PER PROVINCIA ===;;;;;;;;
Provincia;Clienti Serviti;Fatturato;;;;;;
LT;18;60.437,22;;;;;;
RM;2;7.770,56;;;;;;
;;;;;;;;
=== RIPARTIZIONE FATTURATO ===;;;;;;;;
Categoria;Importo;Percentuale;;;;;;
Pieni e Coppi;54.909;62;61%;;;;;
Altro;35.250;17;39%;;;;;
;;;;;;;;
=== DETTAGLIO VENDITE PER CLIENTE ===;;;;;;;;
Provincia;Ragione Sociale Cliente;Categoria ARTICOLI;Fatturato;;;;;
LT;EDILIZIA SETINA S.R.L.;MATTONE PIENO;1.512,00;;;;;
LT;EDILIZIA SETINA S.R.L.;PAVIMENTAZIONE POLIS;1.665,62;;;;;
LT;ROSSETTI EDILIZIA SRL;FACCIAVISTA;583,78;;;;;
LT;ROSSETTI EDILIZIA SRL;LINEA ARCHEO;743,00;;;;;
LT;ROSSETTI EDILIZIA SRL;MATTONE PIENO;151,20;;;;;
LT;ROSSETTI EDILIZIA SRL;PAVIMENTAZIONE POLIS;416,40;;;;;
LT;F.LLI TORA SRL;COPERTURE;3,36;;;;;
LT;F.LLI TORA SRL;LINEA ARCHEO;1,74;;;;;
LT;F.LLI TORA SRL;MATTONE PIENO;3.110,40;;;;;
LT;F.LLI TORA SRL;PAVIMENTAZIONE POLIS;1.382,40;;;;;
LT;ADDESSI COMMERCIALE SRL;MATTONE PIENO;3.693,60;;;;;
LT;ADDESSI COMMERCIALE SRL;OUTLET;0,01;;;;;
LT;ADDESSI COMMERCIALE SRL;PIASTRELLE;1.240,95;;;;;
LT;CENTRO EDILE DE GREGORIS SRL;CORRIM.COPRIM.;73,26;;;;;
LT;CENTRO EDILE DE GREGORIS SRL;MATTONE PIENO;7.776,00;;;;;
LT;CENTRO EDILE DE GREGORIS SRL;PAVIMENTAZIONE POLIS;8,67;;;;;
LT;CENTRO EDILE DE GREGORIS SRL;REFRATTARI RETTIFICATI;1.281,60;;;;;
LT;STENI SRL;MATTONE PIENO;547,20;;;;;
LT;STENI SRL;PAVIMENTAZIONE POLIS;984,96;;;;;
RM;DOVAL SRL;REFRATTARI;1.019,82;;;;;
LT;ROSANCOS SRL;MATTONE PIENO;1.528,80;;;;;
LT;ROSANCOS SRL;PAVIMENTAZIONE POLIS;604,80;;;;;
LT;EDILCERAMICA SAS DI VEGLIA CRISTIAN & C.;MATTONE PIENO;1.440,00;;;;;
LT;D'URSO MAT.DA COSTRUZIONE DI D'URSO S. & C SAS;MATTONE PIENO;3.744,00;;;;;
LT;D'URSO MAT.DA COSTRUZIONE DI D'URSO S. & C SAS;PAVIMENTAZIONE POLIS;832,81;;;;;
LT;DIMED SRL;MATTONE PIENO;1.326,96;;;;;
LT;BIANCHI INNOCENZO SAS DI BIANCHI ANNA RITA & C;MATTONE PIENO;1.209,60;;;;;
LT;BIANCHI INNOCENZO SAS DI BIANCHI ANNA RITA & C;REFRATTARI;900,83;;;;;
LT;BIANCHI INNOCENZO SAS DI BIANCHI ANNA RITA & C;REFRATTARI RETTIFICATI;1.935,58;;;;;
LT;EDILIM SRL;MATTONE PIENO;1.370,88;;;;;
LT;EDILIM SRL;PAVIMENTAZIONE POLIS;984,96;;;;;
LT;EDILIZIA VENDITTI DI VENDITTI GIOVANNI E C. SNC;MATTONE PIENO;3.456,00;;;;;
LT;EDILIZIA VENDITTI DI VENDITTI GIOVANNI E C. SNC;PAVIMENTAZIONE POLIS;2.230,80;;;;;
LT;L'EMPORIO DI IOZZI SONIA;MATTONE PIENO;957,60;;;;;
LT;L'EMPORIO DI IOZZI SONIA;PAVIMENTAZIONE POLIS;984,96;;;;;
LT;EDIL PONTINA SRLS;MATTONE PIENO;864,00;;;;;
LT;EDIL PONTINA SRLS;REFRATTARI;379,47;;;;;
LT;EDIL PONTINA SRLS;REFRATTARI RETTIFICATI;819,98;;;;;
LT;FER.COM. COSTRUZIONI SRL;PAVIMENTAZIONE POLIS;2.695,68;;;;;
LT;FER.COM. COSTRUZIONI SRL;REFRATTARI;640,35;;;;;
LT;FER.COM. COSTRUZIONI SRL;REFRATTARI RETTIFICATI;460,34;;;;;
LT;EDILIZIA PRIMAVERA SRL;PAVIMENTAZIONE POLIS;933,12;;;;;
LT;EDILIZIA PRIMAVERA SRL;REFRATTARI;1.969,92;;;;;
LT;EDILIZIA PRIMAVERA SRL;REFRATTARI RETTIFICATI;870,33;;;;;
RM;COLANTUONO 1918 SRL;LINEA ARCHEO;1,94;;;;;
RM;COLANTUONO 1918 SRL;MATTONE PIENO;5.150,40;;;;;
RM;COLANTUONO 1918 SRL;PAVIMENTAZIONE POLIS;1.598,40;;;;;
LT;LATINA BETON SERVIZI SRL;FACCIAVISTA;1.007,62;;;;;
LT;LATINA BETON SERVIZI SRL;MATTONE PIENO;720,00;;;;;
LT;LATINA BETON SERVIZI SRL;PAVIMENTAZIONE POLIS;362,88;;;;;
;;;;;;;;
=== RIEPILOGO PER CATEGORIA ===;;;;;;;;
Categoria;Importo Totale;Provincia LT Clienti;Provincia RM Clienti;;;;;
COPERTURE;3,36;1;0;;;;;
CORRIM.COPRIM.;73,26;1;0;;;;;
FACCIAVISTA;1.591,40;2;0;;;;;
LINEA ARCHEO;746,68;2;1;;;;;
MATTONE PIENO;38.558,64;16;1;;;;;
OUTLET;0,01;1;0;;;;;
PAVIMENTAZIONE POLIS;15.686,46;13;1;;;;;
PIASTRELLE;1.240,95;1;0;;;;;
REFRATTARI;4.910,39;4;1;;;;;
REFRATTARI RETTIFICATI;5.367,83;5;0;;;;;
;;;;;;;;`;
            }

            parseCSV(csvText) {
                try {
                    console.log('Parsing CSV...');
                    
                    const agentInfo = {
                        codice: '631.00238',
                        nome: 'CARABOT NATALINO',
                        dallaData: '01/01/2025',
                        allaData: '17/08/2025'
                    };

                    // Parse DETTAGLIO VENDITE
                    const dettaglioMatch = csvText.match(/=== DETTAGLIO VENDITE PER CLIENTE ===([\s\S]*?)===.*===/);
                    let dettaglioVendite = [];
                    
                    if (dettaglioMatch) {
                        const dettaglioText = dettaglioMatch[1];
                        const lines = dettaglioText.split('\n').filter(line => {
                            const cleaned = line.trim();
                            return cleaned.length > 0 && 
                                   !cleaned.includes('Provincia;Ragione Sociale') && 
                                   !cleaned.includes('===') &&
                                   cleaned.includes(';') && 
                                   !cleaned.startsWith(';') &&
                                   cleaned.split(';').length >= 4;
                        });
                        
                        lines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const provincia = parts[0]?.trim();
                                const cliente = parts[1]?.trim();
                                const categoria = parts[2]?.trim();
                                const fatturato = this.parseItalianNumber(parts[3]);
                                
                                if (provincia && cliente && categoria && fatturato > 0) {
                                    dettaglioVendite.push({
                                        provincia,
                                        cliente,
                                        categoria,
                                        fatturato
                                    });
                                }
                            }
                        });
                    }

                    // Parse RIEPILOGO PER CATEGORIA
                    const riepilogoMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===([\s\S]*?)===.*===/);
                    let categorie = [];
                    
                    if (riepilogoMatch) {
                        const riepilogoText = riepilogoMatch[1];
                        const lines = riepilogoText.split('\n').filter(line => {
                            const cleaned = line.trim();
                            return cleaned.length > 0 && 
                                   !cleaned.includes('Categoria;Importo') && 
                                   !cleaned.includes('===') &&
                                   cleaned.includes(';') && 
                                   !cleaned.startsWith(';') &&
                                   cleaned.split(';').length >= 4;
                        });
                        
                        lines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const categoria = parts[0]?.trim();
                                const importo = this.parseItalianNumber(parts[1]);
                                const ltClienti = parseInt(parts[2], 10) || 0;
                                const rmClienti = parseInt(parts[3], 10) || 0;
                                
                                if (categoria && importo >= 0) {
                                    categorie.push({
                                        nome: categoria,
                                        importo: importo,
                                        ltClienti: ltClienti,
                                        rmClienti: rmClienti
                                    });
                                }
                            }
                        });
                    }

                    console.log('Parsed dettaglio vendite:', dettaglioVendite.length);
                    console.log('Parsed categorie:', categorie.length);

                    return {
                        agentInfo,
                        dettaglioVendite,
                        categorie
                    };
                    
                } catch (e) {
                    console.error('Parse error:', e);
                    return null;
                }
            }

            parseItalianNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                
                let cleaned = String(input).replace(/\s+/g, '').replace(/€/g, '').replace(/"/g, '');
                
                if (cleaned.includes('.') && cleaned.includes(',')) {
                    cleaned = cleaned.replace(/\./g, '').replace(/,/g, '.');
                } else if (cleaned.includes(',') && !cleaned.includes('.')) {
                    cleaned = cleaned.replace(/,/g, '.');
                }
                
                return Number(cleaned) || 0;
            }

            formatEuro(value) {
                if (!value) return '0 €';
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            }

            formatEuroK(value) {
                if (!value) return '€0k';
                const k = Math.round(value / 1000);
                return k + 'k €';
            }

            updateDashboard() {
                if (!this.csvData) return;

                if (this.csvData.agentInfo) {
                    const agentIdEl = document.getElementById('agent-id');
                    const periodDisplayEl = document.getElementById('period-display');
                    
                    if (agentIdEl) agentIdEl.textContent = this.csvData.agentInfo.codice;
                    if (periodDisplayEl) periodDisplayEl.textContent = this.csvData.agentInfo.dallaData + ' - ' + this.csvData.agentInfo.allaData;
                }

                this.updateCategorieSection();
                this.updateDettaglioVenditeSection();
            }

            updateCategorieSection() {
                console.log('Updating categorie section...');
                
                if (!this.csvData.categorie || this.csvData.categorie.length === 0) {
                    console.log('No categorie data available');
                    return;
                }
                
                const tbody = document.getElementById('categorie-tbody');
                if (!tbody) return;
                
                const totalImporto = this.csvData.categorie.reduce((sum, cat) => sum + cat.importo, 0);
                const categorieOrdinate = [...this.csvData.categorie].sort((a, b) => b.importo - a.importo);
                
                tbody.innerHTML = '';
                categorieOrdinate.forEach((categoria, index) => {
                    const percentuale = totalImporto > 0 ? ((categoria.importo / totalImporto) * 100).toFixed(1) : 0;
                    const isTop5 = index < 5;
                    
                    const row = document.createElement('tr');
                    if (isTop5) {
                        row.style.background = '#f8fafc';
                    }
                    
                    row.innerHTML = 
                        '<td style="font-weight: ' + (isTop5 ? '600' : '400') + '; color: ' + (isTop5 ? '#1f2937' : '#6b7280') + ';">' +
                        categoria.nome +
                        (isTop5 ? ' <span style="background: #3b82f6; color: white; padding: 0.125rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem;">TOP</span>' : '') +
                        '</td>' +
                        '<td style="text-align: right; font-weight: ' + (isTop5 ? '700' : '500') + '; color: ' + (isTop5 ? '#1f2937' : '#6b7280') + ';">' +
                        this.formatEuro(categoria.importo) +
                        '</td>' +
                        '<td style="text-align: center; color: #7c3aed; font-weight: 600;">' +
                        (categoria.ltClienti || 0) +
                        '</td>' +
                        '<td style="text-align: center; color: #0891b2; font-weight: 600;">' +
                        (categoria.rmClienti || 0) +
                        '</td>' +
                        '<td style="text-align: center; font-weight: 600; color: ' + (isTop5 ? '#059669' : '#6b7280') + ';">' +
                        percentuale + '%' +
                        '</td>';
                    
                    tbody.appendChild(row);
                });
                
                const totalCategories = this.csvData.categorie.length;
                const activeCategories = this.csvData.categorie.filter(c => c.importo > 0).length;
                
                const totalCategoriesEl = document.getElementById('total-categories');
                const activeCategoriesEl = document.getElementById('active-categories');
                const totalCategoryAmountEl = document.getElementById('total-category-amount');
                
                if (totalCategoriesEl) totalCategoriesEl.textContent = totalCategories;
                if (activeCategoriesEl) activeCategoriesEl.textContent = activeCategories;
                if (totalCategoryAmountEl) totalCategoryAmountEl.textContent = this.formatEuro(totalImporto);
            }

            updateDettaglioVenditeSection() {
                console.log('Updating dettaglio vendite section...');
                
                if (!this.csvData.dettaglioVendite || this.csvData.dettaglioVendite.length === 0) {
                    console.log('No dettaglio vendite data available');
                    return;
                }
                
                const container = document.getElementById('top-clienti-container');
                if (!container) return;
                
                const clientiMap = new Map();
                this.csvData.dettaglioVendite.forEach(vendita => {
                    const key = vendita.provincia + '-' + vendita.cliente;
                    if (clientiMap.has(key)) {
                        const existing = clientiMap.get(key);
                        existing.fatturato += vendita.fatturato;
                        existing.transazioni++;
                        existing.categorie.add(vendita.categoria);
                    } else {
                        clientiMap.set(key, {
                            provincia: vendita.provincia,
                            cliente: vendita.cliente,
                            fatturato: vendita.fatturato,
                            transazioni: 1,
                            categorie: new Set([vendita.categoria])
                        });
                    }
                });
                
                const topClienti = Array.from(clientiMap.values())
                    .sort((a, b) => b.fatturato - a.fatturato)
                    .slice(0, 10);
                
                container.innerHTML = '';
                topClienti.forEach((cliente, index) => {
                    const isTop3 = index < 3;
                    const provinceColor = cliente.provincia === 'LT' ? '#7c3aed' : '#0891b2';
                    const provinceName = cliente.provincia === 'LT' ? 'Latina' : 'Roma';
                    const clienteName = cliente.cliente.length > 40 ? cliente.cliente.substring(0, 40) + '...' : cliente.cliente;
                    
                    const clientCard = document.createElement('div');
                    clientCard.className = 'client-card';
                    if (isTop3) {
                        clientCard.style.border = '2px solid ' + provinceColor;
                        clientCard.style.background = 'linear-gradient(135deg, #f0f9ff, #e0f2fe)';
                    }
                    
                    let cardContent = '';
                    if (isTop3) {
                        cardContent += '<div style="position: absolute; top: -8px; right: 15px; background: ' + provinceColor + '; color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.75rem; font-weight: 700;">#' + (index + 1) + '</div>';
                    }
                    
                    cardContent += 
                        '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">' +
                        '<div>' +
                        '<div style="font-size: 1.125rem; font-weight: 700; color: #1f2937; margin-bottom: 0.25rem;">' + clienteName + '</div>' +
                        '<div style="color: ' + provinceColor + '; font-size: 0.875rem; font-weight: 600;">' + provinceName + ' (' + cliente.provincia + ')</div>' +
                        '</div>' +
                        '<div style="text-align: right;">' +
                        '<div style="font-size: 1.5rem; font-weight: 900; color: #1f2937;">' + this.formatEuroK(cliente.fatturato) + '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; font-size: 0.875rem;">' +
                        '<div><span style="color: #6b7280;">Transazioni:</span> <strong style="color: #1f2937;">' + cliente.transazioni + '</strong></div>' +
                        '<div><span style="color: #6b7280;">Categorie:</span> <strong style="color: #1f2937;">' + cliente.categorie.size + '</strong></div>' +
                        '<div><span style="color: #6b7280;">Media:</span> <strong style="color: #1f2937;">' + this.formatEuroK(cliente.fatturato / cliente.transazioni) + '</strong></div>' +
                        '</div>';
                    
                    clientCard.innerHTML = cardContent;
                    container.appendChild(clientCard);
                });
                
                const totalTransazioni = this.csvData.dettaglioVendite.length;
                const uniqueClientiCount = clientiMap.size;
                const totalFatturato = Array.from(clientiMap.values()).reduce((sum, c) => sum + c.fatturato, 0);
                const avgTransaction = totalFatturato / totalTransazioni;
                const uniqueCategorie = new Set(this.csvData.dettaglioVendite.map(v => v.categoria)).size;
                
                const totalTransactionsEl = document.getElementById('total-transactions');
                const uniqueClientsEl = document.getElementById('unique-clients');
                const avgTransactionEl = document.getElementById('avg-transaction');
                const productCategoriesEl = document.getElementById('product-categories');
                
                if (totalTransactionsEl) totalTransactionsEl.textContent = totalTransazioni;
                if (uniqueClientsEl) uniqueClientsEl.textContent = uniqueClientiCount;
                if (avgTransactionEl) avgTransactionEl.textContent = this.formatEuroK(avgTransaction);
                if (productCategoriesEl) productCategoriesEl.textContent = uniqueCategorie;
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveDashboard();
        });
    </script>
</body>
</html>
