<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          color: #1f2937;
          line-height: 1.6;
          transition: all 0.3s ease;
        }

        body.dark-mode {
          background: #0f172a;
          color: #f8fafc;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }

        /* Header */
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .header-info h1 {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .header-info h1 {
          color: #f8fafc;
        }

        .header-info p {
          color: #6b7280;
          font-size: 1.1rem;
          font-weight: 500;
        }

        .theme-toggle {
          background: #374151;
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1.25rem;
          width: 50px;
          height: 50px;
        }

        .theme-toggle:hover {
          background: #4b5563;
          transform: scale(1.1);
        }

        /* Status Bar */
        .status-bar {
          display: flex;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.9rem;
          color: #6b7280;
        }

        .status-item i {
          color: #3b82f6;
        }

        .status-item strong {
          color: #1f2937;
        }

        body.dark-mode .status-item strong {
          color: #f8fafc;
        }

        .status-dot {
          width: 8px;
          height: 8px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        /* Filter Section */
        .filter-section {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .filter-label {
          font-weight: 600;
          color: #374151;
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        body.dark-mode .filter-label {
          color: #d1d5db;
        }

        .province-selector {
          background: #3b82f6;
          color: white;
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: 0.75rem;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .province-selector:hover {
          background: #2563eb;
          transform: translateY(-2px);
          box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        /* Cards Grid */
        .cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }

        .card {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        body.dark-mode .card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .card:hover {
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1rem;
        }

        .card-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        .card-badge {
          background: #dcfce7;
          color: #16a34a;
          padding: 0.25rem 0.75rem;
          border-radius: 1rem;
          font-size: 0.75rem;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 0.25rem;
        }

        .card-badge.warning {
          background: #fef3c7;
          color: #d97706;
        }

        .card-value {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .card-value {
          color: #f8fafc;
        }

        .card-subtitle {
          color: #6b7280;
          font-size: 0.9rem;
          margin-bottom: 1rem;
        }

        .progress-section {
          background: #f8fafc;
          padding: 1rem;
          border-radius: 0.75rem;
          margin-top: 1rem;
        }

        body.dark-mode .progress-section {
          background: #0f172a;
        }

        .progress-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
        }

        .progress-label {
          font-size: 0.875rem;
          font-weight: 600;
          color: #1f2937;
        }

        body.dark-mode .progress-label {
          color: #f8fafc;
        }

        .progress-value {
          font-size: 0.875rem;
          font-weight: 700;
          color: #6b7280;
        }

        .progress-bar-container {
          width: 100%;
          height: 8px;
          background: #e5e7eb;
          border-radius: 1rem;
          overflow: hidden;
        }

        body.dark-mode .progress-bar-container {
          background: #374151;
        }

        .progress-bar {
          height: 100%;
          border-radius: 1rem;
          transition: width 2s ease-in-out;
          position: relative;
        }

        .progress-bar.green {
          background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-bar.blue {
          background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .progress-bar.orange {
          background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 0.75rem;
          font-size: 0.875rem;
        }

        .progress-remaining {
          color: #6b7280;
        }

        .progress-percentage {
          color: #3b82f6;
          font-weight: 700;
        }

        /* Performance Cards */
        .performance-card {
          background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
          border: 1px solid #7dd3fc;
        }

        body.dark-mode .performance-card {
          background: linear-gradient(135deg, #0c4a6e, #075985);
          border-color: #0284c7;
        }

        .performance-header {
          margin-bottom: 1rem;
        }

        .performance-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          margin-bottom: 0.5rem;
        }

        .performance-province {
          font-size: 2rem;
          font-weight: 900;
          color: #0284c7;
          margin-bottom: 0.25rem;
        }

        .performance-subtitle {
          color: #6b7280;
          font-size: 0.875rem;
        }

        .performance-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .performance-growth {
          color: #10b981;
          font-size: 1.25rem;
          font-weight: 700;
        }

        .performance-amount {
          color: #374151;
          font-size: 1.125rem;
          font-weight: 700;
        }

        body.dark-mode .performance-amount {
          color: #d1d5db;
        }

        .trend-section {
          background: #f0f9ff;
          padding: 1rem;
          border-radius: 0.75rem;
          margin-top: 1rem;
        }

        body.dark-mode .trend-section {
          background: #0c4a6e;
        }

        .trend-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
        }

        .trend-item:last-child {
          margin-bottom: 0;
        }

        .trend-label {
          color: #0284c7;
          font-size: 0.875rem;
          font-weight: 600;
        }

        .trend-value {
          color: #0284c7;
          font-size: 0.875rem;
          font-weight: 700;
        }

        /* Client Cards */
        .client-card {
          background: linear-gradient(135deg, #fef7ed, #fed7aa);
          border: 1px solid #fb923c;
        }

        body.dark-mode .client-card {
          background: linear-gradient(135deg, #7c2d12, #9a3412);
          border-color: #ea580c;
        }

        .client-header {
          margin-bottom: 1rem;
        }

        .client-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          margin-bottom: 0.5rem;
        }

        .client-count {
          font-size: 3rem;
          font-weight: 900;
          color: #ea580c;
          margin-bottom: 0.25rem;
        }

        .client-subtitle {
          color: #6b7280;
          font-size: 0.875rem;
        }

        .client-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }

        .client-percentage {
          color: #ea580c;
          font-size: 1.5rem;
          font-weight: 700;
        }

        .client-target {
          color: #6b7280;
          font-size: 0.875rem;
        }

        /* Loading States */
        .loading-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          color: #6b7280;
        }

        .loading-spinner {
          animation: spin 1s linear infinite;
          font-size: 2rem;
          margin-right: 1rem;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        .error-container {
          background: #fee2e2;
          color: #dc2626;
          padding: 1rem;
          border-radius: 0.75rem;
          text-align: center;
          margin: 2rem 0;
        }

        body.dark-mode .error-container {
          background: #7f1d1d;
          color: #fca5a5;
        }

        /* Province Badge for tables */
        .province-badge {
          display: inline-block;
          padding: 0.25rem 0.5rem;
          border-radius: 9999px;
          font-size: 0.75rem;
          font-weight: 700;
        }

        .province-badge.LT {
          background: rgba(139, 92, 246, 0.1);
          color: #8b5cf6;
        }

        .province-badge.RM {
          background: rgba(34, 211, 238, 0.1);
          color: #22d3ee;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .container {
            padding: 1rem;
          }
          
          .header {
            flex-direction: column;
            align-items: flex-start;
          }
          
          .header-info h1 {
            font-size: 2rem;
          }
          
          .cards-grid {
            grid-template-columns: 1fr;
          }
          
          .card-value {
            font-size: 2rem;
          }
          
          .performance-province {
            font-size: 1.5rem;
          }
          
          .client-count {
            font-size: 2.5rem;
          }
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> 631.00238</span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong>Gen - Ago 2025</strong> (8 mesi)</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati aggiornati dal file CSV</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div>
                <div class="filter-label">Filtro Territorio</div>
                <div style="color: #3b82f6; font-weight: 600; margin-top: 0.25rem;" id="current-filter">Tutte le Province</div>
            </div>
            <button class="province-selector" id="province-selector">
                <i class="fas fa-chevron-down"></i>
                <span>Selezione Provincia</span>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <div class="cards-grid">
                <!-- Fatturato Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fatturato 2025</div>
                        <div class="card-badge">
                            <i class="fas fa-arrow-up"></i>
                            <span id="growth-badge">+0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="fatturato-value">€0k</div>
                    <div class="card-subtitle">vs 2024: <strong id="fatturato-vs">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Fatturato</div>
                            <div class="progress-value" id="obiettivo-fatturato">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar green" id="progress-fatturato" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="fatturato-remaining">€0k</strong></div>
                            <div class="progress-percentage" id="fatturato-percentage">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Obiettivo Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Obiettivo 2025</div>
                        <div class="card-badge" id="obiettivo-badge">
                            <span id="obiettivo-percentage">0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="obiettivo-value">€0k</div>
                    <div class="card-subtitle">Da raggiungere: <strong id="obiettivo-remaining">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Progressione Obiettivo</div>
                            <div class="progress-value" id="obiettivo-target">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar blue" id="progress-obiettivo" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="obiettivo-mancano">€0k</strong></div>
                            <div class="progress-percentage" id="obiettivo-perc-display">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Top Performance Card -->
                <div class="card performance-card">
                    <div class="performance-header">
                        <div class="performance-title">Top Performance</div>
                        <div class="performance-province" id="top-province">LT</div>
                        <div class="performance-subtitle">Provincia Latina</div>
                    </div>
                    <div class="performance-metrics">
                        <div class="performance-growth" id="province-growth">+0%</div>
                        <div class="performance-amount" id="province-amount">€0k</div>
                    </div>
                    <div class="trend-section">
                        <div class="trend-item">
                            <div class="trend-label">Crescita Complessiva</div>
                            <div class="trend-value" id="trend-growth">+€0k</div>
                        </div>
                        <div class="trend-item">
                            <div class="trend-label">Crescita: +0%</div>
                            <div class="trend-value">Trend positivo</div>
                        </div>
                    </div>
                </div>

                <!-- Clienti Attivi Card -->
                <div class="card client-card">
                    <div class="client-header">
                        <div class="client-title">Clienti Attivi</div>
                        <div class="client-count" id="clienti-count">0</div>
                        <div class="client-subtitle">Obiettivo: <span id="clienti-obiettivo">0</span></div>
                    </div>
                    <div class="client-metrics">
                        <div class="client-percentage" id="clienti-percentage">0%</div>
                        <div class="client-target">raggiunto</div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Clienti</div>
                            <div class="progress-value" id="clienti-target-value">0</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar orange" id="progress-clienti" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="clienti-mancanti">0 clienti</strong></div>
                            <div class="progress-percentage" id="clienti-perc-display">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-top: 2rem;">
                <!-- Confronto Clienti per Provincia -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Clienti per Provincia</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="clientiChart"></canvas>
                    </div>
                    
                    <!-- Province Info Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #fef2f2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-growth">-5%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="rm-growth">+2%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confronto Province (Fatturato) -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Province</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="fatturatoChart"></canvas>
                    </div>
                    
                    <!-- Province Revenue Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong id="lt-fatturato-prev">€0k</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-fatturato-growth">+4.3%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong>0 €</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;">+Infinity%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TOP 10 VENDITE PER CLIENTE - AGGIUNTA -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Top 10 Vendite per Cliente</h3>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Provincia</th>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Cliente</th>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Categoria Principale</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Fatturato</th>
                            </tr>
                        </thead>
                        <tbody id="vendite-tbody">
                            <!-- Popolato dinamicamente dal JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="top-clients-count">0</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Clienti Top 10</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="top-fatturato-total">€0k</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Top 10</div>
                    </div>
                </div>
            </div>

            <!-- RIEPILOGO PER CATEGORIA - AGGIUNTA -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Riepilogo per Categoria</h3>
                
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Categoria</th>
                                <th style="text-align: center; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Clienti LT</th>
                                <th style="text-align: center; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Clienti RM</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">Fatturato</th>
                                <th style="text-align: right; padding: 0.75rem 1rem; border-bottom: 2px solid rgba(107, 114, 128, 0.1); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #6b7280; letter-spacing: 0.05em;">% Totale</th>
                            </tr>
                        </thead>
                        <tbody id="categorie-tbody">
                            <!-- Popolato dinamicamente dal JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 900; color: #3b82f6;" id="categorie-fatturato-totale">€0k</div>
                    <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Totale Categorie</div>
                </div>
            </div>

            <!-- Distribuzione Province Section -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Distribuzione Province</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                    <!-- Province Distribution Chart -->
                    <div style="position: relative; height: 300px;">
                        <canvas id="provinceDistributionChart"></canvas>
                    </div>
                    
                    <!-- Province Details Cards -->
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Latina Card -->
                        <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 1.5rem; border-radius: 1rem; border: 2px solid #a855f7;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #7c3aed;">Latina (LT)</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #7c3aed;" id="dist-lt-percentage">91.4%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 0.5rem;" id="dist-lt-amount">82.389 €</div>
                        </div>

                        <!-- Roma Card -->
                        <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); padding: 1.5rem; border-radius: 1rem; border: 2px solid #22d3ee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #0891b2;">Roma (RM)</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #0891b2;" id="dist-rm-percentage">8.6%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 0.5rem;" id="dist-rm-amount">7.771 €</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riepilogo Clienti per Provincia -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Riepilogo Clienti per Provincia</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Latina -->
                    <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 2rem; border-radius: 1.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed; margin-bottom: 1rem;">Latina</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 2.5rem; font-weight: 900; color: #1f2937;" id="riepilogo-lt-clienti-2025">18</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">clienti 2025</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="riepilogo-lt-fatturato-k">€82k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">fatturato</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;" id="riepilogo-lt-medio">€5k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">medio</div>
                            </div>
                        </div>
                        
                        <!-- vs 2024 -->
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 0.75rem; border: 1px solid #fecaca;" id="lt-comparison-box">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #dc2626; font-weight: 600;" id="lt-comparison-text">vs 2024: <span id="riepilogo-lt-clienti-2024">23</span> clienti</span>
                                <span style="background: #fecaca; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 700;" id="riepilogo-lt-difference">-5 ↓</span>
                            </div>
                        </div>
                    </div>

                    <!-- Roma -->
                    <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); padding: 2rem; border-radius: 1.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #0891b2; margin-bottom: 1rem;">Roma</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 2.5rem; font-weight: 900; color: #1f2937;" id="riepilogo-rm-clienti-2025">2</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">clienti 2025</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="riepilogo-rm-fatturato-k">€8k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">fatturato</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #0891b2;" id="riepilogo-rm-medio">€4k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">medio</div>
                            </div>
                        </div>
                        
                        <!-- vs 2024 -->
                        <div style="background: #d1fae5; padding: 1rem; border-radius: 0.75rem; border: 1px solid #a7f3d0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #059669; font-weight: 600;">vs 2024: <span id="riepilogo-rm-clienti-2024">0</span> clienti</span>
                                <span style="background: #a7f3d0; color: #059669; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 700;">+∞</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mix Prodotti Section -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Mix Prodotti</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                    <!-- Doughnut Chart -->
                    <div style="position: relative; height: 300px;">
                        <canvas id="mixProdottiChart"></canvas>
                    </div>
                    
                    <!-- Product Details -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Mattone + Pavimentazione -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #3b82f6;">Mattone + Pavimentazione</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #3b82f6;" id="core-percentage">79.6%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="core-amount">54.245 €</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Mattone:</span>
                                    <span id="mattone-amount">€39k</span>
                                </div>
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Pavimentazione:</span>
                                    <span id="pavimentazione-amount">€16k</span>
                                </div>
                            </div>
                        </div>

                        <!-- Altri Prodotti -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #6b7280;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #6b7280;">Altri Prodotti</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #6b7280;" id="other-percentage">20.4%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="other-amount">13.934 €</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Refrattari:</span>
                                    <span id="refrattari-amount">€10k</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Altri:</span>
                                    <span id="altri-amount">€4k</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Mix Prodotti -->
                <div style="background: linear-gradient(135deg, #f0f4ff, #e0e7ff); padding: 1.5rem; border-radius: 1rem; margin-top: 2rem; border: 1px solid #c7d2fe;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                        <span style="font-weight: 700; color: #3730a3;">Performance Mix Prodotti</span>
                        <span style="margin-left: auto; font-weight: 700; color: #3730a3;">Equilibrio Ottimo</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="core-perf">79.6%</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Prodotti Core</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="categories-count">7</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Categorie Attive</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="involved-clients">20</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Clienti Coinvolti</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Province Selection Popup -->
        <div id="province-popup" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; padding: 1rem;">
            <div style="background: white; border-radius: 1rem; max-width: 400px; margin: 2rem auto; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" id="popup-content">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Seleziona Provincia</h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;" id="province-options">
                    <button class="province-option" data-province="all" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Tutte le Province</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="all-desc">€0k • 0 clienti</div>
                    </button>
                    <button class="province-option" data-province="LT" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Latina (LT)</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="lt-desc">€0k • 0 clienti</div>
                    </button>
                    <button class="province-option" data-province="RM" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Roma (RM)</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="rm-desc">€0k • 0 clienti</div>
                    </button>
                </div>
                <button id="close-popup" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: #374151; color: white; border: none; border-radius: 0.5rem; cursor: pointer; width: 100%;">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        class ExecutiveDashboard {
            constructor() {
                this.csvData = null;
                this.selectedProvince = 'all';
                this.isLoading = false;
                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv'
                ];
                // NEW: registry per le istanze Chart.js
                this.charts = {
                    clienti: null,
                    fatturato: null,
                    distribuzioneProvince: null,
                    mixProdotti: null
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                
                // Province selector
                document.getElementById('province-selector').addEventListener('click', () => this.showProvincePopup());
                document.getElementById('close-popup').addEventListener('click', () => this.hideProvincePopup());
                
                // Province options
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.province-option')) {
                        const province = e.target.closest('.province-option').dataset.province;
                        this.selectProvince(province);
                    }
                });

                // Close popup on backdrop click
                document.getElementById('province-popup').addEventListener('click', (e) => {
                    if (e.target.id === 'province-popup') {
                        this.hideProvincePopup();
                    }
                });
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                const popup = document.getElementById('popup-content');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                    if (popup) {
                        popup.style.background = '#1e293b';
                        popup.style.color = '#f8fafc';
                    }
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                    if (popup) {
                        popup.style.background = 'white';
                        popup.style.color = '#1f2937';
                    }
                }
            }

            showProvincePopup() {
                if (this.csvData) {
                    this.updateProvinceOptions();
                    document.getElementById('province-popup').style.display = 'block';
                }
            }

            hideProvincePopup() {
                document.getElementById('province-popup').style.display = 'none';
            }

            updateProvinceOptions() {
                if (!this.csvData) return;
                
                const allDesc = document.getElementById('all-desc');
                const ltDesc = document.getElementById('lt-desc');
                const rmDesc = document.getElementById('rm-desc');
                
                if (allDesc) allDesc.textContent = `${this.formatEuroK(this.csvData.generale.annoCorrente)} • ${this.csvData.generale.clienti} clienti`;
                if (ltDesc) ltDesc.textContent = `${this.formatEuroK(this.csvData.latina.annoCorrente)} • ${this.csvData.latina.clientiCorrente} clienti`;
                if (rmDesc) rmDesc.textContent = `${this.formatEuroK(this.csvData.roma.annoCorrente)} • ${this.csvData.roma.clienti} clienti`;
                
                // Update selected state
                document.querySelectorAll('.province-option').forEach(option => {
                    const province = option.dataset.province;
                    if (province === this.selectedProvince) {
                        option.style.border = '2px solid #3b82f6';
                        option.style.background = '#f0f9ff';
                    } else {
                        option.style.border = '2px solid #e5e7eb';
                        option.style.background = 'white';
                    }
                });
            }

            selectProvince(province) {
                this.selectedProvince = province;
                
                const labels = { 
                    all: 'Tutte le Province', 
                    LT: 'Provincia Latina', 
                    RM: 'Provincia Roma' 
                };
                
                document.getElementById('current-filter').textContent = labels[province] || 'Tutte le Province';
                this.hideProvincePopup();
                this.updateDashboard();
            }

            async loadData() {
                this.isLoading = true;
                this.showLoading();

                try {
                    console.log('=== INIZIO CARICAMENTO DATI ===');
                    
                    // PRIMA prova i dati di esempio per verificare che tutto funzioni
                    console.log('Tentativo 1: Uso dati di esempio per test');
                    const sampleData = this.createSampleCSV();
                    this.csvData = this.parseCSV(sampleData);
                    
                    if (this.csvData) {
                        console.log('✅ Test con dati di esempio SUCCESSO');
                        this.showSuccess();
                        this.updateDashboard();
                        
                        // Ora prova a caricare il CSV reale in background
                        console.log('Tentativo 2: Caricamento CSV reale in background...');
                        this.tryLoadRealCSV();
                        return;
                    }
                    
                    throw new Error('Errore anche con dati di esempio - problema nel codice');
                    
                } catch (error) {
                    console.error('Errore totale:', error);
                    this.showError('Errore critico: ' + error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            // Nuova funzione per provare il CSV reale in background
            async tryLoadRealCSV() {
                try {
                    console.log('🔄 Tentativo caricamento CSV reale...');
                    const result = await this.tryLoadCSV();
                    const realData = this.parseCSV(result);
                    
                    if (realData && realData.generale.clienti > 0) {
                        console.log('✅ CSV reale caricato, aggiorno dashboard');
                        this.csvData = realData;
                        this.updateDashboard();
                        
                        // Aggiorna il badge di status
                        const statusBadge = document.querySelector('.status-bar .status-item:last-child span');
                        if (statusBadge) statusBadge.textContent = 'Dati CSV reali caricati';
                    } else {
                        console.warn('⚠️ CSV reale non valido, mantengo dati di esempio');
                    }
                } catch (error) {
                    console.warn('⚠️ CSV reale non disponibile:', error.message);
                    console.log('💡 Dashboard funziona con dati di esempio');
                }
            }

            async tryLoadCSV() {
                const candidates = this.buildCandidateUrls();
                let csvText = null;
                
                console.log('Trying to load CSV from these URLs:', candidates);
                
                for (const url of candidates) {
                    try {
                        console.log('Attempting to load:', url);
                        
                        // Fetch con timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        
                        const response = await fetch(url + '?t=' + Date.now(), {
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log(`Response for ${url}:`, response.status, response.ok);
                        if (response.ok) {
                            csvText = await response.text();
                            if (csvText && csvText.trim().length > 0) {
                                console.log('Successfully loaded CSV from:', url);
                                console.log('CSV content preview:', csvText.substring(0, 200));
                                return csvText;
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to load from:', url, e.message);
                        if (e.name === 'AbortError') {
                            console.warn('Request timed out for:', url);
                        }
                    }
                }

                // Se nessun URL funziona, usa dati di esempio
                console.warn('No CSV found, using sample data');
                return this.createSampleCSV();
            }

            createSampleCSV() {
                return `==================== CARABOT NATALINO ====================;;;;;;;;
;;;;;;;;
=== INFORMAZIONI AGENTE ===;;;;;;;;
Codice Agente;Ragione Sociale;Dalla data;Alla data;;;;;
631.00238;CARABOT NATALINO;01/01/2025;17/08/2025;;;;;
;;;;;;;;
=== VERIFICA OBIETTIVI ===;;;;;;;;
Provincia;AnnoPrec.;AnnoCorr.;Obiettivo;% su obiet.;ClientiAnnoPrec.;ClientiAnnoCorr.;Obiettivo;% su obiet.
Generale;80238;90159;;;20;20;;
LT;79029;82389;150000;55%;23;18;35;51%
;;;;;;;;
=== CLIENTI PER PROVINCIA ===;;;;;;;;
Provincia;Clienti Serviti;Fatturato;;;;;;
LT;18;82389;;;;;;
RM;2;7770;;;;;;
;;;;;;;;
=== DETTAGLIO VENDITE PER CLIENTE ===;;;;;;;;
Provincia;Ragione Sociale Cliente;Categoria ARTICOLI;Fatturato;;;;;
LT;EDILIZIA SETINA S.R.L.;MATTONE PIENO;3177;;;;;
LT;ROSSETTI EDILIZIA SRL;FACCIAVISTA;1894;;;;;
LT;F.LLI TORA SRL;MATTONE PIENO;4497;;;;;
LT;ADDESSI COMMERCIALE SRL;MATTONE PIENO;4934;;;;;
LT;CENTRO EDILE DE GREGORIS SRL;MATTONE PIENO;9139;;;;;
RM;DOVAL SRL;REFRATTARI;1019;;;;;
LT;ROSANCOS SRL;MATTONE PIENO;2133;;;;;
LT;EDILCERAMICA SAS;MATTONE PIENO;1440;;;;;
LT;D'URSO MAT.DA COSTRUZIONE;MATTONE PIENO;4576;;;;;
LT;DIMED SRL;MATTONE PIENO;1326;;;;;
;;;;;;;;
=== RIEPILOGO PER CATEGORIA ===;;;;;;;;
Categoria;Importo Totale;Provincia LT Clienti;Provincia RM Clienti;;;;;
MATTONE PIENO;38558;16;1;;;;;
PAVIMENTAZIONE POLIS;15686;13;1;;;;;
REFRATTARI;4910;4;1;;;;;
REFRATTARI RETTIFICATI;5367;5;0;;;;;
FACCIAVISTA;1591;2;0;;;;;
LINEA ARCHEO;746;2;1;;;;;
COPERTURE;3;1;0;;;;;
;;;;;;;;`;
            }

            buildCandidateUrls() {
                const { pathname, origin } = window.location;
                const segs = pathname.split('/').filter(Boolean);
                const repoSlug = segs.length ? segs[0] : '';

                const bases = [
                    './docs/',
                    'docs/',
                    '/docs/',
                    `/${repoSlug}/docs/`,
                    './',
                    '',
                    pathname.endsWith('/') ? pathname : pathname.replace(/[^/]*$/, ''),
                    repoSlug ? `/${repoSlug}/` : '/'
                ];

                const urls = [];
                for (const base of bases) {
                    for (const name of this.csvFileNames) {
                        try {
                            urls.push(new URL(base + name, origin).href);
                        } catch (e) {}
                    }
                }
                console.log('Candidate URLs:', [...new Set(urls)]);
                return [...new Set(urls)];
            }

            parseCSV(csvText) {
                try {
                    console.log('🔍 Inizio parsing CSV, lunghezza:', csvText.length);
                    console.log('📋 Prime 500 caratteri del CSV:', csvText.substring(0, 500));
                    
                    // Verifica presenza sezioni principali
                    const hasObiettivi = csvText.includes('=== VERIFICA OBIETTIVI ===');
                    const hasClienti = csvText.includes('=== CLIENTI PER PROVINCIA ===');
                    const hasVendite = csvText.includes('=== DETTAGLIO VENDITE PER CLIENTE ===');
                    const hasCategorie = csvText.includes('=== RIEPILOGO PER CATEGORIA ===');
                    
                    console.log('📊 Sezioni trovate:', { hasObiettivi, hasClienti, hasVendite, hasCategorie });
                    
                    // Parse OBIETTIVI section con pattern più flessibile
                    const obiettiviMatch = csvText.match(/=== VERIFICA OBIETTIVI ===([\s\S]*?)(?===.*===|$)/);
                    if (!obiettiviMatch) {
                        console.error('❌ Sezione VERIFICA OBIETTIVI non trovata');
                        throw new Error('Sezione VERIFICA OBIETTIVI non trovata nel CSV');
                    }
                    
                    const obiettiviText = obiettiviMatch[1];
                    console.log('🎯 Testo sezione obiettivi:', obiettiviText.substring(0, 200));
                    
                    // Parse GENERALE data con pattern più robusto
                    const generalePattern = /Generale[;\s]*([\d.,]+)[;\s]*([\d.,]+)[;\s]*[;\s]*[;\s]*(\d+)[;\s]*(\d+)/;
                    const generaleMatch = obiettiviText.match(generalePattern);
                    
                    if (!generaleMatch) {
                        console.error('❌ Dati Generale non trovati nel pattern:', generalePattern);
                        console.log('🔍 Righe che contengono "Generale":', 
                            obiettiviText.split('\n').filter(line => line.includes('Generale')));
                        throw new Error('Dati Generale non trovati - controlla formato CSV');
                    }
                    
                    const generale = {
                        annoPrecedente: this.parseNumber(generaleMatch[1]),
                        annoCorrente: this.parseNumber(generaleMatch[2]),
                        clienti: parseInt(generaleMatch[4], 10) || 0
                    };
                    console.log('✅ Dati Generale parsati:', generale);

                    // Parse LATINA data con pattern più flessibile
                    const ltPattern = /LT[;\s]*([\d.,]+)[;\s]*([\d.,]+)[;\s]*([\d.,]+)[;\s]*(\d+)%[;\s]*(\d+)[;\s]*(\d+)[;\s]*(\d+)[;\s]*(\d+)%/;
                    const ltMatch = obiettiviText.match(ltPattern);
                    
                    let latina = {
                        annoPrecedente: 0, annoCorrente: 0, obiettivo: 0, percentualeObiettivo: 0,
                        clientiPrecedenti: 0, clientiCorrente: 0, obiettivoClienti: 0, percentualeClienti: 0
                    };
                    
                    if (ltMatch) {
                        latina = {
                            annoPrecedente: this.parseNumber(ltMatch[1]),
                            annoCorrente: this.parseNumber(ltMatch[2]),
                            obiettivo: this.parseNumber(ltMatch[3]),
                            percentualeObiettivo: parseInt(ltMatch[4], 10) || 0,
                            clientiPrecedenti: parseInt(ltMatch[5], 10) || 0,
                            clientiCorrente: parseInt(ltMatch[6], 10) || 0,
                            obiettivoClienti: parseInt(ltMatch[7], 10) || 0,
                            percentualeClienti: parseInt(ltMatch[8], 10) || 0
                        };
                        console.log('✅ Dati Latina parsati:', latina);
                    } else {
                        console.warn('⚠️ Dati Latina non trovati, uso valori predefiniti');
                        console.log('🔍 Righe che contengono "LT":', 
                            obiettiviText.split('\n').filter(line => line.includes('LT')));
                    }

                    // Parse ROMA data con fallback
                    let roma = { annoCorrente: 0, clienti: 0 };
                    const clientiMatch = csvText.match(/=== CLIENTI PER PROVINCIA ===([\s\S]*?)(?===.*===|$)/);
                    if (clientiMatch) {
                        const rmMatch = clientiMatch[1].match(/RM[;\s]*(\d+)[;\s]*([\d.,]+)/);
                        if (rmMatch) {
                            roma = {
                                annoCorrente: this.parseNumber(rmMatch[2]),
                                clienti: parseInt(rmMatch[1], 10) || 0
                            };
                            console.log('✅ Dati Roma parsati:', roma);
                        } else {
                            console.warn('⚠️ Dati RM non trovati nella sezione clienti');
                        }
                    }

                    // Parse DETTAGLIO VENDITE PER CLIENTE
                    let vendite = [];
                    const venditeMatch = csvText.match(/=== DETTAGLIO VENDITE PER CLIENTE ===([\s\S]*?)(?===.*===|$)/);
                    if (venditeMatch) {
                        const venditeText = venditeMatch[1];
                        console.log('💼 Parsing vendite, righe trovate:', venditeText.split('\n').length);
                        
                        const lines = venditeText.split('\n').filter(line => {
                            const trimmed = line.trim();
                            return trimmed && 
                                   !trimmed.includes('===') && 
                                   !trimmed.includes('Provincia;Ragione Sociale Cliente') && 
                                   trimmed.includes(';') && 
                                   trimmed.split(';').length >= 4;
                        });

                        const venditeMap = new Map();
                        lines.forEach((line, index) => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const fatturato = this.parseNumber(parts[3]);
                                if (!isNaN(fatturato) && fatturato > 0) {
                                    const cliente = parts[1].trim();
                                    if (cliente) {
                                        if (!venditeMap.has(cliente)) {
                                            venditeMap.set(cliente, {
                                                provincia: parts[0].trim(),
                                                cliente: cliente,
                                                categoria: parts[2].trim(),
                                                fatturato: 0
                                            });
                                        }
                                        venditeMap.get(cliente).fatturato += fatturato;
                                    }
                                }
                            }
                        });

                        vendite = Array.from(venditeMap.values())
                            .sort((a, b) => b.fatturato - a.fatturato)
                            .slice(0, 10);
                        
                        console.log(`✅ Vendite parsate: ${vendite.length} clienti top`);
                    } else {
                        console.warn('⚠️ Sezione DETTAGLIO VENDITE non trovata');
                    }

                    // Parse CATEGORIE data
                    let categorie = [];
                    const categorieMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===([\s\S]*?)(?===.*===|$)/);
                    if (categorieMatch) {
                        const categorieSection = categorieMatch[1];
                        console.log('📋 Parsing categorie, righe trovate:', categorieSection.split('\n').length);
                        
                        const lines = categorieSection.split('\n').filter(line => {
                            const trimmed = line.trim();
                            return trimmed && 
                                   !trimmed.includes('===') && 
                                   !trimmed.includes('Categoria;Importo Totale') && 
                                   trimmed.includes(';') && 
                                   trimmed.split(';').length >= 4;
                        });
                        
                        lines.forEach((line, index) => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const categoria = parts[0].trim();
                                const importo = this.parseNumber(parts[1]);
                                const clientiLT = parseInt(parts[2]) || 0;
                                const clientiRM = parseInt(parts[3]) || 0;
                                
                                if (categoria && importo > 0) {
                                    categorie.push({
                                        nome: categoria,
                                        importo: importo,
                                        clientiLT: clientiLT,
                                        clientiRM: clientiRM
                                    });
                                }
                            }
                        });

                        categorie.sort((a, b) => b.importo - a.importo);
                        console.log(`✅ Categorie parsate: ${categorie.length} categorie`);
                    } else {
                        console.warn('⚠️ Sezione RIEPILOGO PER CATEGORIA non trovata');
                    }

                    const result = { generale, latina, roma, categorie, vendite };
                    console.log('🎉 Parsing completato con successo:', {
                        generale: !!result.generale,
                        latina: !!result.latina,
                        roma: !!result.roma,
                        vendite: result.vendite.length,
                        categorie: result.categorie.length
                    });
                    
                    return result;
                    
                } catch (e) {
                    console.error('💥 Errore parsing CSV:', e);
                    console.log('📄 Contenuto CSV completo per debug:', csvText);
                    return null;
                }
            }

            parseNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                return Number(String(input).replace(/\s+/g, '').replace(/€/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
            }

            formatEuroK(value) {
                if (!value) return '€0k';
                const k = Math.round(value / 1000);
                return `€${k}k`;
            }

            // NEW: restituisce {value:Number|null, text:String} per gestire 0/negativi/NaN
            calculateGrowthPercentageSafe(current, previous) {
                if (previous === 0 || previous === null || previous === undefined) return { value: null, text: 'N/A' };
                const v = ((current - previous) / previous) * 100;
                const fixed = Number.isFinite(v) ? v.toFixed(1) : null;
                return { value: fixed !== null ? parseFloat(fixed) : null, text: fixed !== null ? `${fixed}%` : 'N/A' };
            }

            // NEW: formatta con segno esplicito
            formatSignedPercent(val) {
                if (val === null || val === undefined) return 'N/A';
                const sign = val > 0 ? '+' : '';
                return `${sign}${val.toFixed(1)}%`;
            }

            calculateGrowthPercentage(current, previous) {
                if (!previous) return '0.0';
                return (((current - previous) / previous) * 100).toFixed(1);
            }

            getDisplayData() {
                if (!this.csvData) return null;
                
                switch (this.selectedProvince) {
                    case 'all':
                        return {
                            fatturato: this.csvData.generale.annoCorrente,
                            fatturatoVs: this.csvData.generale.annoPrecedente,
                            clienti: this.csvData.generale.clienti,
                            obiettivo: this.csvData.latina.obiettivo, // Use Latina target for general view
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.latina.obiettivoClienti,
                            percentualeClienti: this.csvData.latina.percentualeClienti
                        };
                    case 'LT':
                        return {
                            fatturato: this.csvData.latina.annoCorrente,
                            fatturatoVs: this.csvData.latina.annoPrecedente,
                            clienti: this.csvData.latina.clientiCorrente,
                            obiettivo: this.csvData.latina.obiettivo,
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.latina.obiettivoClienti,
                            percentualeClienti: this.csvData.latina.percentualeClienti
                        };
                    case 'RM':
                        return {
                            fatturato: this.csvData.roma.annoCorrente,
                            fatturatoVs: 0,
                            clienti: this.csvData.roma.clienti,
                            obiettivo: null,
                            percentualeObiettivo: null,
                            obiettivoClienti: null,
                            percentualeClienti: null
                        };
                    default:
                        return null;
                }
            }

            updateDashboard() {
                const data = this.getDisplayData();
                if (!data) return;

                // Calculate growth with safe method
                const growth = this.calculateGrowthPercentageSafe(data.fatturato, data.fatturatoVs);
                
                // Update Fatturato Card
                document.getElementById('fatturato-value').textContent = this.formatEuroK(data.fatturato);
                document.getElementById('fatturato-vs').textContent = this.formatEuroK(data.fatturatoVs);
                document.getElementById('growth-badge').textContent = growth.value === null ? 'N/A' : this.formatSignedPercent(growth.value);
                
                if (data.obiettivo) {
                    document.getElementById('obiettivo-fatturato').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('fatturato-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('fatturato-percentage').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Animate progress bar
                    setTimeout(() => {
                        document.getElementById('progress-fatturato').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 100);
                }

                // Update Obiettivo Card
                if (data.obiettivo) {
                    document.getElementById('obiettivo-value').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-percentage').textContent = `${data.percentualeObiettivo}%`;
                    document.getElementById('obiettivo-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-target').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-mancano').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-perc-display').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Update badge color
                    const badge = document.getElementById('obiettivo-badge');
                    if (data.percentualeObiettivo >= 80) {
                        badge.className = 'card-badge';
                    } else {
                        badge.className = 'card-badge warning';
                    }
                    
                    setTimeout(() => {
                        document.getElementById('progress-obiettivo').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 200);
                } else {
                    // Hide objective elements for provinces without targets
                    document.getElementById('obiettivo-value').textContent = 'N/A';
                    document.getElementById('obiettivo-percentage').textContent = 'N/A';
                    document.getElementById('progress-obiettivo').style.width = '0%';
                }

                // Update Top Performance Card (always show best province)
                const topProvince = this.csvData.latina.annoCorrente > this.csvData.roma.annoCorrente ? 'LT' : 'RM';
                const topData = topProvince === 'LT' ? this.csvData.latina : this.csvData.roma;
                const topGrowthObj = topProvince === 'LT'
                    ? this.calculateGrowthPercentageSafe(this.csvData.latina.annoCorrente, this.csvData.latina.annoPrecedente)
                    : { value: null, text: 'N/A' };
                    
                document.getElementById('top-province').textContent = topProvince;
                document.getElementById('province-growth').textContent = topProvince === 'RM' ? '+∞%' : (topGrowthObj.value === null ? 'N/A' : this.formatSignedPercent(topGrowthObj.value));
                document.getElementById('province-amount').textContent = this.formatEuroK(topData.annoCorrente);
                
                const growthAmount = topProvince === 'LT' ? 
                    (this.csvData.latina.annoCorrente - this.csvData.latina.annoPrecedente) : 0;
                document.getElementById('trend-growth').textContent = growthAmount >= 0 ? `+${this.formatEuroK(growthAmount)}` : `-${this.formatEuroK(Math.abs(growthAmount))}`;

                // Update Clienti Card
                document.getElementById('clienti-count').textContent = data.clienti;
                
                if (data.obiettivoClienti && data.percentualeClienti) {
                    document.getElementById('clienti-obiettivo').textContent = data.obiettivoClienti;
                    document.getElementById('clienti-percentage').textContent = `${data.percentualeClienti}%`;
                    document.getElementById('clienti-target-value').textContent = data.obiettivoClienti;
                    document.getElementById('clienti-mancanti').textContent = `${Math.max(0, data.obiettivoClienti - data.clienti)} clienti`;
                    document.getElementById('clienti-perc-display').textContent = `${data.percentualeClienti}%`;
                    
                    setTimeout(() => {
                        document.getElementById('progress-clienti').style.width = `${Math.min(100, data.percentualeClienti)}%`;
                    }, 300);
                } else {
                    document.getElementById('clienti-obiettivo').textContent = 'N/A';
                    document.getElementById('clienti-percentage').textContent = 'N/A';
                    document.getElementById('progress-clienti').style.width = '0%';
                }

                // Update charts and data displays
                this.updateChartsAndDisplays();
                this.renderVenditeTable();  // NUOVA CHIAMATA
                this.renderCategorieTable(); // NUOVA CHIAMATA
            }

            // NUOVA FUNZIONE - Render tabella vendite
            renderVenditeTable() {
                const tbody = document.getElementById('vendite-tbody');
                if (!tbody || !this.csvData.vendite) return;

                tbody.innerHTML = '';
                
                this.csvData.vendite.forEach(vendita => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(107, 114, 128, 0.05)';
                    row.innerHTML = `
                        <td style="padding: 0.75rem 1rem;"><span class="province-badge ${vendita.provincia}">${vendita.provincia}</span></td>
                        <td style="padding: 0.75rem 1rem;">${vendita.cliente.length > 35 ? vendita.cliente.slice(0, 35) + '...' : vendita.cliente}</td>
                        <td style="padding: 0.75rem 1rem;">${vendita.categoria}</td>
                        <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 700; color: #1f2937;">${this.formatEuroK(vendita.fatturato)}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('top-clients-count').textContent = this.csvData.vendite.length;
                const topTotal = this.csvData.vendite.reduce((sum, v) => sum + v.fatturato, 0);
                document.getElementById('top-fatturato-total').textContent = this.formatEuroK(topTotal);
            }

            // NUOVA FUNZIONE - Render tabella categorie
            renderCategorieTable() {
                const tbody = document.getElementById('categorie-tbody');
                if (!tbody || !this.csvData.categorie) return;

                tbody.innerHTML = '';
                
                const totale = this.csvData.categorie.reduce((sum, cat) => sum + cat.importo, 0);
                
                this.csvData.categorie.forEach(categoria => {
                    const percentuale = totale > 0 ? ((categoria.importo / totale) * 100).toFixed(1) : '0.0';
                    
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid rgba(107, 114, 128, 0.05)';
                    row.innerHTML = `
                        <td style="padding: 0.75rem 1rem; font-weight: 600;">${categoria.nome}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${categoria.clientiLT}</td>
                        <td style="padding: 0.75rem 1rem; text-align: center;">${categoria.clientiRM}</td>
                        <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 700; color: #1f2937;">${this.formatEuroK(categoria.importo)}</td>
                        <td style="padding: 0.75rem 1rem; text-align: right; font-weight: 600; color: #3b82f6;">${percentuale}%</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('categorie-fatturato-totale').textContent = this.formatEuroK(totale);
            }

            // REPLACE della vecchia createClientiChart()
            _buildClientiChart(ctx) {
                const ltClienti = this.csvData.latina.clientiCorrente;
                const rmClienti = this.csvData.roma.clienti;
                const ltPrevClienti = this.csvData.latina.clientiPrecedenti;

                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            { label: '2024', data: [ltPrevClienti, 0], backgroundColor: '#cbd5e1', borderRadius: 8, maxBarThickness: 60 },
                            { label: '2025', data: [ltClienti, rmClienti], backgroundColor: ['#22d3ee', '#22d3ee'], borderRadius: 8, maxBarThickness: 60 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.raw} clienti` } } },
                        scales: {
                            y: { beginAtZero: true, suggestedMax: Math.max(24, ltClienti, rmClienti, ltPrevClienti) + 2, ticks: { stepSize: 4, color: '#6b7280' }, grid: { color: '#e5e7eb' } },
                            x: { ticks: { color: '#6b7280', font: { size: 12, weight: '600' } }, grid: { display: false } }
                        },
                        animation: { duration: 1200, easing: 'easeOutBounce' }
                    }
                });
            }

            // REPLACE della vecchia createFatturatoChart()
            _buildFatturatoChart(ctx) {
                const ltF = this.csvData.latina.annoCorrente;
                const rmF = this.csvData.roma.annoCorrente;
                const ltPrevF = this.csvData.latina.annoPrecedente;
                const maxValue = Math.max(ltF, rmF, ltPrevF) * 1.25;

                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            { label: '2024', data: [ltPrevF, 0], backgroundColor: '#cbd5e1', borderRadius: 8, maxBarThickness: 80 },
                            { label: '2025', data: [ltF, rmF], backgroundColor: ['#8b5cf6', '#6366f1'], borderRadius: 8, maxBarThickness: 80 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${this.formatEuroK(c.raw)}` } } },
                        scales: {
                            y: {
                                beginAtZero: true, suggestedMax: maxValue,
                                ticks: { callback: (v) => `€${Math.round(v/1000)}k`, color: '#6b7280' },
                                grid: { color: '#e5e7eb' }
                            },
                            x: { ticks: { color: '#6b7280', font: { size: 12, weight: '600' } }, grid: { display: false } }
                        },
                        animation: { duration: 1200, easing: 'easeOutQuart' }
                    }
                });
            }

            // REPLACE della vecchia createProvinceDistributionChart()
            _buildDistribuzioneProvinceChart(ctx) {
                const lt = this.csvData.latina.annoCorrente;
                const rm = this.csvData.roma.annoCorrente;
                const total = lt + rm || 1;

                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Latina (LT)', 'Roma (RM)'],
                        datasets: [{
                            data: [lt, rm],
                            backgroundColor: ['#a855f7', '#22d3ee'],
                            borderColor: ['#7c3aed', '#0891b2'],
                            borderWidth: 3, cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (c) => `${c.label}: ${this.formatEuroK(c.raw)} (${((c.raw/total)*100).toFixed(1)}%)` } }
                        },
                        animation: { duration: 800, easing: 'easeOutCubic' }
                    }
                });
            }

            // REPLACE della vecchia createMixProdottiChart()
            _buildMixProdottiChart(ctx) {
                const mix = this.calculateMixProdotti();
                const total = (mix.core.importo + mix.others.importo) || 1;

                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mattone + Pavimentazione', 'Altri Prodotti'],
                        datasets: [{
                            data: [mix.core.importo, mix.others.importo],
                            backgroundColor: ['#3b82f6', '#6b7280'],
                            borderColor: ['#1e40af', '#4b5563'],
                            borderWidth: 3, cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: (c) => `${c.label}: ${this.formatEuro(c.raw)} (${((c.raw/total)*100).toFixed(1)}%)` } }
                        },
                        animation: { duration: 800, easing: 'easeOutCubic' }
                    }
                });
            }

            updateDistribuzioneProvince() {
                const ltFatturato = this.csvData.latina.annoCorrente;
                const rmFatturato = this.csvData.roma.annoCorrente;
                const total = ltFatturato + rmFatturato;

                if (total > 0) {
                    const ltPercentage = ((ltFatturato / total) * 100).toFixed(1);
                    const rmPercentage = ((rmFatturato / total) * 100).toFixed(1);

                    document.getElementById('dist-lt-percentage').textContent = `${ltPercentage}%`;
                    document.getElementById('dist-rm-percentage').textContent = `${rmPercentage}%`;
                    document.getElementById('dist-lt-amount').textContent = this.formatEuro(ltFatturato);
                    document.getElementById('dist-rm-amount').textContent = this.formatEuro(rmFatturato);
                }
            }

            // Mantiene i metodi originali necessari
            updateRiepilogoClienti() {
                // Update Latina data
                document.getElementById('riepilogo-lt-clienti-2025').textContent = this.csvData.latina.clientiCorrente;
                document.getElementById('riepilogo-lt-fatturato-k').textContent = this.formatEuroK(this.csvData.latina.annoCorrente);
                document.getElementById('riepilogo-lt-clienti-2024').textContent = this.csvData.latina.clientiPrecedenti;

                // Calculate average per client for Latina
                const ltMedio = this.csvData.latina.clientiCorrente > 0 ? 
                    this.csvData.latina.annoCorrente / this.csvData.latina.clientiCorrente : 0;
                document.getElementById('riepilogo-lt-medio').textContent = this.formatEuroK(ltMedio);

                // Calculate difference for Latina
                const ltDifference = this.csvData.latina.clientiCorrente - this.csvData.latina.clientiPrecedenti;
                const ltDifferenceEl = document.getElementById('riepilogo-lt-difference');
                const ltComparisonBox = document.getElementById('lt-comparison-box');
                const ltComparisonText = document.getElementById('lt-comparison-text');
                
                if (ltDifference >= 0) {
                    ltDifferenceEl.textContent = `+${ltDifference} ↑`;
                    ltDifferenceEl.style.background = '#a7f3d0';
                    ltDifferenceEl.style.color = '#059669';
                    ltComparisonBox.style.background = '#d1fae5';
                    ltComparisonBox.style.borderColor = '#a7f3d0';
                    ltComparisonText.style.color = '#059669';
                } else {
                    ltDifferenceEl.textContent = `${ltDifference} ↓`;
                    ltDifferenceEl.style.background = '#fecaca';
                    ltDifferenceEl.style.color = '#dc2626';
                    ltComparisonBox.style.background = '#fee2e2';
                    ltComparisonBox.style.borderColor = '#fecaca';
                    ltComparisonText.style.color = '#dc2626';
                }

                // Update Roma data
                document.getElementById('riepilogo-rm-clienti-2025').textContent = this.csvData.roma.clienti;
                document.getElementById('riepilogo-rm-fatturato-k').textContent = this.formatEuroK(this.csvData.roma.annoCorrente);
                document.getElementById('riepilogo-rm-clienti-2024').textContent = '0';

                // Calculate average per client for Roma
                const rmMedio = this.csvData.roma.clienti > 0 ? 
                    this.csvData.roma.annoCorrente / this.csvData.roma.clienti : 0;
                document.getElementById('riepilogo-rm-medio').textContent = this.formatEuroK(rmMedio);
            }

            formatEuro(value) {
                const ctx = document.getElementById('mixProdottiChart');
                if (!ctx) return;

                const mixData = this.calculateMixProdotti();

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mattone + Pavimentazione', 'Altri Prodotti'],
                        datasets: [{
                            data: [mixData.core.importo, mixData.others.importo],
                            backgroundColor: ['#3b82f6', '#6b7280'],
                            borderColor: ['#1e40af', '#4b5563'],
                            borderWidth: 3,
                            cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuro(context.raw);
                                        const percentage = mixData.core.importo + mixData.others.importo > 0 ? 
                                            ((context.raw / (mixData.core.importo + mixData.others.importo)) * 100).toFixed(1) : '0';
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutBounce'
                        }
                    }
                });
            }

            calculateMixProdotti() {
                if (!this.csvData.categorie || this.csvData.categorie.length === 0) {
                    return {
                        core: { importo: 45000, mattone: 30000, pavimentazione: 15000 },
                        others: { importo: 15000, refrattari: 10000, altri: 5000 }
                    };
                }

                const categorie = this.csvData.categorie;
                let mattone = 0, pavimentazione = 0, refrattari = 0, altri = 0;

                categorie.forEach(cat => {
                    const nome = cat.nome.toLowerCase();
                    if (nome.includes('mattone') || nome.includes('laterizio')) {
                        mattone += cat.importo;
                    } else if (nome.includes('paviment') || nome.includes('cotto')) {
                        pavimentazione += cat.importo;
                    } else if (nome.includes('refratt')) {
                        refrattari += cat.importo;
                    } else {
                        altri += cat.importo;
                    }
                });

                const coreImporto = mattone + pavimentazione;
                const othersImporto = refrattari + altri;

                return {
                    core: { importo: coreImporto, mattone, pavimentazione },
                    others: { importo: othersImporto, refrattari, altri },
                    total: coreImporto + othersImporto
                };
            }

            updateMixProdottiData() {
                const mixData = this.calculateMixProdotti();
                const total = mixData.total;

                if (total > 0) {
                    // Calculate percentages
                    const corePercentage = ((mixData.core.importo / total) * 100).toFixed(1);
                    const othersPercentage = ((mixData.others.importo / total) * 100).toFixed(1);

                    // Update percentages
                    document.getElementById('core-percentage').textContent = `${corePercentage}%`;
                    document.getElementById('other-percentage').textContent = `${othersPercentage}%`;

                    // Update amounts
                    document.getElementById('core-amount').textContent = this.formatEuro(mixData.core.importo);
                    document.getElementById('other-amount').textContent = this.formatEuro(mixData.others.importo);

                    // Update breakdown
                    document.getElementById('mattone-amount').textContent = this.formatEuroK(mixData.core.mattone);
                    document.getElementById('pavimentazione-amount').textContent = this.formatEuroK(mixData.core.pavimentazione);
                    document.getElementById('refrattari-amount').textContent = this.formatEuroK(mixData.others.refrattari);
                    document.getElementById('altri-amount').textContent = this.formatEuroK(mixData.others.altri);

                    // Update performance metrics
                    document.getElementById('core-perf').textContent = `${corePercentage}%`;
                    document.getElementById('categories-count').textContent = this.csvData.categorie.length;
                    
                    // Calculate involved clients (estimate based on categories)
                    const involvedClients = Math.min(this.csvData.generale.clienti, this.csvData.categorie.length * 3);
                    document.getElementById('involved-clients').textContent = involvedClients;
                }
            }

            formatEuro(value) {
                if (!value) return '0 €';
                if (value >= 1000) {
                    return `${(value / 1000).toFixed(3)} €`.replace('.', ',');
                }
                return `${Math.round(value)} €`;
            }

            updateProvinceDisplays() {
                // Update Clienti displays
                document.getElementById('lt-clienti-count').textContent = `${this.csvData.latina.clientiCorrente} clienti`;
                document.getElementById('rm-clienti-count').textContent = `${this.csvData.roma.clienti} clienti`;

                // Calculate client growth for LT using safe method
                const ltClientGrowthObj = this.calculateGrowthPercentageSafe(this.csvData.latina.clientiCorrente, this.csvData.latina.clientiPrecedenti);
                
                // Update growth badges for clients
                const ltGrowthEl = document.getElementById('lt-growth');
                if (ltClientGrowthObj.value === null) {
                    ltGrowthEl.textContent = 'N/A';
                    ltGrowthEl.style.background = '#f3f4f6';
                    ltGrowthEl.style.color = '#6b7280';
                } else if (ltClientGrowthObj.value >= 0) {
                    ltGrowthEl.textContent = this.formatSignedPercent(ltClientGrowthObj.value);
                    ltGrowthEl.style.background = '#f0fdf4';
                    ltGrowthEl.style.color = '#16a34a';
                } else {
                    ltGrowthEl.textContent = this.formatSignedPercent(ltClientGrowthObj.value);
                    ltGrowthEl.style.background = '#fef2f2';
                    ltGrowthEl.style.color = '#dc2626';
                }

                // RM is new, so always positive
                document.getElementById('rm-growth').textContent = '+∞%';

                // Update Fatturato displays
                document.getElementById('lt-fatturato-display').textContent = this.formatEuroK(this.csvData.latina.annoCorrente);
                document.getElementById('lt-fatturato-prev').textContent = this.formatEuroK(this.csvData.latina.annoPrecedente);
                document.getElementById('rm-fatturato-display').textContent = this.formatEuroK(this.csvData.roma.annoCorrente);

                // Update fatturato growth using safe method
                const ltFatturatoGrowthObj = this.calculateGrowthPercentageSafe(this.csvData.latina.annoCorrente, this.csvData.latina.annoPrecedente);
                document.getElementById('lt-fatturato-growth').textContent = ltFatturatoGrowthObj.value === null ? 'N/A' : this.formatSignedPercent(ltFatturatoGrowthObj.value);
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveDashboard();
        });
    </script>
</body>
</html>
