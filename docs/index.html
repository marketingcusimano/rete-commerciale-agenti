<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          color: #1f2937;
          line-height: 1.6;
          transition: all 0.3s ease;
        }

        body.dark-mode {
          background: #0f172a;
          color: #f8fafc;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }

        /* Header */
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .header-info h1 {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .header-info h1 {
          color: #f8fafc;
        }

        .header-info p {
          color: #6b7280;
          font-size: 1.1rem;
          font-weight: 500;
        }

        .theme-toggle {
          background: #374151;
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1.25rem;
          width: 50px;
          height: 50px;
        }

        .theme-toggle:hover {
          background: #4b5563;
          transform: scale(1.1);
        }

        /* Status Bar */
        .status-bar {
          display: flex;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.9rem;
          color: #6b7280;
        }

        .status-item i {
          color: #3b82f6;
        }

        .status-item strong {
          color: #1f2937;
        }

        body.dark-mode .status-item strong {
          color: #f8fafc;
        }

        .status-dot {
          width: 8px;
          height: 8px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        /* Cards Grid */
        .cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }

        .card {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        body.dark-mode .card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .card:hover {
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1rem;
        }

        .card-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        .card-value {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .card-value {
          color: #f8fafc;
        }

        .card-subtitle {
          color: #6b7280;
          font-size: 0.9rem;
          margin-bottom: 1rem;
        }

        /* Loading States */
        .loading-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          color: #6b7280;
        }

        .loading-spinner {
          animation: spin 1s linear infinite;
          font-size: 2rem;
          margin-right: 1rem;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        .error-container {
          background: #fee2e2;
          color: #dc2626;
          padding: 1rem;
          border-radius: 0.75rem;
          text-align: center;
          margin: 2rem 0;
        }

        body.dark-mode .error-container {
          background: #7f1d1d;
          color: #fca5a5;
        }

        /* New sections */
        .ranking-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 1rem;
        }

        .ranking-table th {
          text-align: left;
          padding: 0.75rem;
          font-weight: 600;
          color: #374151;
          background: #f8fafc;
          border-bottom: 2px solid #e5e7eb;
          font-size: 0.875rem;
        }

        .ranking-table td {
          padding: 0.75rem;
          border-bottom: 1px solid #e5e7eb;
          font-size: 0.875rem;
        }

        .ranking-table tr:hover {
          background: #f8fafc;
        }

        .rank-number {
          width: 28px;
          height: 28px;
          border-radius: 50%;
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 0.875rem;
        }

        .rank-1 { background: #f59e0b; }
        .rank-2 { background: #6b7280; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: #3b82f6; }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> <span id="agent-code">631.00238</span></span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong id="period-text">01/01/2025 - 24/08/2025</strong></span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati aggiornati dal file CSV</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <!-- Basic Cards -->
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fatturato 2025</div>
                    </div>
                    <div class="card-value" id="fatturato-value">€0k</div>
                    <div class="card-subtitle">Periodo: Gen-Ago 2025</div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Clienti Attivi</div>
                    </div>
                    <div class="card-value" id="clienti-count">0</div>
                    <div class="card-subtitle">Province servite: <strong>2</strong></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Provincia Top</div>
                    </div>
                    <div class="card-value" id="provincia-top">LT</div>
                    <div class="card-subtitle">Latina - <strong id="lt-fatturato">€0k</strong></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Mix Prodotti</div>
                    </div>
                    <div class="card-value" id="top-category">Mattone</div>
                    <div class="card-subtitle">Categoria principale</div>
                </div>
            </div>

            <!-- Classifica Categorie -->
            <div class="card" style="margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937;">
                    Classifica Categorie per Fatturato
                </h3>
                <div style="overflow-x: auto;">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 60px; text-align: center;">#</th>
                                <th>Categoria</th>
                                <th style="text-align: right;">Fatturato</th>
                                <th style="text-align: center; color: #8b5cf6;">LT</th>
                                <th style="text-align: center; color: #22d3ee;">RM</th>
                                <th style="text-align: right;">%</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Top Vendite per Cliente -->
            <div class="card" style="margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #1f2937;">
                    Top 10 Vendite per Cliente
                </h3>
                <div style="overflow-x: auto;">
                    <table class="ranking-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">Provincia</th>
                                <th>Cliente</th>
                                <th>Categoria</th>
                                <th style="text-align: right;">Fatturato</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Dashboard {
            constructor() {
                this.csvData = null;
                this.init();
            }

            init() {
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                this.loadData();
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                }
            }

            async loadData() {
                this.showLoading();
                console.log('Starting data load...');
                
                try {
                    const csvText = await this.fetchCSV();
                    console.log('CSV loaded, parsing...');
                    
                    this.csvData = this.parseCSV(csvText);
                    console.log('Parsed data:', this.csvData);
                    
                    this.updateDashboard();
                    this.showSuccess();
                    
                } catch (error) {
                    console.error('Load error:', error);
                    this.showError(error.message);
                }
            }

            async fetchCSV() {
                const urls = [
                    './631.00238_CARABOT-NATALINO.csv',
                    './docs/631.00238_CARABOT-NATALINO.csv',
                    'docs/631.00238_CARABOT-NATALINO.csv'
                ];

                for (const url of urls) {
                    try {
                        const response = await fetch(url + '?t=' + Date.now());
                        if (response.ok) {
                            const text = await response.text();
                            if (text.trim().length > 0) {
                                console.log('CSV loaded from:', url);
                                return text;
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to load from:', url);
                    }
                }

                // Fallback data
                console.log('Using fallback data');
                return this.getFallbackCSV();
            }

            parseCSV(csvText) {
                console.log('Parsing CSV...');
                
                const data = {
                    fatturato: 90159.79,
                    clienti: 20,
                    ltFatturato: 60437.22,
                    rmFatturato: 7770.56,
                    categorie: [],
                    vendite: []
                };

                try {
                    // Parse RIEPILOGO PER CATEGORIA
                    const riepilogoMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===([\s\S]*?)(?:===|$)/);
                    if (riepilogoMatch) {
                        const lines = riepilogoMatch[1].split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('Categoria,Importo') &&
                            line.includes(',') &&
                            line.split(',').length >= 4
                        );

                        lines.forEach(line => {
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                const nome = parts[0].trim().replace(/"/g, '');
                                const importo = this.parseNumber(parts[1]);
                                const ltClienti = parseInt(parts[2]) || 0;
                                const rmClienti = parseInt(parts[3]) || 0;

                                if (nome && importo > 0) {
                                    data.categorie.push({
                                        nome: nome,
                                        importo: importo,
                                        ltClienti: ltClienti,
                                        rmClienti: rmClienti
                                    });
                                }
                            }
                        });

                        data.categorie.sort((a, b) => b.importo - a.importo);
                        console.log('Parsed categories:', data.categorie.length);
                    }

                    // Parse DETTAGLIO VENDITE
                    const venditeMat = csvText.match(/=== DETTAGLIO VENDITE PER CLIENTE ===([\s\S]*?)(?:===|$)/);
                    if (venditeMat) {
                        const lines = venditeMat[1].split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('Provincia,Ragione') &&
                            line.split(',').length >= 4
                        );

                        lines.forEach(line => {
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                const provincia = parts[0].trim();
                                const cliente = parts[1].trim();
                                const categoria = parts[2].trim();
                                const fatturato = this.parseNumber(parts[3]);

                                if (provincia && cliente && categoria && fatturato > 0) {
                                    data.vendite.push({
                                        provincia: provincia,
                                        cliente: cliente,
                                        categoria: categoria,
                                        fatturato: fatturato
                                    });
                                }
                            }
                        });

                        data.vendite.sort((a, b) => b.fatturato - a.fatturato);
                        console.log('Parsed sales:', data.vendite.length);
                    }

                } catch (error) {
                    console.error('Parse error:', error);
                }

                return data;
            }

            parseNumber(str) {
                if (!str) return 0;
                return parseFloat(str.replace(/"/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            }

            updateDashboard() {
                console.log('Updating dashboard...');
                
                // Update basic cards
                document.getElementById('fatturato-value').textContent = this.formatEuro(this.csvData.fatturato);
                document.getElementById('clienti-count').textContent = this.csvData.clienti;
                document.getElementById('lt-fatturato').textContent = this.formatEuro(this.csvData.ltFatturato);
                
                if (this.csvData.categorie.length > 0) {
                    document.getElementById('top-category').textContent = this.csvData.categorie[0].nome;
                }

                // Update ranking table
                this.updateRankingTable();
                this.updateSalesTable();
            }

            updateRankingTable() {
                const tbody = document.getElementById('ranking-table-body');
                if (!tbody || !this.csvData.categorie.length) {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #6b7280;">Nessuna categoria trovata nel CSV</td></tr>';
                    }
                    return;
                }

                const total = this.csvData.categorie.reduce((sum, cat) => sum + cat.importo, 0);

                tbody.innerHTML = this.csvData.categorie.map((cat, index) => {
                    const percentage = total > 0 ? ((cat.importo / total) * 100).toFixed(1) : '0';
                    const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';

                    return `
                        <tr>
                            <td style="text-align: center;">
                                <div class="rank-number ${rankClass}">${index + 1}</div>
                            </td>
                            <td style="font-weight: 600;">${cat.nome}</td>
                            <td style="text-align: right; font-weight: 700;">${this.formatEuro(cat.importo)}</td>
                            <td style="text-align: center;">
                                <span style="background: #f3e8ff; color: #8b5cf6; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                                    ${cat.ltClienti}
                                </span>
                            </td>
                            <td style="text-align: center;">
                                <span style="background: #ecfeff; color: #22d3ee; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                                    ${cat.rmClienti}
                                </span>
                            </td>
                            <td style="text-align: right; color: #059669; font-weight: 600;">${percentage}%</td>
                        </tr>
                    `;
                }).join('');

                console.log('Ranking table updated');
            }

            updateSalesTable() {
                const tbody = document.getElementById('sales-table-body');
                if (!tbody || !this.csvData.vendite.length) {
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem; color: #6b7280;">Nessuna vendita trovata nel CSV</td></tr>';
                    }
                    return;
                }

                const topSales = this.csvData.vendite.slice(0, 10);

                tbody.innerHTML = topSales.map(sale => {
                    const provinceColor = sale.provincia === 'LT' ? '#8b5cf6' : '#22d3ee';
                    return `
                        <tr>
                            <td>
                                <span style="background: ${provinceColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.75rem;">
                                    ${sale.provincia}
                                </span>
                            </td>
                            <td style="font-weight: 500;">${sale.cliente}</td>
                            <td style="color: #6b7280;">${sale.categoria}</td>
                            <td style="text-align: right; font-weight: 700; color: #059669;">${this.formatEuro(sale.fatturato)}</td>
                        </tr>
                    `;
                }).join('');

                console.log('Sales table updated');
            }

            formatEuro(value) {
                if (!value) return '€0';
                if (value >= 1000) {
                    return `€${(value / 1000).toFixed(0)}k`;
                }
                return `€${Math.round(value)}`;
            }

            getFallbackCSV() {
                return `=== RIEPILOGO PER CATEGORIA ===
MATTONE PIENO,"38558,64",16,1
PAVIMENTAZIONE POLIS,"15686,46",13,1
REFRATTARI RETTIFICATI,"5367,83",5,0
REFRATTARI,"4910,39",4,1
FACCIAVISTA,"1591,40",2,0
PIASTRELLE,"1240,95",1,0
LINEA ARCHEO,"746,68",2,1

=== DETTAGLIO VENDITE PER CLIENTE ===
LT,CENTRO EDILE DE GREGORIS SRL,MATTONE PIENO,"7776,00"
RM,COLANTUONO 1918 SRL,MATTONE PIENO,"5150,40"
LT,D'URSO MAT.DA COSTRUZIONE DI D'URSO S. & C SAS,MATTONE PIENO,"3744,00"
LT,ADDESSI COMMERCIALE SRL,MATTONE PIENO,"3693,60"
LT,EDILIZIA VENDITTI DI VENDITTI GIOVANNI E C. SNC,MATTONE PIENO,"3456,00"
LT,F.LLI TORA SRL,MATTONE PIENO,"3110,40"
LT,FER.COM. COSTRUZIONI SRL,PAVIMENTAZIONE POLIS,"2695,68"
LT,EDILIZIA VENDITTI DI VENDITTI GIOVANNI E C. SNC,PAVIMENTAZIONE POLIS,"2230,80"
LT,EDILIZIA PRIMAVERA SRL,REFRATTARI,"1969,92"
LT,BIANCHI INNOCENZO SAS DI BIANCHI ANNA RITA & C,REFRATTARI RETTIFICATI,"1935,58"`;
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, initializing dashboard...');
            new Dashboard();
        });
    </script>
</body>
</html>
