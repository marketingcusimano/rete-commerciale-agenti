<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          color: #1f2937;
          line-height: 1.6;
          transition: all 0.3s ease;
        }

        body.dark-mode {
          background: #0f172a;
          color: #f8fafc;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }

        /* Header */
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .header-info h1 {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .header-info h1 {
          color: #f8fafc;
        }

        .header-info p {
          color: #6b7280;
          font-size: 1.1rem;
          font-weight: 500;
        }

        .theme-toggle {
          background: #374151;
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1.25rem;
          width: 50px;
          height: 50px;
        }

        .theme-toggle:hover {
          background: #4b5563;
          transform: scale(1.1);
        }

        /* Status Bar */
        .status-bar {
          display: flex;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.9rem;
          color: #6b7280;
        }

        .status-item i {
          color: #3b82f6;
        }

        .status-item strong {
          color: #1f2937;
        }

        body.dark-mode .status-item strong {
          color: #f8fafc;
        }

        .status-dot {
          width: 8px;
          height: 8px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        /* Cards */
        .cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }

        .card {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: all 0.3s ease;
        }

        body.dark-mode .card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1rem;
        }

        .card-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        .card-value {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .card-value {
          color: #f8fafc;
        }

        /* Table Styles */
        .table-card {
          background: white;
          border-radius: 1rem;
          padding: 2rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          margin-bottom: 2rem;
        }

        body.dark-mode .table-card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .table-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
        }

        .table-header h3 {
          font-size: 1.5rem;
          font-weight: 700;
          color: #1f2937;
        }

        body.dark-mode .table-header h3 {
          color: #f8fafc;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        th, td {
          text-align: left;
          padding: 0.75rem 1rem;
          border-bottom: 1px solid #e5e7eb;
        }

        body.dark-mode th,
        body.dark-mode td {
          border-color: #374151;
        }

        th {
          background: #f8fafc;
          font-weight: 600;
          color: #374151;
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        body.dark-mode th {
          background: #374151;
          color: #d1d5db;
        }

        .province-badge {
          display: inline-block;
          padding: 0.25rem 0.5rem;
          border-radius: 9999px;
          font-size: 0.75rem;
          font-weight: 700;
        }

        .province-badge.LT {
          background: rgba(139, 92, 246, 0.1);
          color: #8b5cf6;
        }

        .province-badge.RM {
          background: rgba(34, 211, 238, 0.1);
          color: #22d3ee;
        }

        /* Charts */
        .charts-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: 2rem;
          margin-bottom: 2rem;
        }

        .chart-card {
          background: white;
          border-radius: 1rem;
          padding: 2rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
        }

        body.dark-mode .chart-card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .chart-header {
          margin-bottom: 1.5rem;
        }

        .chart-header h3 {
          font-size: 1.25rem;
          font-weight: 700;
          color: #1f2937;
        }

        body.dark-mode .chart-header h3 {
          color: #f8fafc;
        }

        .chart-container {
          position: relative;
          height: 300px;
        }

        /* Loading States */
        .loading-container,
        .error-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          color: #6b7280;
          flex-direction: column;
          gap: 1rem;
        }

        .loading-spinner {
          animation: spin 1s linear infinite;
          font-size: 2rem;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
          .container {
            padding: 1rem;
          }
          
          .header-info h1 {
            font-size: 2rem;
          }
          
          .cards-grid,
          .charts-grid {
            grid-template-columns: 1fr;
          }
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> 631.00238</span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong>Gen - Ago 2025</strong> (8 mesi)</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati aggiornati dal file CSV</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <!-- KPI Cards -->
            <div class="cards-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fatturato 2025</div>
                    </div>
                    <div class="card-value" id="fatturato-value">€0k</div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        vs 2024: <strong id="fatturato-vs">€0k</strong>
                        <span style="color: #10b981; margin-left: 0.5rem;" id="growth-badge">+0%</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Obiettivo 2025</div>
                    </div>
                    <div class="card-value" id="obiettivo-value">€0k</div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        Raggiunto: <strong style="color: #3b82f6;" id="obiettivo-percentage">0%</strong>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Clienti Attivi</div>
                    </div>
                    <div class="card-value" id="clienti-count">0</div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        LT: <span id="clienti-lt">0</span> • RM: <span id="clienti-rm">0</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Province Servite</div>
                    </div>
                    <div class="card-value">2</div>
                    <div style="color: #6b7280; font-size: 0.9rem;">
                        Latina • Roma
                    </div>
                </div>
            </div>

            <!-- Top 10 Vendite per Cliente -->
            <div class="table-card">
                <div class="table-header">
                    <h3>Top 10 Vendite per Cliente</h3>
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        <i class="fas fa-chart-line"></i>
                        <span id="vendite-count">0</span> transazioni
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Provincia</th>
                                <th>Cliente</th>
                                <th>Categoria Principale</th>
                                <th style="text-align: right;">Fatturato</th>
                            </tr>
                        </thead>
                        <tbody id="vendite-tbody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: between; align-items: center; gap: 2rem; flex-wrap: wrap;">
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        <i class="fas fa-users"></i>
                        Clienti Top 10: <strong id="top-clients-count">0</strong>
                    </div>
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        <i class="fas fa-euro-sign"></i>
                        Fatturato Top 10: <strong id="top-fatturato-total">€0k</strong>
                    </div>
                </div>
            </div>

            <!-- Riepilogo per Categoria -->
            <div class="table-card">
                <div class="table-header">
                    <h3>Riepilogo per Categoria</h3>
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        <i class="fas fa-tags"></i>
                        <span id="categorie-count">0</span> categorie attive
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th style="text-align: center;">Clienti LT</th>
                                <th style="text-align: center;">Clienti RM</th>
                                <th style="text-align: right;">Fatturato Totale</th>
                                <th style="text-align: right;">% sul Totale</th>
                            </tr>
                        </thead>
                        <tbody id="categorie-tbody">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; text-align: center;">
                    <div style="color: #6b7280; font-size: 0.875rem;">
                        Fatturato Totale Categorie: <strong style="color: #1f2937; font-size: 1.125rem;" id="categorie-fatturato-totale">€0k</strong>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-grid">
                <!-- Distribuzione per Provincia -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Distribuzione per Provincia</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="provinceChart"></canvas>
                    </div>
                </div>

                <!-- Top 5 Categorie -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Top 5 Categorie</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="categorieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance Summary -->
            <div class="card" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border: 1px solid #7dd3fc;">
                <div class="card-header">
                    <h3 style="color: #0284c7; margin-bottom: 1rem;">Riepilogo Performance</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 2rem; text-align: center;">
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #0284c7;" id="summary-fatturato">€0k</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Totale</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #0284c7;" id="summary-clienti">0</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Clienti Totali</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #0284c7;" id="summary-medio">€0k</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Fatturato Medio</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: 900; color: #0284c7;" id="summary-categorie">0</div>
                        <div style="color: #6b7280; font-size: 0.875rem;">Categorie Attive</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class DashboardCarabot {
            constructor() {
                this.csvData = null;
                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv'
                ];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => this.toggleTheme());
                }
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                }
            }

            buildCandidateUrls() {
                const { pathname, origin } = window.location;
                const segs = pathname.split('/').filter(Boolean);
                const repoSlug = segs.length ? segs[0] : '';

                const bases = [
                    './',
                    '',
                    './docs/',
                    'docs/',
                    '/docs/',
                    repoSlug ? `/${repoSlug}/` : '/',
                    repoSlug ? `/${repoSlug}/docs/` : '/docs/'
                ];

                const urls = [];
                for (const base of bases) {
                    for (const name of this.csvFileNames) {
                        try {
                            urls.push(new URL(base + name, origin).href);
                        } catch (e) {}
                    }
                }
                return [...new Set(urls)];
            }

            async loadData() {
                this.showLoading();

                try {
                    const candidates = this.buildCandidateUrls();
                    let csvText = null;

                    for (const url of candidates) {
                        try {
                            console.log('Tentativo caricamento:', url);
                            const response = await fetch(url + '?t=' + Date.now(), { cache: 'no-cache' });
                            if (response.ok) {
                                csvText = await response.text();
                                if (csvText && csvText.trim().length > 0) {
                                    console.log('CSV caricato da:', url);
                                    break;
                                }
                            }
                        } catch (e) {
                            console.warn('Fallito:', url, e.message);
                        }
                    }

                    if (!csvText) {
                        throw new Error('File CSV non trovato');
                    }

                    this.csvData = this.parseCSV(csvText);
                    if (!this.csvData) {
                        throw new Error('Errore parsing CSV');
                    }

                    console.log('Dati CSV parsati:', this.csvData);
                    this.showSuccess();
                    this.renderDashboard();
                    
                } catch (error) {
                    console.error('Errore caricamento:', error);
                    this.showError(error.message);
                }
            }

            parseCSV(csvText) {
                try {
                    const result = {
                        generale: { annoPrecedente: 0, annoCorrente: 0, clienti: 0 },
                        latina: { annoPrecedente: 0, annoCorrente: 0, obiettivo: 0, percentualeObiettivo: 0, clientiPrecedenti: 0, clientiCorrente: 0 },
                        roma: { annoCorrente: 0, clienti: 0 },
                        vendite: [],
                        categorie: []
                    };

                    // Parse OBIETTIVI
                    const obiettiviMatch = csvText.match(/=== VERIFICA OBIETTIVI ===([\s\S]*?)===.*===/);
                    if (obiettiviMatch) {
                        const obiettiviText = obiettiviMatch[1];
                        
                        // GENERALE
                        const generaleMatch = obiettiviText.match(/Generale;([\d.,]+);([\d.,]+);;;(\d+);(\d+);;/);
                        if (generaleMatch) {
                            result.generale = {
                                annoPrecedente: this.parseNumber(generaleMatch[1]),
                                annoCorrente: this.parseNumber(generaleMatch[2]),
                                clienti: parseInt(generaleMatch[4], 10)
                            };
                        }

                        // LATINA
                        const ltMatch = obiettiviText.match(/LT;([\d.,]+);([\d.,]+);([\d.,]+);(\d+)%;(\d+);(\d+);(\d+);(\d+)%/);
                        if (ltMatch) {
                            result.latina = {
                                annoPrecedente: this.parseNumber(ltMatch[1]),
                                annoCorrente: this.parseNumber(ltMatch[2]),
                                obiettivo: this.parseNumber(ltMatch[3]) * 1000,
                                percentualeObiettivo: parseInt(ltMatch[4], 10),
                                clientiPrecedenti: parseInt(ltMatch[5], 10),
                                clientiCorrente: parseInt(ltMatch[6], 10)
                            };
                        }
                    }

                    // Parse CLIENTI PER PROVINCIA
                    const clientiMatch = csvText.match(/=== CLIENTI PER PROVINCIA ===([\s\S]*?)===.*===/);
                    if (clientiMatch) {
                        const clientiText = clientiMatch[1];
                        const rmMatch = clientiText.match(/RM;(\d+);([\d.,]+);;;;;;/);
                        if (rmMatch) {
                            result.roma = {
                                annoCorrente: this.parseNumber(rmMatch[2]),
                                clienti: parseInt(rmMatch[1], 10)
                            };
                        }
                    }

                    // Parse DETTAGLIO VENDITE PER CLIENTE
                    const venditeMatch = csvText.match(/=== DETTAGLIO VENDITE PER CLIENTE ===([\s\S]*?)===.*===/);
                    if (venditeMatch) {
                        const venditeText = venditeMatch[1];
                        const lines = venditeText.split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('===') && 
                            !line.includes('Provincia;Ragione Sociale Cliente') && 
                            line.includes(';') && 
                            line.split(';').length >= 4
                        );

                        const venditeMap = new Map();
                        lines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const fatturato = this.parseNumber(parts[3]);
                                if (!isNaN(fatturato) && fatturato > 0) {
                                    const cliente = parts[1].trim();
                                    if (!venditeMap.has(cliente)) {
                                        venditeMap.set(cliente, {
                                            provincia: parts[0].trim(),
                                            cliente: cliente,
                                            categoria: parts[2].trim(),
                                            fatturato: 0
                                        });
                                    }
                                    venditeMap.get(cliente).fatturato += fatturato;
                                }
                            }
                        });

                        result.vendite = Array.from(venditeMap.values())
                            .sort((a, b) => b.fatturato - a.fatturato)
                            .slice(0, 10);
                    }

                    // Parse RIEPILOGO PER CATEGORIA
                    const categorieMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===([\s\S]*?)===.*===/);
                    if (categorieMatch) {
                        const categorieText = categorieMatch[1];
                        const lines = categorieText.split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('===') && 
                            !line.includes('Categoria;Importo Totale') && 
                            line.includes(';') && 
                            line.split(';').length >= 4
                        );

                        lines.forEach(line => {
                            const parts = line.split(';');
                            if (parts.length >= 4) {
                                const categoria = parts[0].trim();
                                const importo = this.parseNumber(parts[1]);
                                const clientiLT = parseInt(parts[2]) || 0;
                                const clientiRM = parseInt(parts[3]) || 0;
                                
                                if (categoria && importo > 0) {
                                    result.categorie.push({
                                        nome: categoria,
                                        importo: importo,
                                        clientiLT: clientiLT,
                                        clientiRM: clientiRM
                                    });
                                }
                            }
                        });

                        result.categorie.sort((a, b) => b.importo - a.importo);
                    }

                    return result;
                    
                } catch (e) {
                    console.error('Errore parsing:', e);
                    return null;
                }
            }

            parseNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                return Number(String(input).replace(/\s+/g, '').replace(/€/g, '').replace(/\./g, '').replace(/,/g, '.')) || 0;
            }

            formatEuroK(value) {
                if (!value) return '€0k';
                const k = Math.round(value / 1000);
                return `€${k}k`;
            }

            renderDashboard() {
                if (!this.csvData) return;

                // Update KPI Cards
                document.getElementById('fatturato-value').textContent = this.formatEuroK(this.csvData.generale.annoCorrente);
                document.getElementById('fatturato-vs').textContent = this.formatEuroK(this.csvData.generale.annoPrecedente);
                document.getElementById('obiettivo-value').textContent = this.formatEuroK(this.csvData.latina.obiettivo);
                document.getElementById('obiettivo-percentage').textContent = `${this.csvData.latina.percentualeObiettivo}%`;
                document.getElementById('clienti-count').textContent = this.csvData.generale.clienti;
                document.getElementById('clienti-lt').textContent = this.csvData.latina.clientiCorrente;
                document.getElementById('clienti-rm').textContent = this.csvData.roma.clienti;

                const growthPercent = this.csvData.generale.annoPrecedente > 0 ? 
                    (((this.csvData.generale.annoCorrente - this.csvData.generale.annoPrecedente) / this.csvData.generale.annoPrecedente) * 100).toFixed(1) : '0.0';
                document.getElementById('growth-badge').textContent = `+${growthPercent}%`;

                // Render tables and charts
                this.renderVenditeTable();
                this.renderCategorieTable();
                this.renderCharts();
                this.updateSummary();
            }

            renderVenditeTable() {
                const tbody = document.getElementById('vendite-tbody');
                if (!tbody || !this.csvData.vendite) return;

                tbody.innerHTML = '';
                
                this.csvData.vendite.forEach(vendita => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="province-badge ${vendita.provincia}">${vendita.provincia}</span></td>
                        <td>${vendita.cliente.length > 40 ? vendita.cliente.slice(0, 40) + '...' : vendita.cliente}</td>
                        <td>${vendita.categoria}</td>
                        <td style="text-align: right; font-weight: 700;">${this.formatEuroK(vendita.fatturato)}</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('vendite-count').textContent = this.csvData.vendite.length;
                document.getElementById('top-clients-count').textContent = this.csvData.vendite.length;
                const topTotal = this.csvData.vendite.reduce((sum, v) => sum + v.fatturato, 0);
                document.getElementById('top-fatturato-total').textContent = this.formatEuroK(topTotal);
            }

            renderCategorieTable() {
                const tbody = document.getElementById('categorie-tbody');
                if (!tbody || !this.csvData.categorie) return;

                tbody.innerHTML = '';
                
                const totale = this.csvData.categorie.reduce((sum, cat) => sum + cat.importo, 0);
                
                this.csvData.categorie.forEach(categoria => {
                    const percentuale = totale > 0 ? ((categoria.importo / totale) * 100).toFixed(1) : '0.0';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600;">${categoria.nome}</td>
                        <td style="text-align: center;">${categoria.clientiLT}</td>
                        <td style="text-align: center;">${categoria.clientiRM}</td>
                        <td style="text-align: right; font-weight: 700;">${this.formatEuroK(categoria.importo)}</td>
                        <td style="text-align: right; color: #3b82f6; font-weight: 600;">${percentuale}%</td>
                    `;
                    tbody.appendChild(row);
                });

                document.getElementById('categorie-count').textContent = this.csvData.categorie.length;
                document.getElementById('categorie-fatturato-totale').textContent = this.formatEuroK(totale);
            }

            renderCharts() {
                this.renderProvinceChart();
                this.renderCategorieChart();
            }

            renderProvinceChart() {
                const ctx = document.getElementById('provinceChart');
                if (!ctx) return;

                const ltFatturato = this.csvData.latina.annoCorrente;
                const rmFatturato = this.csvData.roma.annoCorrente;

                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Latina (LT)', 'Roma (RM)'],
                        datasets: [{
                            data: [ltFatturato, rmFatturato],
                            backgroundColor: ['#8b5cf6', '#22d3ee'],
                            borderColor: ['#7c3aed', '#0891b2'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuroK(context.raw);
                                        const total = ltFatturato + rmFatturato;
                                        const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : '0';
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderCategorieChart() {
                const ctx = document.getElementById('categorieChart');
                if (!ctx || !this.csvData.categorie) return;

                const top5 = this.csvData.categorie.slice(0, 5);

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: top5.map(cat => cat.nome.length > 15 ? cat.nome.slice(0, 15) + '...' : cat.nome),
                        datasets: [{
                            label: 'Fatturato',
                            data: top5.map(cat => cat.importo),
                            backgroundColor: '#3b82f6',
                            borderColor: '#1e40af',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `Fatturato: ${this.formatEuroK(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => this.formatEuroK(value)
                                }
                            }
                        }
                    }
                });
            }

            updateSummary() {
                document.getElementById('summary-fatturato').textContent = this.formatEuroK(this.csvData.generale.annoCorrente);
                document.getElementById('summary-clienti').textContent = this.csvData.generale.clienti;
                
                const medio = this.csvData.generale.clienti > 0 ? this.csvData.generale.annoCorrente / this.csvData.generale.clienti : 0;
                document.getElementById('summary-medio').textContent = this.formatEuroK(medio);
                document.getElementById('summary-categorie').textContent = this.csvData.categorie.length;
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'flex';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'flex';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardCarabot();
        });
    </script>
</body>
</html>
