<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARABOT NATALINO - Dashboard Executive</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background: #f8fafc;
          color: #1f2937;
          line-height: 1.6;
          transition: all 0.3s ease;
        }

        body.dark-mode {
          background: #0f172a;
          color: #f8fafc;
        }

        .container {
          max-width: 1400px;
          margin: 0 auto;
          padding: 2rem;
        }

        /* Header */
        .header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .header-info h1 {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .header-info h1 {
          color: #f8fafc;
        }

        .header-info p {
          color: #6b7280;
          font-size: 1.1rem;
          font-weight: 500;
        }

        .theme-toggle {
          background: #374151;
          color: white;
          border: none;
          padding: 0.75rem;
          border-radius: 50%;
          cursor: pointer;
          transition: all 0.3s ease;
          font-size: 1.25rem;
          width: 50px;
          height: 50px;
        }

        .theme-toggle:hover {
          background: #4b5563;
          transform: scale(1.1);
        }

        /* Status Bar */
        .status-bar {
          display: flex;
          align-items: center;
          gap: 2rem;
          margin-bottom: 2rem;
          flex-wrap: wrap;
        }

        .status-item {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.9rem;
          color: #6b7280;
        }

        .status-item i {
          color: #3b82f6;
        }

        .status-item strong {
          color: #1f2937;
        }

        body.dark-mode .status-item strong {
          color: #f8fafc;
        }

        .status-dot {
          width: 8px;
          height: 8px;
          background: #10b981;
          border-radius: 50%;
          animation: pulse 2s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        /* Filter Section */
        .filter-section {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 2rem;
          flex-wrap: wrap;
          gap: 1rem;
        }

        .filter-label {
          font-weight: 600;
          color: #374151;
          font-size: 0.875rem;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        body.dark-mode .filter-label {
          color: #d1d5db;
        }

        .province-selector {
          background: #3b82f6;
          color: white;
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: 0.75rem;
          cursor: pointer;
          font-weight: 600;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 0.5rem;
        }

        .province-selector:hover {
          background: #2563eb;
          transform: translateY(-2px);
          box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
        }

        /* Cards Grid */
        .cards-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        }

        .card {
          background: white;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
          border: 1px solid #e5e7eb;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
        }

        body.dark-mode .card {
          background: #1e293b;
          border-color: #334155;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
          transform: translateY(-4px);
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .card:hover {
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 1rem;
        }

        .card-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          text-transform: uppercase;
          letter-spacing: 0.05em;
        }

        .card-badge {
          background: #dcfce7;
          color: #16a34a;
          padding: 0.25rem 0.75rem;
          border-radius: 1rem;
          font-size: 0.75rem;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 0.25rem;
        }

        .card-badge.warning {
          background: #fef3c7;
          color: #d97706;
        }

        .card-value {
          font-size: 2.5rem;
          font-weight: 900;
          color: #1f2937;
          margin-bottom: 0.5rem;
        }

        body.dark-mode .card-value {
          color: #f8fafc;
        }

        .card-subtitle {
          color: #6b7280;
          font-size: 0.9rem;
          margin-bottom: 1rem;
        }

        .progress-section {
          background: #f8fafc;
          padding: 1rem;
          border-radius: 0.75rem;
          margin-top: 1rem;
        }

        body.dark-mode .progress-section {
          background: #0f172a;
        }

        .progress-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.75rem;
        }

        .progress-label {
          font-size: 0.875rem;
          font-weight: 600;
          color: #1f2937;
        }

        body.dark-mode .progress-label {
          color: #f8fafc;
        }

        .progress-value {
          font-size: 0.875rem;
          font-weight: 700;
          color: #6b7280;
        }

        .progress-bar-container {
          width: 100%;
          height: 8px;
          background: #e5e7eb;
          border-radius: 1rem;
          overflow: hidden;
        }

        body.dark-mode .progress-bar-container {
          background: #374151;
        }

        .progress-bar {
          height: 100%;
          border-radius: 1rem;
          transition: width 2s ease-in-out;
          position: relative;
        }

        .progress-bar.green {
          background: linear-gradient(90deg, #10b981, #34d399);
        }

        .progress-bar.blue {
          background: linear-gradient(90deg, #3b82f6, #60a5fa);
        }

        .progress-bar.orange {
          background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .progress-footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 0.75rem;
          font-size: 0.875rem;
        }

        .progress-remaining {
          color: #6b7280;
        }

        .progress-percentage {
          color: #3b82f6;
          font-weight: 700;
        }

        /* Performance Cards */
        .performance-card {
          background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
          border: 1px solid #7dd3fc;
        }

        body.dark-mode .performance-card {
          background: linear-gradient(135deg, #0c4a6e, #075985);
          border-color: #0284c7;
        }

        .performance-header {
          margin-bottom: 1rem;
        }

        .performance-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          margin-bottom: 0.5rem;
        }

        .performance-province {
          font-size: 2rem;
          font-weight: 900;
          color: #0284c7;
          margin-bottom: 0.25rem;
        }

        .performance-subtitle {
          color: #6b7280;
          font-size: 0.875rem;
        }

        .performance-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .performance-growth {
          color: #10b981;
          font-size: 1.25rem;
          font-weight: 700;
        }

        .performance-amount {
          color: #374151;
          font-size: 1.125rem;
          font-weight: 700;
        }

        body.dark-mode .performance-amount {
          color: #d1d5db;
        }

        .trend-section {
          background: #f0f9ff;
          padding: 1rem;
          border-radius: 0.75rem;
          margin-top: 1rem;
        }

        body.dark-mode .trend-section {
          background: #0c4a6e;
        }

        .trend-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
        }

        .trend-item:last-child {
          margin-bottom: 0;
        }

        .trend-label {
          color: #0284c7;
          font-size: 0.875rem;
          font-weight: 600;
        }

        .trend-value {
          color: #0284c7;
          font-size: 0.875rem;
          font-weight: 700;
        }

        /* Client Cards */
        .client-card {
          background: linear-gradient(135deg, #fef7ed, #fed7aa);
          border: 1px solid #fb923c;
        }

        body.dark-mode .client-card {
          background: linear-gradient(135deg, #7c2d12, #9a3412);
          border-color: #ea580c;
        }

        .client-header {
          margin-bottom: 1rem;
        }

        .client-title {
          font-size: 0.875rem;
          font-weight: 600;
          color: #6b7280;
          margin-bottom: 0.5rem;
        }

        .client-count {
          font-size: 3rem;
          font-weight: 900;
          color: #ea580c;
          margin-bottom: 0.25rem;
        }

        .client-subtitle {
          color: #6b7280;
          font-size: 0.875rem;
        }

        .client-metrics {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
        }

        .client-percentage {
          color: #ea580c;
          font-size: 1.5rem;
          font-weight: 700;
        }

        .client-target {
          color: #6b7280;
          font-size: 0.875rem;
        }

        /* Loading States */
        .loading-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          color: #6b7280;
        }

        .loading-spinner {
          animation: spin 1s linear infinite;
          font-size: 2rem;
          margin-right: 1rem;
        }

        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }

        .error-container {
          background: #fee2e2;
          color: #dc2626;
          padding: 1rem;
          border-radius: 0.75rem;
          text-align: center;
          margin: 2rem 0;
        }

        body.dark-mode .error-container {
          background: #7f1d1d;
          color: #fca5a5;
        }

        /* Responsive */
        @media (max-width: 768px) {
          .container {
            padding: 1rem;
          }
          
          .header {
            flex-direction: column;
            align-items: flex-start;
          }
          
          .header-info h1 {
            font-size: 2rem;
          }
          
          .cards-grid {
            grid-template-columns: 1fr;
          }
          
          .card-value {
            font-size: 2rem;
          }
          
          .performance-province {
            font-size: 1.5rem;
          }
          
          .client-count {
            font-size: 2.5rem;
          }
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-info">
                <h1>CARABOT NATALINO</h1>
                <p>Dashboard Performance Vendite</p>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <i class="fas fa-id-card"></i>
                <span><strong>ID:</strong> <span id="agent-code">631.00238</span></span>
            </div>
            <div class="status-item">
                <i class="fas fa-calendar"></i>
                <span><strong id="period-text">01/01/2025 - 24/08/2025</strong> (8 mesi)</span>
            </div>
            <div class="status-item">
                <div class="status-dot"></div>
                <span>Dati aggiornati dal file CSV</span>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div>
                <div class="filter-label">Filtro Territorio</div>
                <div style="color: #3b82f6; font-weight: 600; margin-top: 0.25rem;" id="current-filter">Tutte le Province</div>
            </div>
            <button class="province-selector" id="province-selector">
                <i class="fas fa-chevron-down"></i>
                <span>Selezione Provincia</span>
            </button>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="loading-container">
            <i class="fas fa-sync-alt loading-spinner"></i>
            <span>Caricamento dati CSV...</span>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-container" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Errore di connessione</strong>
            <p id="error-message">Impossibile caricare i dati CSV</p>
        </div>

        <!-- Main Content -->
        <div id="main-content" style="display: none;">
            <div class="cards-grid">
                <!-- Fatturato Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Fatturato 2025</div>
                        <div class="card-badge">
                            <i class="fas fa-arrow-up"></i>
                            <span id="growth-badge">+0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="fatturato-value">€0k</div>
                    <div class="card-subtitle">vs 2024: <strong id="fatturato-vs">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Fatturato</div>
                            <div class="progress-value" id="obiettivo-fatturato">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar green" id="progress-fatturato" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="fatturato-remaining">€0k</strong></div>
                            <div class="progress-percentage" id="fatturato-percentage">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Obiettivo Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Obiettivo 2025</div>
                        <div class="card-badge" id="obiettivo-badge">
                            <span id="obiettivo-percentage">0%</span>
                        </div>
                    </div>
                    <div class="card-value" id="obiettivo-value">€0k</div>
                    <div class="card-subtitle">Da raggiungere: <strong id="obiettivo-remaining">€0k</strong></div>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Progressione Obiettivo</div>
                            <div class="progress-value" id="obiettivo-target">€0k</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar blue" id="progress-obiettivo" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="obiettivo-mancano">€0k</strong></div>
                            <div class="progress-percentage" id="obiettivo-perc-display">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Top Performance Card -->
                <div class="card performance-card">
                    <div class="performance-header">
                        <div class="performance-title">Top Performance</div>
                        <div class="performance-province" id="top-province">LT</div>
                        <div class="performance-subtitle">Provincia Latina</div>
                    </div>
                    <div class="performance-metrics">
                        <div class="performance-growth" id="province-growth">+0%</div>
                        <div class="performance-amount" id="province-amount">€0k</div>
                    </div>
                    <div class="trend-section">
                        <div class="trend-item">
                            <div class="trend-label">Crescita Complessiva</div>
                            <div class="trend-value" id="trend-growth">+€0k</div>
                        </div>
                        <div class="trend-item">
                            <div class="trend-label">Crescita: +0%</div>
                            <div class="trend-value">Trend positivo</div>
                        </div>
                    </div>
                </div>

                <!-- Clienti Attivi Card -->
                <div class="card client-card">
                    <div class="client-header">
                        <div class="client-title">Clienti Attivi</div>
                        <div class="client-count" id="clienti-count">0</div>
                        <div class="client-subtitle">Obiettivo: <span id="clienti-obiettivo">0</span></div>
                    </div>
                    <div class="client-metrics">
                        <div class="client-percentage" id="clienti-percentage">0%</div>
                        <div class="client-target">raggiunto</div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-header">
                            <div class="progress-label">Obiettivo Clienti</div>
                            <div class="progress-value" id="clienti-target-value">0</div>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar orange" id="progress-clienti" style="width: 0%;"></div>
                        </div>
                        <div class="progress-footer">
                            <div class="progress-remaining">Mancano: <strong id="clienti-mancanti">0 clienti</strong></div>
                            <div class="progress-percentage" id="clienti-perc-display">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-top: 2rem;">
                <!-- Confronto Clienti per Provincia -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Clienti per Provincia</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="clientiChart"></canvas>
                    </div>
                    
                    <!-- Province Info Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #fef2f2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-growth">-5%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-clienti-count">0 clienti</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="rm-growth">+2%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Confronto Province (Fatturato) -->
                <div class="card" style="padding: 2rem;">
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Confronto Province</h3>
                    <div style="position: relative; height: 300px; margin-bottom: 2rem;">
                        <canvas id="fatturatoChart"></canvas>
                    </div>
                    
                    <!-- Province Revenue Cards -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #8b5cf6; margin-bottom: 0.25rem;">Latina</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="lt-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong id="lt-fatturato-prev">€0k</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;" id="lt-fatturato-growth">+4.3%</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 1.25rem; font-weight: 700; color: #22d3ee; margin-bottom: 0.25rem;">Roma</div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2025: <strong id="rm-fatturato-display">€0k</strong></div>
                            <div style="color: #6b7280; font-size: 0.9rem;">2024: <strong>0 €</strong></div>
                            <div style="margin-top: 0.5rem;">
                                <span style="background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;">+Infinity%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distribuzione Province Section -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Distribuzione Province</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                    <!-- Province Distribution Chart -->
                    <div style="position: relative; height: 300px;">
                        <canvas id="provinceDistributionChart"></canvas>
                    </div>
                    
                    <!-- Province Details Cards -->
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <!-- Latina Card -->
                        <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 1.5rem; border-radius: 1rem; border: 2px solid #a855f7;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #7c3aed;">Latina (LT)</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #7c3aed;" id="dist-lt-percentage">91.4%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 0.5rem;" id="dist-lt-amount">82.389 €</div>
                        </div>

                        <!-- Roma Card -->
                        <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); padding: 1.5rem; border-radius: 1rem; border: 2px solid #22d3ee;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #0891b2;">Roma (RM)</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #0891b2;" id="dist-rm-percentage">8.6%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 0.5rem;" id="dist-rm-amount">7.771 €</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Riepilogo Clienti per Provincia -->
            <div class="card" style="padding: 2rem; margin-top: 2rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 2rem; color: #1f2937;">Riepilogo Clienti per Provincia</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Latina -->
                    <div style="background: linear-gradient(135deg, #f3e8ff, #e9d5ff); padding: 2rem; border-radius: 1.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed; margin-bottom: 1rem;">Latina</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 2.5rem; font-weight: 900; color: #1f2937;" id="riepilogo-lt-clienti-2025">18</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">clienti 2025</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="riepilogo-lt-fatturato-k">€82k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">fatturato</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;" id="riepilogo-lt-medio">€5k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">medio</div>
                            </div>
                        </div>
                        
                        <!-- vs 2024 -->
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 0.75rem; border: 1px solid #fecaca;" id="lt-comparison-box">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #dc2626; font-weight: 600;" id="lt-comparison-text">vs 2024: <span id="riepilogo-lt-clienti-2024">23</span> clienti</span>
                                <span style="background: #fecaca; color: #dc2626; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 700;" id="riepilogo-lt-difference">-5 ↓</span>
                            </div>
                        </div>
                    </div>

                    <!-- Roma -->
                    <div style="background: linear-gradient(135deg, #ecfeff, #cffafe); padding: 2rem; border-radius: 1.5rem; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #0891b2; margin-bottom: 1rem;">Roma</div>
                        
                        <div style="display: flex; justify-content: space-around; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 2.5rem; font-weight: 900; color: #1f2937;" id="riepilogo-rm-clienti-2025">2</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">clienti 2025</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #1f2937;" id="riepilogo-rm-fatturato-k">€8k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">fatturato</div>
                            </div>
                            <div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #0891b2;" id="riepilogo-rm-medio">€4k</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">medio</div>
                            </div>
                        </div>
                        
                        <!-- vs 2024 -->
                        <div style="background: #d1fae5; padding: 1rem; border-radius: 0.75rem; border: 1px solid #a7f3d0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #059669; font-weight: 600;">vs 2024: <span id="riepilogo-rm-clienti-2024">0</span> clienti</span>
                                <span style="background: #a7f3d0; color: #059669; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 700;">+∞</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3rem; align-items: center;">
                    <!-- Doughnut Chart -->
                    <div style="position: relative; height: 300px;">
                        <canvas id="mixProdottiChart"></canvas>
                    </div>
                    
                    <!-- Product Details -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Mattone + Pavimentazione -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #3b82f6;">Mattone + Pavimentazione</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #3b82f6;" id="core-percentage">79.6%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="core-amount">54.245 €</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Mattone:</span>
                                    <span id="mattone-amount">€39k</span>
                                </div>
                                <div>
                                    <span style="color: #3b82f6; font-weight: 600;">Pavimentazione:</span>
                                    <span id="pavimentazione-amount">€16k</span>
                                </div>
                            </div>
                        </div>

                        <!-- Altri Prodotti -->
                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 1rem; border-left: 4px solid #6b7280;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.125rem; font-weight: 700; color: #6b7280;">Altri Prodotti</span>
                                <span style="font-size: 1.5rem; font-weight: 900; color: #6b7280;" id="other-percentage">20.4%</span>
                            </div>
                            <div style="font-size: 1.25rem; font-weight: 900; color: #1f2937; margin-bottom: 1rem;" id="other-amount">13.934 €</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.875rem;">
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Refrattari:</span>
                                    <span id="refrattari-amount">€10k</span>
                                </div>
                                <div>
                                    <span style="color: #6b7280; font-weight: 600;">Altri:</span>
                                    <span id="altri-amount">€4k</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Mix Prodotti -->
                <div style="background: linear-gradient(135deg, #f0f4ff, #e0e7ff); padding: 1.5rem; border-radius: 1rem; margin-top: 2rem; border: 1px solid #c7d2fe;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%;"></div>
                        <span style="font-weight: 700; color: #3730a3;">Performance Mix Prodotti</span>
                        <span style="margin-left: auto; font-weight: 700; color: #3730a3;">Equilibrio Ottimo</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem; text-align: center;">
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="core-perf">79.6%</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Prodotti Core</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="categories-count">7</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Categorie Attive</div>
                        </div>
                        <div>
                            <div style="font-size: 2rem; font-weight: 900; color: #3730a3;" id="involved-clients">20</div>
                            <div style="color: #6366f1; font-size: 0.875rem; font-weight: 600;">Clienti Coinvolti</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Province Selection Popup -->
        <div id="province-popup" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; padding: 1rem;">
            <div style="background: white; border-radius: 1rem; max-width: 400px; margin: 2rem auto; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" id="popup-content">
                <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Seleziona Provincia</h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;" id="province-options">
                    <button class="province-option" data-province="all" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Tutte le Province</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="all-desc">€0k • 0 clienti</div>
                    </button>
                    <button class="province-option" data-province="LT" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Latina (LT)</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="lt-desc">€0k • 0 clienti</div>
                    </button>
                    <button class="province-option" data-province="RM" style="width: 100%; padding: 1rem; border: 2px solid #e5e7eb; border-radius: 0.75rem; background: white; text-align: left; cursor: pointer; transition: all 0.3s ease;">
                        <strong>Roma (RM)</strong>
                        <div style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;" id="rm-desc">€0k • 0 clienti</div>
                    </button>
                </div>
                <button id="close-popup" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: #374151; color: white; border: none; border-radius: 0.5rem; cursor: pointer; width: 100%;">Chiudi</button>
            </div>
        </div>
    </div>

    <script>
        class ExecutiveDashboard {
            constructor() {
                this.csvData = null;
                this.selectedProvince = 'all';
                this.isLoading = false;
                this.csvFileNames = [
                    '631.00238_CARABOT-NATALINO.csv',
                    '631.00238_CARABOT NATALINO.csv',
                    'CARABOT_NATALINO.csv',
                    'data.csv'
                ];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadData();
            }

            setupEventListeners() {
                // Theme toggle
                document.getElementById('theme-toggle').addEventListener('click', () => this.toggleTheme());
                
                // Province selector
                document.getElementById('province-selector').addEventListener('click', () => this.showProvincePopup());
                document.getElementById('close-popup').addEventListener('click', () => this.hideProvincePopup());
                
                // Province options
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.province-option')) {
                        const province = e.target.closest('.province-option').dataset.province;
                        this.selectProvince(province);
                    }
                });

                // Close popup on backdrop click
                document.getElementById('province-popup').addEventListener('click', (e) => {
                    if (e.target.id === 'province-popup') {
                        this.hideProvincePopup();
                    }
                });
            }

            toggleTheme() {
                const body = document.body;
                const icon = document.querySelector('#theme-toggle i');
                const popup = document.getElementById('popup-content');
                
                if (body.classList.contains('light-mode')) {
                    body.classList.remove('light-mode');
                    body.classList.add('dark-mode');
                    icon.className = 'fas fa-sun';
                    if (popup) {
                        popup.style.background = '#1e293b';
                        popup.style.color = '#f8fafc';
                    }
                } else {
                    body.classList.remove('dark-mode');
                    body.classList.add('light-mode');
                    icon.className = 'fas fa-moon';
                    if (popup) {
                        popup.style.background = 'white';
                        popup.style.color = '#1f2937';
                    }
                }
            }

            showProvincePopup() {
                if (this.csvData) {
                    this.updateProvinceOptions();
                    document.getElementById('province-popup').style.display = 'block';
                }
            }

            hideProvincePopup() {
                document.getElementById('province-popup').style.display = 'none';
            }

            updateProvinceOptions() {
                if (!this.csvData) return;
                
                const allDesc = document.getElementById('all-desc');
                const ltDesc = document.getElementById('lt-desc');
                const rmDesc = document.getElementById('rm-desc');
                
                if (allDesc) allDesc.textContent = `${this.formatEuroK(this.csvData.generale.annoCorrente)} • ${this.csvData.generale.clienti} clienti`;
                if (ltDesc) ltDesc.textContent = `${this.formatEuroK(this.csvData.latina.annoCorrente)} • ${this.csvData.latina.clientiCorrente} clienti`;
                if (rmDesc) rmDesc.textContent = `${this.formatEuroK(this.csvData.roma.annoCorrente)} • ${this.csvData.roma.clienti} clienti`;
                
                // Update selected state
                document.querySelectorAll('.province-option').forEach(option => {
                    const province = option.dataset.province;
                    if (province === this.selectedProvince) {
                        option.style.border = '2px solid #3b82f6';
                        option.style.background = '#f0f9ff';
                    } else {
                        option.style.border = '2px solid #e5e7eb';
                        option.style.background = 'white';
                    }
                });
            }

            selectProvince(province) {
                this.selectedProvince = province;
                
                const labels = { 
                    all: 'Tutte le Province', 
                    LT: 'Provincia Latina', 
                    RM: 'Provincia Roma' 
                };
                
                document.getElementById('current-filter').textContent = labels[province] || 'Tutte le Province';
                this.hideProvincePopup();
                this.updateDashboard();
            }

            async loadData() {
                this.isLoading = true;
                this.showLoading();

                try {
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Timeout: caricamento CSV troppo lento')), 15000);
                    });

                    const loadPromise = this.tryLoadCSV();
                    
                    const result = await Promise.race([loadPromise, timeoutPromise]);
                    
                    this.csvData = this.parseCSV(result);
                    if (!this.csvData) {
                        throw new Error('Errore nel parsing del CSV - struttura non riconosciuta');
                    }

                    console.log('Parsed CSV data:', this.csvData);
                    this.showSuccess();
                    this.updateDashboard();
                    
                } catch (error) {
                    console.error('Errore caricamento completo:', error);
                    
                    // Fallback con dati di esempio
                    console.log('Usando dati di fallback...');
                    try {
                        const sampleData = this.createSampleCSV();
                        this.csvData = this.parseCSV(sampleData);
                        if (this.csvData) {
                            this.showSuccess();
                            this.updateDashboard();
                            return;
                        }
                    } catch (fallbackError) {
                        console.error('Errore anche con i dati di fallback:', fallbackError);
                    }
                    
                    this.showError(error.message);
                } finally {
                    this.isLoading = false;
                }
            }

            async tryLoadCSV() {
                const candidates = this.buildCandidateUrls();
                let csvText = null;
                
                console.log('Trying to load CSV from these URLs:', candidates);
                
                for (const url of candidates) {
                    try {
                        console.log('Attempting to load:', url);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);
                        
                        const response = await fetch(url + '?t=' + Date.now(), {
                            cache: 'no-cache',
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        console.log(`Response for ${url}:`, response.status, response.ok);
                        if (response.ok) {
                            csvText = await response.text();
                            if (csvText && csvText.trim().length > 0) {
                                console.log('Successfully loaded CSV from:', url);
                                console.log('CSV content preview:', csvText.substring(0, 500));
                                return csvText;
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to load from:', url, e.message);
                        if (e.name === 'AbortError') {
                            console.warn('Request timed out for:', url);
                        }
                    }
                }

                console.warn('No CSV found, using sample data');
                return this.createSampleCSV();
            }

            createSampleCSV() {
                // Dati compatibili con il formato reale
                return `==================== CARABOT NATALINO ====================

=== INFORMAZIONI AGENTE ===
Codice Agente,Ragione Sociale,Dalla data,Alla data
631.00238,CARABOT NATALINO,01/01/2025,24/08/2025

=== VERIFICA OBIETTIVI ===
Provincia,AnnoPrec.,AnnoCorr.,Obiettivo,% su obiet.,ClientiAnnoPrec.,ClientiAnnoCorr.,Obiettivo,% su obiet.
Generale,"80.238,72","90.159,79",,,352,20,,
LT,"79.029,16","82.389,23","155.000,00","53,%",23,18,35,"51,%"

=== CLIENTI PER PROVINCIA ===
Provincia,Clienti Serviti,Fatturato
LT,18,"60.437,22"
RM,2,"7.770,56"

=== RIPARTIZIONE FATTURATO ===
Categoria,Importo,Percentuale
Pieni e Coppi,54.909,62,61%
Altro,35.250,17,39%

=== RIEPILOGO PER CATEGORIA ===
Categoria,Importo Totale,Provincia LT Clienti,Provincia RM Clienti
MATTONE PIENO,"38.558,64",16,1
PAVIMENTAZIONE POLIS,"15.686,46",13,1
REFRATTARI,"4.910,39",4,1
REFRATTARI RETTIFICATI,"5.367,83",5,0
FACCIAVISTA,"1.591,40",2,0
LINEA ARCHEO,"746,68",2,1
PIASTRELLE,"1.240,95",1,0
CORRIM.COPRIM.,"73,26",1,0
COPERTURE,"3,36",1,0
OUTLET,"0,01",1,0

=== TOTALI ===
Descrizione,Valore
Fatturato Totale,68207.78
Clienti Totali,20
Province Servite,2
Periodo,01/01/2025 - 24/08/2025`;
            }

            buildCandidateUrls() {
                const { pathname, origin } = window.location;
                const segs = pathname.split('/').filter(Boolean);
                const repoSlug = segs.length ? segs[0] : '';

                const bases = [
                    './docs/',
                    'docs/',
                    '/docs/',
                    `/${repoSlug}/docs/`,
                    './',
                    '',
                    pathname.endsWith('/') ? pathname : pathname.replace(/[^/]*$/, ''),
                    repoSlug ? `/${repoSlug}/` : '/'
                ];

                const urls = [];
                for (const base of bases) {
                    for (const name of this.csvFileNames) {
                        try {
                            urls.push(new URL(base + name, origin).href);
                        } catch (e) {}
                    }
                }
                console.log('Candidate URLs:', [...new Set(urls)]);
                return [...new Set(urls)];
            }

            parseCSV(csvText) {
                try {
                    console.log('Parsing CSV with length:', csvText.length);
                    
                    // Extract agent info
                    const agentMatch = csvText.match(/=== INFORMAZIONI AGENTE ===\s*[\s\S]*?(\d{3}\.\d{5}),([^,]+),([^,]+),([^\n\r]+)/);
                    const agentInfo = agentMatch ? {
                        codice: agentMatch[1],
                        ragioneSociale: agentMatch[2],
                        dataInizio: agentMatch[3],
                        dataFine: agentMatch[4]
                    } : null;

                    // Parse VERIFICA OBIETTIVI section
                    const obiettiviMatch = csvText.match(/=== VERIFICA OBIETTIVI ===\s*([\s\S]*?)(?:===|$)/);
                    if (!obiettiviMatch) throw new Error('Sezione obiettivi non trovata');
                    
                    const obiettiviText = obiettiviMatch[1];
                    console.log('Obiettivi text:', obiettiviText);
                    
                    // Parse GENERALE data with more flexible regex
                    const generaleMatch = obiettiviText.match(/Generale,\s*"([^"]+)",\s*"([^"]+)"[^,]*,[^,]*,[^,]*,\s*(\d+),\s*(\d+)/);
                    if (!generaleMatch) {
                        console.log('Generale match failed, trying alternative format');
                        throw new Error('Dati Generale non trovati');
                    }
                    
                    console.log('Generale match:', generaleMatch);
                    
                    const generale = {
                        annoPrecedente: this.parseItalianNumber(generaleMatch[1]),
                        annoCorrente: this.parseItalianNumber(generaleMatch[2]),
                        clientiPrecedenti: parseInt(generaleMatch[3], 10),
                        clienti: parseInt(generaleMatch[4], 10)
                    };

                    // Parse LATINA data with flexible regex
                    const ltMatch = obiettiviText.match(/LT,\s*"([^"]+)",\s*"([^"]+)",\s*"([^"]+)",\s*"([^"]+)",\s*(\d+),\s*(\d+),\s*(\d+),\s*"([^"]+)"/);
                    if (!ltMatch) {
                        console.log('LT match failed');
                        throw new Error('Dati Latina non trovati');
                    }
                    
                    console.log('LT match:', ltMatch);
                    
                    const latina = {
                        annoPrecedente: this.parseItalianNumber(ltMatch[1]),
                        annoCorrente: this.parseItalianNumber(ltMatch[2]),
                        obiettivo: this.parseItalianNumber(ltMatch[3]),
                        percentualeObiettivo: this.parsePercentage(ltMatch[4]),
                        clientiPrecedenti: parseInt(ltMatch[5], 10),
                        clientiCorrente: parseInt(ltMatch[6], 10),
                        obiettivoClienti: parseInt(ltMatch[7], 10),
                        percentualeClienti: this.parsePercentage(ltMatch[8])
                    };

                    // Parse CLIENTI PER PROVINCIA section
                    const clientiMatch = csvText.match(/=== CLIENTI PER PROVINCIA ===\s*([\s\S]*?)(?:===|$)/);
                    let roma = { annoCorrente: 0, clienti: 0 };
                    
                    if (clientiMatch) {
                        const clientiText = clientiMatch[1];
                        console.log('Clienti text:', clientiText);
                        
                        // Update LT data from CLIENTI section
                        const ltClientMatch = clientiText.match(/LT,\s*(\d+),\s*"([^"]+)"/);
                        if (ltClientMatch) {
                            latina.clientiCorrente = parseInt(ltClientMatch[1], 10);
                            latina.fatturatoDettaglio = this.parseItalianNumber(ltClientMatch[2]);
                        }
                        
                        const rmMatch = clientiText.match(/RM,\s*(\d+),\s*"([^"]+)"/);
                        if (rmMatch) {
                            roma = {
                                annoCorrente: this.parseItalianNumber(rmMatch[2]),
                                clienti: parseInt(rmMatch[1], 10)
                            };
                        }
                        console.log('Roma data:', roma);
                    }

                    // Parse RIEPILOGO PER CATEGORIA section
                    const riepilogoMatch = csvText.match(/=== RIEPILOGO PER CATEGORIA ===\s*([\s\S]*?)(?:===|$)/);
                    let categorie = [];
                    
                    if (riepilogoMatch) {
                        const riepilogoText = riepilogoMatch[1];
                        console.log('Riepilogo text:', riepilogoText);
                        
                        const lines = riepilogoText.split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('Categoria,Importo') && 
                            !line.includes('===') &&
                            line.includes(',') && 
                            !line.startsWith(',') &&
                            !line.includes('Totale')
                        );
                        
                        console.log('Category lines:', lines);
                        
                        lines.forEach(line => {
                            const parts = line.split(',');
                            if (parts.length >= 2) {
                                const categoria = parts[0].trim();
                                const importoStr = parts[1].replace(/"/g, '');
                                const importo = this.parseItalianNumber(importoStr);
                                
                                if (categoria && importo > 0) {
                                    // Map categories to dashboard format
                                    let mappedCategory = categoria;
                                    if (categoria.includes('MATTONE') || categoria.includes('PIENO')) {
                                        mappedCategory = 'Mattone';
                                    } else if (categoria.includes('PAVIMENTAZIONE') || categoria.includes('POLIS')) {
                                        mappedCategory = 'Pavimentazione';
                                    } else if (categoria.includes('REFRATTARI')) {
                                        mappedCategory = 'Refrattari';
                                    } else {
                                        mappedCategory = 'Altri';
                                    }
                                    
                                    // Aggrega se la categoria mappata esiste già
                                    const existing = categorie.find(c => c.nome === mappedCategory);
                                    if (existing) {
                                        existing.importo += importo;
                                    } else {
                                        categorie.push({
                                            nome: mappedCategory,
                                            importo: importo
                                        });
                                    }
                                }
                            }
                        });
                    }

                    // Parse DETTAGLIO VENDITE section for top sales
                    const dettaglioMatch = csvText.match(/=== DETTAGLIO VENDITE PER CLIENTE ===\s*([\s\S]*?)(?:===|$)/);
                    let dettaglioVendite = [];
                    let categorieDettagliate = new Map();
                    
                    if (dettaglioMatch) {
                        const dettaglioText = dettaglioMatch[1];
                        const lines = dettaglioText.split('\n').filter(line => 
                            line.trim() && 
                            !line.includes('Provincia,Ragione Sociale') && 
                            !line.includes('===') &&
                            line.split(',').length >= 4
                        );
                        
                        lines.forEach(line => {
                            const parts = line.split(',');
                            if (parts.length >= 4) {
                                const provincia = parts[0].trim();
                                const cliente = parts[1].trim();
                                const categoria = parts[2].trim();
                                const fatturato = this.parseItalianNumber(parts[3].replace(/"/g, ''));
                                
                                if (provincia && cliente && categoria && fatturato > 0) {
                                    dettaglioVendite.push({
                                        provincia: provincia,
                                        cliente: cliente,
                                        categoria: categoria,
                                        fatturato: fatturato
                                    });
                                    
                                    // Aggregate for category details
                                    const key = categoria;
                                    if (!categorieDettagliate.has(key)) {
                                        categorieDettagliate.set(key, {
                                            nome: categoria,
                                            importo: 0,
                                            ltClienti: 0,
                                            rmClienti: 0,
                                            ltSet: new Set(),
                                            rmSet: new Set()
                                        });
                                    }
                                    const cat = categorieDettagliate.get(key);
                                    cat.importo += fatturato;
                                    
                                    if (provincia === 'LT') {
                                        cat.ltSet.add(cliente);
                                    } else if (provincia === 'RM') {
                                        cat.rmSet.add(cliente);
                                    }
                                }
                            }
                        });
                        
                        // Convert sets to counts
                        categorieDettagliate.forEach(cat => {
                            cat.ltClienti = cat.ltSet.size;
                            cat.rmClienti = cat.rmSet.size;
                            delete cat.ltSet;
                            delete cat.rmSet;
                        });
                        
                        // Sort sales by amount descending
                        dettaglioVendite.sort((a, b) => b.fatturato - a.fatturato);
                    }

                    const categorieDettagliateArray = Array.from(categorieDettagliate.values())
                        .sort((a, b) => b.importo - a.importo);

                    console.log('Final parsed data:', { generale, latina, roma, categorie, agentInfo, dettaglioVendite, categorieDettagliate: categorieDettagliateArray });
                    return { 
                        generale, 
                        latina, 
                        roma, 
                        categorie, 
                        agentInfo, 
                        dettaglioVendite, 
                        categorieDettagliate: categorieDettagliateArray 
                    };
                    
                } catch (e) {
                    console.error('Parse error:', e);
                    return null;
                }
            }

            // Nuovo metodo per parsare numeri italiani
            parseItalianNumber(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                
                // Rimuovi spazi, virgolette e €
                let cleaned = String(input).replace(/\s+/g, '').replace(/€/g, '').replace(/"/g, '');
                
                // Se contiene sia punto che virgola, il punto è separatore delle migliaia
                if (cleaned.includes('.') && cleaned.includes(',')) {
                    cleaned = cleaned.replace(/\./g, '').replace(/,/g, '.');
                }
                // Se contiene solo virgola, è il separatore decimale
                else if (cleaned.includes(',') && !cleaned.includes('.')) {
                    cleaned = cleaned.replace(/,/g, '.');
                }
                // Se contiene solo punto e ci sono più di 3 cifre dopo, è separatore migliaia
                else if (cleaned.includes('.')) {
                    const parts = cleaned.split('.');
                    if (parts.length === 2 && parts[1].length > 2) {
                        cleaned = cleaned.replace(/\./g, '');
                    }
                }
                
                return Number(cleaned) || 0;
            }

            // Metodo per parsare percentuali
            parsePercentage(input) {
                if (typeof input === 'number') return input;
                if (!input) return 0;
                
                let cleaned = String(input).replace(/\s+/g, '').replace(/%/g, '').replace(/,/g, '.');
                return Number(cleaned) || 0;
            }

            formatEuroK(value) {
                if (!value) return '€0k';
                const k = Math.round(value / 1000);
                return `€${k}k`;
            }

            calculateGrowthPercentage(current, previous) {
                if (!previous) return '0.0';
                return (((current - previous) / previous) * 100).toFixed(1);
            }

            getDisplayData() {
                if (!this.csvData) return null;
                
                switch (this.selectedProvince) {
                    case 'all':
                        return {
                            fatturato: this.csvData.generale.annoCorrente,
                            fatturatoVs: this.csvData.generale.annoPrecedente,
                            clienti: this.csvData.generale.clienti,
                            obiettivo: this.csvData.latina.obiettivo,
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.latina.obiettivoClienti,
                            percentualeClienti: this.csvData.latina.percentualeClienti
                        };
                    case 'LT':
                        return {
                            fatturato: this.csvData.latina.annoCorrente,
                            fatturatoVs: this.csvData.latina.annoPrecedente,
                            clienti: this.csvData.latina.clientiCorrente,
                            obiettivo: this.csvData.latina.obiettivo,
                            percentualeObiettivo: this.csvData.latina.percentualeObiettivo,
                            obiettivoClienti: this.csvData.latina.obiettivoClienti,
                            percentualeClienti: this.csvData.latina.percentualeClienti
                        };
                    case 'RM':
                        return {
                            fatturato: this.csvData.roma.annoCorrente,
                            fatturatoVs: 0,
                            clienti: this.csvData.roma.clienti,
                            obiettivo: null,
                            percentualeObiettivo: null,
                            obiettivoClienti: null,
                            percentualeClienti: null
                        };
                    default:
                        return null;
                }
            }

            updateDashboard() {
                const data = this.getDisplayData();
                if (!data) return;

                // Update agent info if available
                if (this.csvData.agentInfo) {
                    document.getElementById('agent-code').textContent = this.csvData.agentInfo.codice;
                    document.getElementById('period-text').textContent = `${this.csvData.agentInfo.dataInizio} - ${this.csvData.agentInfo.dataFine}`;
                }

                // Calculate growth
                const growthPercent = this.calculateGrowthPercentage(data.fatturato, data.fatturatoVs);
                
                // Update Fatturato Card
                document.getElementById('fatturato-value').textContent = this.formatEuroK(data.fatturato);
                document.getElementById('fatturato-vs').textContent = this.formatEuroK(data.fatturatoVs);
                
                const growthBadge = document.getElementById('growth-badge');
                if (parseFloat(growthPercent) >= 0) {
                    growthBadge.textContent = `+${growthPercent}%`;
                    growthBadge.parentElement.className = 'card-badge';
                } else {
                    growthBadge.textContent = `${growthPercent}%`;
                    growthBadge.parentElement.className = 'card-badge warning';
                }
                
                if (data.obiettivo) {
                    document.getElementById('obiettivo-fatturato').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('fatturato-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('fatturato-percentage').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Animate progress bar
                    setTimeout(() => {
                        document.getElementById('progress-fatturato').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 100);
                }

                // Update Obiettivo Card
                if (data.obiettivo) {
                    document.getElementById('obiettivo-value').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-percentage').textContent = `${data.percentualeObiettivo}%`;
                    document.getElementById('obiettivo-remaining').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-target').textContent = this.formatEuroK(data.obiettivo);
                    document.getElementById('obiettivo-mancano').textContent = this.formatEuroK(Math.max(0, data.obiettivo - data.fatturato));
                    document.getElementById('obiettivo-perc-display').textContent = `${data.percentualeObiettivo}%`;
                    
                    // Update badge color
                    const badge = document.getElementById('obiettivo-badge');
                    if (data.percentualeObiettivo >= 80) {
                        badge.className = 'card-badge';
                    } else {
                        badge.className = 'card-badge warning';
                    }
                    
                    setTimeout(() => {
                        document.getElementById('progress-obiettivo').style.width = `${Math.min(100, data.percentualeObiettivo)}%`;
                    }, 200);
                } else {
                    document.getElementById('obiettivo-value').textContent = 'N/A';
                    document.getElementById('obiettivo-percentage').textContent = 'N/A';
                    document.getElementById('progress-obiettivo').style.width = '0%';
                }

                // Update Top Performance Card (always show best province)
                const topProvince = this.csvData.latina.annoCorrente > this.csvData.roma.annoCorrente ? 'LT' : 'RM';
                const topData = topProvince === 'LT' ? this.csvData.latina : this.csvData.roma;
                const topGrowth = topProvince === 'LT' ? 
                    this.calculateGrowthPercentage(this.csvData.latina.annoCorrente, this.csvData.latina.annoPrecedente) : '0.0';
                    
                document.getElementById('top-province').textContent = topProvince;
                document.getElementById('province-growth').textContent = `+${topGrowth}%`;
                document.getElementById('province-amount').textContent = this.formatEuroK(topData.annoCorrente);
                
                const growthAmount = topProvince === 'LT' ? 
                    (this.csvData.latina.annoCorrente - this.csvData.latina.annoPrecedente) : 0;
                document.getElementById('trend-growth').textContent = `+${this.formatEuroK(growthAmount)}`;

                // Update Clienti Card
                document.getElementById('clienti-count').textContent = data.clienti;
                
                if (data.obiettivoClienti && data.percentualeClienti) {
                    document.getElementById('clienti-obiettivo').textContent = data.obiettivoClienti;
                    document.getElementById('clienti-percentage').textContent = `${data.percentualeClienti}%`;
                    document.getElementById('clienti-target-value').textContent = data.obiettivoClienti;
                    document.getElementById('clienti-mancanti').textContent = `${Math.max(0, data.obiettivoClienti - data.clienti)} clienti`;
                    document.getElementById('clienti-perc-display').textContent = `${data.percentualeClienti}%`;
                    
                    setTimeout(() => {
                        document.getElementById('progress-clienti').style.width = `${Math.min(100, data.percentualeClienti)}%`;
                    }, 300);
                } else {
                    document.getElementById('clienti-obiettivo').textContent = 'N/A';
                    document.getElementById('clienti-percentage').textContent = 'N/A';
                    document.getElementById('progress-clienti').style.width = '0%';
                }

                // Update charts and data displays
                this.updateChartsAndDisplays();
            }

            updateChartsAndDisplays() {
                this.createClientiChart();
                this.createFatturatoChart();
                this.createMixProdottiChart();
                this.createProvinceDistributionChart();
                this.updateProvinceDisplays();
                this.updateMixProdottiData();
                this.updateRiepilogoClienti();
                this.updateDistribuzioneProvince();
                this.updateCategoryDetailsTable();
                this.updateTopSalesTable();
            }

            createProvinceDistributionChart() {
                const ctx = document.getElementById('provinceDistributionChart');
                if (!ctx) return;

                // Destroy existing chart
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const ltFatturato = this.csvData.latina.annoCorrente;
                const rmFatturato = this.csvData.roma.annoCorrente;
                const total = ltFatturato + rmFatturato;

                ctx.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Latina (LT)', 'Roma (RM)'],
                        datasets: [{
                            data: [ltFatturato, rmFatturato],
                            backgroundColor: ['#a855f7', '#22d3ee'],
                            borderColor: ['#7c3aed', '#0891b2'],
                            borderWidth: 3,
                            cutout: '60%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuroK(context.raw);
                                        const percentage = total > 0 ? 
                                            ((context.raw / total) * 100).toFixed(1) : '0';
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutBounce'
                        }
                    }
                });
            }

            updateDistribuzioneProvince() {
                const ltFatturato = this.csvData.latina.annoCorrente;
                const rmFatturato = this.csvData.roma.annoCorrente;
                const total = ltFatturato + rmFatturato;

                if (total > 0) {
                    const ltPercentage = ((ltFatturato / total) * 100).toFixed(1);
                    const rmPercentage = ((rmFatturato / total) * 100).toFixed(1);

                    document.getElementById('dist-lt-percentage').textContent = `${ltPercentage}%`;
                    document.getElementById('dist-rm-percentage').textContent = `${rmPercentage}%`;
                    document.getElementById('dist-lt-amount').textContent = this.formatEuro(ltFatturato);
                    document.getElementById('dist-rm-amount').textContent = this.formatEuro(rmFatturato);
                }
            }

            updateRiepilogoClienti() {
                // Update Latina data
                document.getElementById('riepilogo-lt-clienti-2025').textContent = this.csvData.latina.clientiCorrente;
                document.getElementById('riepilogo-lt-fatturato-k').textContent = this.formatEuroK(this.csvData.latina.annoCorrente);
                document.getElementById('riepilogo-lt-clienti-2024').textContent = this.csvData.latina.clientiPrecedenti;

                // Calculate average per client for Latina
                const ltMedio = this.csvData.latina.clientiCorrente > 0 ? 
                    this.csvData.latina.annoCorrente / this.csvData.latina.clientiCorrente : 0;
                document.getElementById('riepilogo-lt-medio').textContent = this.formatEuroK(ltMedio);

                // Calculate difference for Latina
                const ltDifference = this.csvData.latina.clientiCorrente - this.csvData.latina.clientiPrecedenti;
                const ltDifferenceEl = document.getElementById('riepilogo-lt-difference');
                const ltComparisonBox = document.getElementById('lt-comparison-box');
                const ltComparisonText = document.getElementById('lt-comparison-text');
                
                if (ltDifference >= 0) {
                    ltDifferenceEl.textContent = `+${ltDifference} ↑`;
                    ltDifferenceEl.style.background = '#a7f3d0';
                    ltDifferenceEl.style.color = '#059669';
                    ltComparisonBox.style.background = '#d1fae5';
                    ltComparisonBox.style.borderColor = '#a7f3d0';
                    ltComparisonText.style.color = '#059669';
                } else {
                    ltDifferenceEl.textContent = `${ltDifference} ↓`;
                    ltDifferenceEl.style.background = '#fecaca';
                    ltDifferenceEl.style.color = '#dc2626';
                    ltComparisonBox.style.background = '#fee2e2';
                    ltComparisonBox.style.borderColor = '#fecaca';
                    ltComparisonText.style.color = '#dc2626';
                }

                // Update Roma data
                document.getElementById('riepilogo-rm-clienti-2025').textContent = this.csvData.roma.clienti;
                document.getElementById('riepilogo-rm-fatturato-k').textContent = this.formatEuroK(this.csvData.roma.annoCorrente);
                document.getElementById('riepilogo-rm-clienti-2024').textContent = '0';

                // Calculate average per client for Roma
                const rmMedio = this.csvData.roma.clienti > 0 ? 
                    this.csvData.roma.annoCorrente / this.csvData.roma.clienti : 0;
                document.getElementById('riepilogo-rm-medio').textContent = this.formatEuroK(rmMedio);
            }

            createMixProdottiChart() {
                const ctx = document.getElementById('mixProdottiChart');
                if (!ctx) return;

                // Destroy existing chart
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const mixData = this.calculateMixProdotti();

                ctx.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mattone + Pavimentazione', 'Altri Prodotti'],
                        datasets: [{
                            data: [mixData.core.importo, mixData.others.importo],
                            backgroundColor: ['#3b82f6', '#6b7280'],
                            borderColor: ['#1e40af', '#4b5563'],
                            borderWidth: 3,
                            cutout: '50%'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = this.formatEuro(context.raw);
                                        const percentage = mixData.total > 0 ? 
                                            ((context.raw / mixData.total) * 100).toFixed(1) : '0';
                                        return `${context.label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutBounce'
                        }
                    }
                });
            }

            calculateMixProdotti() {
                if (!this.csvData.categorie || this.csvData.categorie.length === 0) {
                    return {
                        core: { importo: 45000, mattone: 30000, pavimentazione: 15000 },
                        others: { importo: 15000, refrattari: 10000, altri: 5000 },
                        total: 60000
                    };
                }

                const categorie = this.csvData.categorie;
                let mattone = 0, pavimentazione = 0, refrattari = 0, altri = 0;

                categorie.forEach(cat => {
                    switch (cat.nome) {
                        case 'Mattone':
                            mattone += cat.importo;
                            break;
                        case 'Pavimentazione':
                            pavimentazione += cat.importo;
                            break;
                        case 'Refrattari':
                            refrattari += cat.importo;
                            break;
                        default:
                            altri += cat.importo;
                            break;
                    }
                });

                const coreImporto = mattone + pavimentazione;
                const othersImporto = refrattari + altri;
                const total = coreImporto + othersImporto;

                return {
                    core: { importo: coreImporto, mattone, pavimentazione },
                    others: { importo: othersImporto, refrattari, altri },
                    total: total
                };
            }

            updateMixProdottiData() {
                const mixData = this.calculateMixProdotti();
                const total = mixData.total;

                if (total > 0) {
                    // Calculate percentages
                    const corePercentage = ((mixData.core.importo / total) * 100).toFixed(1);
                    const othersPercentage = ((mixData.others.importo / total) * 100).toFixed(1);

                    // Update percentages
                    document.getElementById('core-percentage').textContent = `${corePercentage}%`;
                    document.getElementById('other-percentage').textContent = `${othersPercentage}%`;

                    // Update amounts
                    document.getElementById('core-amount').textContent = this.formatEuro(mixData.core.importo);
                    document.getElementById('other-amount').textContent = this.formatEuro(mixData.others.importo);

                    // Update breakdown
                    document.getElementById('mattone-amount').textContent = this.formatEuroK(mixData.core.mattone);
                    document.getElementById('pavimentazione-amount').textContent = this.formatEuroK(mixData.core.pavimentazione);
                    document.getElementById('refrattari-amount').textContent = this.formatEuroK(mixData.others.refrattari);
                    document.getElementById('altri-amount').textContent = this.formatEuroK(mixData.others.altri);

                    // Update performance metrics
                    document.getElementById('core-perf').textContent = `${corePercentage}%`;
                    document.getElementById('categories-count').textContent = this.csvData.categorie.length;
                    
                    // Calculate involved clients (estimate based on categories)
                    const involvedClients = Math.min(this.csvData.generale.clienti, this.csvData.categorie.length * 3);
                    document.getElementById('involved-clients').textContent = involvedClients;
                }
            }

            formatEuro(value) {
                if (!value) return '0 €';
                if (value >= 1000) {
                    return `${(value / 1000).toFixed(3)} €`.replace('.', ',');
                }
                return `${Math.round(value)} €`;
            }

            createClientiChart() {
                const ctx = document.getElementById('clientiChart');
                if (!ctx) return;

                // Destroy existing chart
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const ltClienti = this.csvData.latina.clientiCorrente;
                const rmClienti = this.csvData.roma.clienti;
                const ltPrevClienti = this.csvData.latina.clientiPrecedenti;

                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            {
                                label: '2024',
                                data: [ltPrevClienti, 0],
                                backgroundColor: '#cbd5e1',
                                borderRadius: 8,
                                maxBarThickness: 60
                            },
                            {
                                label: '2025',
                                data: [ltClienti, rmClienti],
                                backgroundColor: ['#22d3ee', '#22d3ee'],
                                borderRadius: 8,
                                maxBarThickness: 60
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${context.raw} clienti`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: Math.max(ltClienti, rmClienti, ltPrevClienti) * 1.2,
                                ticks: {
                                    stepSize: Math.ceil(Math.max(ltClienti, rmClienti, ltPrevClienti) / 4),
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 1500,
                            easing: 'easeOutBounce'
                        }
                    }
                });
            }

            createFatturatoChart() {
                const ctx = document.getElementById('fatturatoChart');
                if (!ctx) return;

                // Destroy existing chart
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const ltFatturato = this.csvData.latina.annoCorrente;
                const rmFatturato = this.csvData.roma.annoCorrente;
                const ltPrevFatturato = this.csvData.latina.annoPrecedente;

                const maxValue = Math.max(ltFatturato, rmFatturato, ltPrevFatturato) * 1.2;

                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['LT', 'RM'],
                        datasets: [
                            {
                                label: '2024',
                                data: [ltPrevFatturato, 0],
                                backgroundColor: '#cbd5e1',
                                borderRadius: 8,
                                maxBarThickness: 80
                            },
                            {
                                label: '2025',
                                data: [ltFatturato, rmFatturato],
                                backgroundColor: ['#8b5cf6', '#6366f1'],
                                borderRadius: 8,
                                maxBarThickness: 80
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: ${this.formatEuroK(context.raw)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: maxValue,
                                ticks: {
                                    callback: (value) => {
                                        return this.formatEuroK(value);
                                    },
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            },
                            x: {
                                ticks: {
                                    color: '#6b7280',
                                    font: {
                                        size: 12,
                                        weight: '600'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 2000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
            }

            updateProvinceDisplays() {
                // Update Clienti displays
                document.getElementById('lt-clienti-count').textContent = `${this.csvData.latina.clientiCorrente} clienti`;
                document.getElementById('rm-clienti-count').textContent = `${this.csvData.roma.clienti} clienti`;

                // Calculate client growth for LT
                const ltClientGrowth = this.csvData.latina.clientiPrecedenti > 0 ? 
                    this.calculateGrowthPercentage(this.csvData.latina.clientiCorrente, this.csvData.latina.clientiPrecedenti) : '0.0';
                
                // Update growth badges for clients
                const ltGrowthEl = document.getElementById('lt-growth');
                if (parseFloat(ltClientGrowth) >= 0) {
                    ltGrowthEl.textContent = `+${ltClientGrowth}%`;
                    ltGrowthEl.style.background = '#f0fdf4';
                    ltGrowthEl.style.color = '#16a34a';
                } else {
                    ltGrowthEl.textContent = `${ltClientGrowth}%`;
                    ltGrowthEl.style.background = '#fef2f2';
                    ltGrowthEl.style.color = '#dc2626';
                }

                // RM is new, so always positive
                document.getElementById('rm-growth').textContent = '+∞%';

                // Update Fatturato displays
                document.getElementById('lt-fatturato-display').textContent = this.formatEuroK(this.csvData.latina.annoCorrente);
                document.getElementById('lt-fatturato-prev').textContent = this.formatEuroK(this.csvData.latina.annoPrecedente);
                document.getElementById('rm-fatturato-display').textContent = this.formatEuroK(this.csvData.roma.annoCorrente);

                // Update fatturato growth
                const ltFatturatoGrowth = this.calculateGrowthPercentage(this.csvData.latina.annoCorrente, this.csvData.latina.annoPrecedente);
                document.getElementById('lt-fatturato-growth').textContent = `+${ltFatturatoGrowth}%`;
            }

            updateTopSalesTable() {
                const tableBody = document.getElementById('top-sales-table');
                if (!tableBody) return;
                
                // Check if detailed sales data is available
                if (!this.csvData.dettaglioVendite || this.csvData.dettaglioVendite.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="padding: 2rem; text-align: center; color: #6b7280;">
                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <div>Dati vendite dettagliate non disponibili nel CSV</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Get top 10 sales
                const topSales = this.csvData.dettaglioVendite.slice(0, 10);
                
                tableBody.innerHTML = topSales.map(sale => {
                    const provinceColor = sale.provincia === 'LT' ? '#8b5cf6' : '#22d3ee';
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s ease;">
                            <td style="padding: 1rem;">
                                <span style="background: ${provinceColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 600;">
                                    ${sale.provincia}
                                </span>
                            </td>
                            <td style="padding: 1rem; font-weight: 500; color: #1f2937; font-size: 0.875rem;">
                                ${sale.cliente}
                            </td>
                            <td style="padding: 1rem; color: #6b7280; font-size: 0.875rem;">
                                ${sale.categoria}
                            </td>
                            <td style="padding: 1rem; text-align: right; font-weight: 700; color: #059669;">
                                ${this.formatEuro(sale.fatturato)}
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Add hover effects
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', () => {
                        row.style.backgroundColor = '#f8fafc';
                    });
                    row.addEventListener('mouseleave', () => {
                        row.style.backgroundColor = 'transparent';
                    });
                });
            }

            updateCategoryDetailsTable() {
                const tableBody = document.getElementById('category-details-table');
                if (!tableBody) return;
                
                // Check if detailed category data is available
                if (!this.csvData.categorieDettagliate || this.csvData.categorieDettagliate.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: #6b7280;">
                                <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <div>Dati categorie dettagliate non disponibili nel CSV</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const totalAmount = this.csvData.categorieDettagliate.reduce((sum, cat) => sum + cat.importo, 0);
                
                tableBody.innerHTML = this.csvData.categorieDettagliate.map((cat, index) => {
                    const percentage = totalAmount > 0 ? ((cat.importo / totalAmount) * 100).toFixed(1) : 0;
                    const rankColor = this.getCategoryRankColor(index);
                    
                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s ease;">
                            <td style="padding: 1rem;">
                                <div style="width: 28px; height: 28px; background: ${rankColor}; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.875rem;">
                                    ${index + 1}
                                </div>
                            </td>
                            <td style="padding: 1rem;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">
                                    ${cat.nome}
                                </div>
                                <div style="color: #6b7280; font-size: 0.75rem;">
                                    ${percentage}%
                                </div>
                            </td>
                            <td style="padding: 1rem; text-align: right; font-weight: 700; color: #1f2937;">
                                ${this.formatEuro(cat.importo)}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <span style="background: #f3e8ff; color: #8b5cf6; padding: 0.25rem 0.75rem; border-radius: 1rem; font-weight: 700; font-size: 0.875rem;">
                                    ${cat.ltClienti || 0}
                                </span>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <span style="background: #ecfeff; color: #22d3ee; padding: 0.25rem 0.75rem; border-radius: 1rem; font-weight: 700; font-size: 0.875rem;">
                                    ${cat.rmClienti || 0}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Add hover effects
                const rows = tableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', () => {
                        row.style.backgroundColor = '#f8fafc';
                    });
                    row.addEventListener('mouseleave', () => {
                        row.style.backgroundColor = 'transparent';
                    });
                });
            }

            getCategoryRankColor(index) {
                const colors = [
                    '#f59e0b', // Gold for #1
                    '#6b7280', // Silver for #2  
                    '#cd7f32', // Bronze for #3
                    '#3b82f6', // Blue for others
                    '#8b5cf6', 
                    '#22d3ee',
                    '#10b981',
                    '#f97316',
                    '#ec4899',
                    '#84cc16'
                ];
                return colors[index] || '#6b7280';
            }

            showLoading() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
            }

            showError(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('error-message').textContent = message;
            }

            showSuccess() {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new ExecutiveDashboard();
        });
    </script>
</body>
</html>
